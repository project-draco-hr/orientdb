{
  setCurrentDatabaseinThreadLocal();
  try {
    super.open(iUserName,iUserPassword);
    currentStorageVersions=new OCurrentStorageVersions(getStorage().getConfiguration());
    sbTreeCollectionManager=new OSBTreeCollectionManagerProxy(this,getStorage().getResource(OSBTreeCollectionManager.class.getSimpleName(),new Callable<OSBTreeCollectionManager>(){
      @Override public OSBTreeCollectionManager call() throws Exception {
        Class<? extends OSBTreeCollectionManager> managerClass=getStorage().getCollectionManagerClass();
        if (managerClass == null) {
          OLogManager.instance().warn(this,"Current implementation of storage does not support sbtree collections");
          return null;
        }
 else {
          return managerClass.newInstance();
        }
      }
    }
));
    level1Cache.startup();
    metadata=new OMetadataDefault();
    metadata.load();
    recordFormat=DEF_RECORD_FORMAT;
    if (!(getStorage() instanceof OStorageProxy)) {
      user=getMetadata().getSecurity().authenticate(iUserName,iUserPassword);
      if (user != null) {
        final Set<ORole> roles=user.getRoles();
        if (roles == null || roles.isEmpty() || roles.iterator().next() == null) {
          for (          ODatabaseListener l : underlying.browseListeners()) {
            if (l.onCorruptionRepairDatabase(this,"Security metadata is broken: current user '" + user.getName() + "' has no roles defined","The 'admin' user will be reinstalled with default role ('admin') and password 'admin'")) {
              user=null;
              user=metadata.getSecurity().repair();
              break;
            }
          }
        }
      }
      registerHook(new OClassTrigger(),ORecordHook.HOOK_POSITION.FIRST);
      registerHook(new ORestrictedAccessHook(),ORecordHook.HOOK_POSITION.FIRST);
      registerHook(new OUserTrigger(),ORecordHook.HOOK_POSITION.EARLY);
      registerHook(new OFunctionTrigger(),ORecordHook.HOOK_POSITION.REGULAR);
      registerHook(new OClassIndexManager(),ORecordHook.HOOK_POSITION.LAST);
      registerHook(new OSchedulerTrigger(),ORecordHook.HOOK_POSITION.LAST);
      registerHook(new ORidBagDeleteHook(),ORecordHook.HOOK_POSITION.LAST);
    }
 else     user=new OUser(iUserName,OUser.encryptPassword(iUserPassword)).addRole(new ORole("passthrough",null,ORole.ALLOW_MODES.ALLOW_ALL_BUT));
    checkSecurity(ODatabaseSecurityResources.DATABASE,ORole.PERMISSION_READ);
    if (!metadata.getSchema().existsClass(OMVRBTreeRIDProvider.PERSISTENT_CLASS_NAME))     metadata.getSchema().createClass(OMVRBTreeRIDProvider.PERSISTENT_CLASS_NAME);
    if (metadata.getIndexManager().autoRecreateIndexesAfterCrash())     metadata.getIndexManager().recreateIndexes();
  }
 catch (  OException e) {
    close();
    throw e;
  }
catch (  Exception e) {
    close();
    throw new ODatabaseException("Cannot open database",e);
  }
  return (DB)this;
}
