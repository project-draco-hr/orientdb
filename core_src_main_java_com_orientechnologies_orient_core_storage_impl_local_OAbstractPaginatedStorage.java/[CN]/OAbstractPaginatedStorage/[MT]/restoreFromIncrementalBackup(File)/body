{
  if (!backupDirectory.exists()) {
    throw new OStorageException("Directory which should contain incremental backup files (files with extension '" + IBU_EXTENSION + "') is absent. It should be located at '"+ backupDirectory.getAbsolutePath()+ "'");
  }
  try {
    final String[] files=fetchIBUFiles(backupDirectory);
    if (files.length == 0) {
      throw new OStorageException("Cannot find incremental backup files (files with extension '" + IBU_EXTENSION + "') in directory '"+ backupDirectory.getAbsolutePath()+ "'");
    }
    stateLock.acquireWriteLock();
    try {
      for (      String file : files) {
        final File ibuFile=new File(backupDirectory,file);
        final RandomAccessFile rndIBUFile=new RandomAccessFile(ibuFile,"rw");
        try {
          final FileChannel ibuChannel=rndIBUFile.getChannel();
          ibuChannel.position(3 * OLongSerializer.LONG_SIZE);
          final ByteBuffer buffer=ByteBuffer.allocate(1);
          ibuChannel.read(buffer);
          buffer.rewind();
          final boolean fullBackup=buffer.get() == 1;
          final InputStream inputStream=Channels.newInputStream(ibuChannel);
          restoreFromIncrementalBackup(inputStream,fullBackup);
        }
  finally {
          rndIBUFile.close();
        }
      }
    }
  finally {
      stateLock.releaseWriteLock();
    }
  }
 catch (  IOException e) {
    throw OException.wrapException(new OStorageException("Error during incremental backup"),e);
  }
}
