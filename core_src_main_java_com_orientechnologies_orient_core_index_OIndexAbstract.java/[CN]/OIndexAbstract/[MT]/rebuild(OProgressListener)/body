{
  long documentIndexed=0;
  final boolean intentInstalled=getDatabase().declareIntent(new OIntentMassiveInsert());
  acquireExclusiveLock();
  try {
    rebuildThread=Thread.currentThread();
    rebuilding=true;
    try {
      if (indexId >= 0)       storage.deleteIndexEngine(indexId);
    }
 catch (    Exception e) {
      OLogManager.instance().error(this,"Error during index '%s' delete",name);
    }
    removeValuesContainer();
    indexId=storage.addIndexEngine(name,algorithm,type,indexDefinition,determineValueSerializer(),isAutomatic(),isDurableInNonTxMode(),version,getEngineProperties(),clustersToIndex,metadata);
    onIndexEngineChange(indexId);
    documentIndexed=fillIndex(iProgressListener);
  }
 catch (  final Exception e) {
    try {
      if (indexId >= 0)       storage.clearIndex(indexId);
    }
 catch (    Exception e2) {
      OLogManager.instance().error(this,"Error during index rebuild",e2);
    }
    throw OException.wrapException(new OIndexException("Error on rebuilding the index for clusters: " + clustersToIndex),e);
  }
 finally {
    rebuilding=false;
    rebuildThread=null;
    if (intentInstalled)     getDatabase().declareIntent(null);
    releaseExclusiveLock();
  }
  return documentIndexed;
}
