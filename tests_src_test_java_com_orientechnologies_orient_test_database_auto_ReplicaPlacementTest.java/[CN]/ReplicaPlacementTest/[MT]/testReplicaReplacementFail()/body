{
  if (!OGlobalConfiguration.USE_LHPEPS_MEMORY_CLUSTER.getValueAsBoolean())   return;
  final ODatabaseDocumentTx dbOne=new ODatabaseDocumentTx(getDBUrl("replicaReplacementFail1"));
  dbOne.create();
  final OSchema schemaOne=dbOne.getMetadata().getSchema();
  final OClass classReplicaTestOne=schemaOne.createClass("ReplicaTest");
  classReplicaTestOne.createProperty("prop",OType.STRING);
  schemaOne.save();
  final ODatabaseDocumentTx dbTwo=new ODatabaseDocumentTx(getDBUrl("replicaReplacementFail2"));
  dbTwo.create();
  final OSchema schemaTwo=dbTwo.getMetadata().getSchema();
  final OClass classReplicaTestTwo=schemaTwo.createClass("ReplicaTest");
  classReplicaTestTwo.createProperty("prop",OType.STRING);
  schemaTwo.save();
  ODatabaseRecordThreadLocal.INSTANCE.set(dbOne);
  final ODocument docOne=new ODocument("ReplicaTest");
  docOne.field("prop","value");
  docOne.save();
  ODatabaseRecordThreadLocal.INSTANCE.set(dbTwo);
  dbTwo.updatedReplica(docOne);
  ODocument docTwo=dbTwo.load(docOne.getIdentity());
  Assert.assertNotNull(docTwo);
  Assert.assertTrue(ODocumentHelper.hasSameContentItem(docTwo,dbTwo,docOne,dbOne));
  ODatabaseRecordThreadLocal.INSTANCE.set(dbOne);
  docOne.field("prop","value2");
  docOne.save();
  ODatabaseRecordThreadLocal.INSTANCE.set(dbTwo);
  docTwo.field("prop","value3");
  docTwo.save();
  docTwo.field("prop","value4");
  docTwo.save();
  final ORecordVersion oldVersion=docTwo.getRecordVersion();
  Assert.assertFalse(dbTwo.updatedReplica(docOne));
  docTwo=dbTwo.load(docOne.getIdentity());
  Assert.assertEquals(0,docTwo.getRecordVersion().compareTo(oldVersion));
  Assert.assertEquals("value4",docTwo.field("prop"));
  Assert.assertFalse(ODocumentHelper.hasSameContentItem(docTwo,dbTwo,docOne,dbOne));
}
