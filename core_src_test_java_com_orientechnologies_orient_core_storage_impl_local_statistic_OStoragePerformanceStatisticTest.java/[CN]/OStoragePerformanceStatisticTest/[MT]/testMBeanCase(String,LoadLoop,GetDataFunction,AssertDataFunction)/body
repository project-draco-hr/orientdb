{
  final AtomicLong nanoIncrement=new AtomicLong();
  nanoIncrement.set(100);
  final OStoragePerformanceStatistic storagePerformanceStatistic=new OStoragePerformanceStatistic(1024,"test",1,new OStoragePerformanceStatistic.NanoTimer(){
    private long counter=0;
    @Override public long getNano(){
      return counter+=nanoIncrement.get();
    }
  }
,100000);
  storagePerformanceStatistic.registerMBean();
  final MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
  final ObjectName objectName=new ObjectName("com.orientechnologies.orient.core.storage.impl.local." + "statistic:type=OStoragePerformanceStatisticMXBean,name=test,id=1");
  Assert.assertTrue(mbs.isRegistered(objectName));
  storagePerformanceStatistic.registerMBean();
  final OStoragePerformanceStatisticMXBean mxBean=MBeanServerInvocationHandler.newProxyInstance(mbs,objectName,OStoragePerformanceStatisticMXBean.class,false);
  Assert.assertFalse(mxBean.isMeasurementEnabled());
  long[] speedData=getDataFunction.getData(mxBean);
  for (  long datum : speedData) {
    Assert.assertEquals(datum,-1);
  }
  mxBean.startMeasurement();
  final AtomicBoolean stop=new AtomicBoolean();
  final AtomicBoolean measurementStopped=new AtomicBoolean();
  final ExecutorService executor=Executors.newSingleThreadExecutor();
  final Future<Void> future=executor.submit(new Callable<Void>(){
    @Override public Void call() throws Exception {
      while (!stop.get()) {
        loadLoop.execute(storagePerformanceStatistic,measurementStopped.get());
      }
      return null;
    }
  }
);
  long notZeroSpeedCount=0;
  long msStart=System.currentTimeMillis();
  long counter=0;
  while (notZeroSpeedCount < 1000) {
    if (counter % 1000 == 0 && System.currentTimeMillis() - msStart > 120000)     break;
    speedData=getDataFunction.getData(mxBean);
    if (speedData[0] == -1) {
      Thread.yield();
    }
 else {
      notZeroSpeedCount++;
      assertDataFunction.assertData(speedData);
    }
    Thread.yield();
    counter++;
  }
  Assert.assertTrue(notZeroSpeedCount > 0);
  System.out.println(testName + "MBean : not zero speed count " + notZeroSpeedCount);
  mxBean.stopMeasurement();
  measurementStopped.set(true);
  speedData=getDataFunction.getData(mxBean);
  if (speedData[0] > 0) {
    System.out.println(testName + "MBean : check that values were not changed after stop measurement");
    nanoIncrement.set(10);
    Thread.sleep(200);
    assertDataFunction.assertData(getDataFunction.getData(mxBean));
    Assert.assertFalse(mxBean.isMeasurementEnabled());
  }
  stop.set(true);
  future.get();
  mxBean.startMeasurement();
  measurementStopped.set(false);
  Thread.sleep(200);
  Assert.assertTrue(mxBean.isMeasurementEnabled());
  speedData=getDataFunction.getData(mxBean);
  for (  long datum : speedData) {
    Assert.assertEquals(datum,-1);
  }
  executor.shutdown();
  storagePerformanceStatistic.unregisterMBean();
  Assert.assertFalse(mbs.isRegistered(objectName));
  storagePerformanceStatistic.unregisterMBean();
}
