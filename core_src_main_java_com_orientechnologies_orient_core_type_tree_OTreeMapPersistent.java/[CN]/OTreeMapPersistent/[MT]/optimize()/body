{
  final long timer=System.currentTimeMillis();
  lock.acquireExclusiveLock();
  try {
    if (root == null)     return;
    OLogManager.instance().debug(this,"Starting optimization of RB+Tree...");
    if (entryPoints.size() == 0)     entryPoints.add((OTreeMapEntryPersistent<K,V>)root);
    int nodes=0;
    for (    OTreeMapEntryPersistent<K,V> entryPoint : entryPoints)     for (OTreeMapEntryPersistent<K,V> e=entryPoint; e != null; e=e.getNextInMemory()) {
      ++nodes;
    }
    if (OLogManager.instance().isDebugEnabled())     OLogManager.instance().debug(this,"Found %d nodes in memory, %d items on disk, threshold=%d, entryPoints=%d",nodes,size,(entryPointSize * entryPointThresholdFactor),entryPoints.size());
    if (nodes < entryPointSize * entryPointThresholdFactor)     return;
    final int distance;
    if (nodes <= entryPointSize)     distance=1;
 else     distance=nodes / entryPointSize + 1;
    tmpEntryPoints.clear();
    OLogManager.instance().debug(this,"Compacting nodes with distance = %d",distance);
    int nodeCounter=0;
    OTreeMapEntryPersistent<K,V> lastNode=null;
    for (    OTreeMapEntryPersistent<K,V> entryPoint : entryPoints)     for (OTreeMapEntryPersistent<K,V> e=entryPoint; e != null; e=e.getNextInMemory()) {
      ++nodeCounter;
      if (tmpEntryPoints.size() == 0 || nodeCounter % distance == 0)       tmpEntryPoints.add(e);
      lastNode=e;
    }
    if (tmpEntryPoints.size() > 1 && tmpEntryPoints.get(tmpEntryPoints.size() - 1) != lastNode)     tmpEntryPoints.add(lastNode);
    final List<OTreeMapEntryPersistent<K,V>> a=entryPoints;
    entryPoints=tmpEntryPoints;
    tmpEntryPoints=a;
    tmpEntryPoints.clear();
    for (    OTreeMapEntryPersistent<K,V> entryPoint : entryPoints)     entryPoint.disconnect();
    if (OLogManager.instance().isDebugEnabled()) {
      nodes=0;
      for (      OTreeMapEntryPersistent<K,V> entryPoint : entryPoints)       for (OTreeMapEntryPersistent<K,V> e=entryPoint; e != null; e=e.getNextInMemory())       ++nodes;
      OLogManager.instance().debug(this,"Now Found %d nodes in memory and threshold=%d. EntryPoints=%d",nodes,(entryPointSize * entryPointThresholdFactor),entryPoints.size());
    }
  }
  finally {
    lock.releaseExclusiveLock();
    OProfiler.getInstance().stopChrono("OTreeMapPersistent.optimize",timer);
    if (OLogManager.instance().isDebugEnabled())     OLogManager.instance().debug(this,"Optimization completed in %d ms\n",System.currentTimeMillis() - timer);
  }
}
