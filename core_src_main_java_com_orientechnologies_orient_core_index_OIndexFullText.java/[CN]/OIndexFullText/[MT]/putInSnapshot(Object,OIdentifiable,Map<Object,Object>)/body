{
  if (key == null)   return;
  key=getCollatingValue(key);
  final Set<String> words=splitIntoWords(key.toString());
  for (  final String word : words) {
    Set<OIdentifiable> refs;
    final Object snapshotValue=snapshot.get(word);
    if (snapshotValue == null)     refs=indexEngine.get(word);
 else     if (snapshotValue.equals(RemovedValue.INSTANCE))     refs=null;
 else     refs=(Set<OIdentifiable>)snapshotValue;
    if (refs == null) {
      if (ODefaultIndexFactory.SBTREEBONSAI_VALUE_CONTAINER.equals(valueContainerAlgorithm)) {
        refs=new OIndexRIDContainer(getName());
      }
 else {
        refs=new OMVRBTreeRIDSet();
        ((OMVRBTreeRIDSet)refs).setAutoConvertToRecord(false);
      }
      snapshot.put(word,refs);
    }
    refs.add(value.getIdentity());
  }
}
