{
synchronized (syncObject) {
    final byte[] serializedForm=OWALRecordsFactory.INSTANCE.toStream(record);
    final int entrySize=calculateEntrySize(serializedForm);
    if (logSize + entrySize > maxLogSize) {
      LogSegment first=logSegments.get(0);
      logSize-=first.size();
      if (!first.delete())       OLogManager.instance().error(this,"Log segment %s can not be removed from WAL",first.getPath());
      logSegments.remove(0);
      fixMasterRecords();
    }
    LogSegment last=logSegments.get(logSegments.size() - 1);
    if (last.size() + entrySize > maxSegmentSize) {
      last.flush();
      last=new LogSegment(new File(walLocation,getSegmentName(last.getOrder() + 1)),maxRecordsCacheSize);
      logSegments.add(last);
    }
    final OLogSequenceNumber lsn=last.logRecord(serializedForm,record.isUpdateMasterRecord());
    record.setLsn(lsn);
    if (record.isUpdateMasterRecord())     lastCheckpoint=lsn;
    logSize+=entrySize;
    return lsn;
  }
}
