{
  parserText=request.getText();
  ODatabaseRecord db=ODatabaseRecordThreadLocal.INSTANCE.getIfDefined();
  if (db != null && !(db instanceof ODatabaseRecordTx))   db=db.getUnderlying();
  final OFunction f=db.getMetadata().getFunctionLibrary().getFunction(parserText);
  final OScriptManager scriptManager=Orient.instance().getScriptManager();
  final ScriptEngine scriptEngine=scriptManager.getEngine(f.getLanguage());
  final Bindings binding=scriptManager.bind(scriptEngine.getBindings(ScriptContext.ENGINE_SCOPE),(ODatabaseRecordTx)db,iContext,iArgs);
  try {
    final String lib=scriptManager.getLibrary(db,f.getLanguage());
    if (lib != null)     try {
      scriptEngine.eval(lib);
    }
 catch (    ScriptException e) {
      throw new OCommandScriptException("Error on evaluation of the script library. Error: " + e.getMessage() + "\nScript library was:\n"+ lib);
    }
    if (scriptEngine instanceof Invocable) {
      final Invocable invocableEngine=(Invocable)scriptEngine;
      Object[] args=null;
      if (iArgs != null) {
        args=new Object[iArgs.size()];
        int i=0;
        for (        Entry<Object,Object> arg : iArgs.entrySet())         args[i++]=arg.getValue();
      }
      return invocableEngine.invokeFunction(parserText,args);
    }
 else {
      final Object[] args=iArgs == null ? null : iArgs.values().toArray();
      return scriptEngine.eval(scriptManager.getFunctionInvoke(f,args),binding);
    }
  }
 catch (  ScriptException e) {
    throw new OCommandScriptException("Error on execution of the script",request.getText(),e.getColumnNumber(),e);
  }
catch (  NoSuchMethodException e) {
    throw new OCommandScriptException("Error on execution of the script",request.getText(),0,e);
  }
catch (  OCommandScriptException e) {
    throw e;
  }
 finally {
    scriptManager.unbind(binding);
  }
}
