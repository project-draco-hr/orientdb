{
  ODatabaseRecord localDatabase=ODatabaseRecordThreadLocal.INSTANCE.getIfDefined();
  if (localDatabase == null) {
    final List<String> parts=OStringSerializerHelper.split(iRequest.authorization,':');
    localDatabase=(ODatabaseDocumentTx)server.openDatabase("document",iRequest.databaseName,parts.get(0),parts.get(1));
  }
 else {
    String currentUserId=iRequest.data.currentUserId;
    if (currentUserId != null && currentUserId.length() > 0 && localDatabase != null && localDatabase.getUser() != null) {
      if (!currentUserId.equals(localDatabase.getUser().getDocument().getIdentity().toString())) {
        ODocument userDoc=localDatabase.load(new ORecordId(currentUserId));
        localDatabase.setUser(new OUser(userDoc));
      }
    }
  }
  iRequest.data.lastDatabase=localDatabase.getName();
  iRequest.data.lastUser=localDatabase.getUser() != null ? localDatabase.getUser().getName() : null;
  return (ODatabaseDocumentTx)localDatabase.getDatabaseOwner();
}
