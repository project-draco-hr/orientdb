{
  OChannelBinaryClient network=null;
  if (debug)   System.out.println("-> req: " + getSessionId());
synchronized (networkPool) {
    final int beginCursor=networkPoolCursor;
    while (network == null) {
      if (networkPool.size() == 0)       openRemoteDatabase();
      if (networkPool.size() == 0)       throw new ONetworkProtocolException("Connection pool closed");
      if (networkPoolCursor >= networkPool.size())       networkPoolCursor=0;
      network=networkPool.get(networkPoolCursor);
      networkPoolCursor++;
      if (network.getLockWrite().tryLock())       break;
      network=null;
      if (networkPoolCursor == beginCursor) {
        if (networkPool.size() < maxPool) {
          network=createNetworkConnection();
          network.getLockWrite().lock();
          networkPool.add(network);
          if (debug)           System.out.println("Created new connection " + networkPool.size());
        }
 else {
          if (debug)           System.out.println("-> req (waiting) : " + getSessionId());
          final long startToWait=System.currentTimeMillis();
          try {
            networkPool.wait(5000);
          }
 catch (          InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new OStorageException("Cannot acquire a connection because the thread has been interrupted");
          }
          final long elapsed=Orient.instance().getProfiler().stopChrono("system.network.connectionPool.waitingTime",startToWait);
          if (debug)           System.out.println("Waiting for connection = elapsed: " + elapsed);
        }
      }
    }
  }
  network.writeByte(iCommand);
  network.writeInt(getSessionId());
  return network;
}
