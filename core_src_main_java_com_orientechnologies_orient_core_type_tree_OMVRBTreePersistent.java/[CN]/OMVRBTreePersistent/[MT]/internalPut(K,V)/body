{
  ORecord<?> rec;
  if (key instanceof ORecord<?>) {
    rec=(ORecord<?>)key;
    if (!rec.getIdentity().isValid())     rec.save();
  }
  if (value instanceof ORecord<?>) {
    rec=(ORecord<?>)value;
    if (!rec.getIdentity().isValid())     rec.save();
  }
  final V previous=super.put(key,value);
  if (optimizeThreshold > -1 && insertionCounter > optimizeThreshold) {
    insertionCounter=0;
    optimize(false);
  }
 else   ++insertionCounter;
  return previous;
}
