{
  ORecordInternal<?> record;
  if (iLockEntireCluster)   cluster.lock();
  try {
    final ODatabaseRecord db=ODatabaseRecordThreadLocal.INSTANCE.get();
    ORecordIteratorCluster<ORecordInternal<?>> iterator=new ORecordIteratorCluster<ORecordInternal<?>>(db,(ODatabaseRecordAbstract)db,cluster.getId(),iBeginRange,iEndRange);
    while (iterator.hasNext()) {
      record=iterator.next();
      if (record != null && record.getRecordType() != ODocument.RECORD_TYPE)       continue;
      ORecordInternal<?> recordToCheck=null;
      try {
        recordToCheck=record;
        if (!iListener.foreach(recordToCheck))         break;
      }
 catch (      OCommandExecutionException e) {
        throw e;
      }
catch (      Exception e) {
        OLogManager.instance().exception("Error on loading record %s. Cause: %s",e,OStorageException.class,recordToCheck != null ? recordToCheck.getIdentity() : null,e);
      }
    }
  }
  finally {
    if (iLockEntireCluster)     cluster.unlock();
  }
  return ioRecord;
}
