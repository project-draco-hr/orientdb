{
  final long timer=OProfiler.getInstance().startChrono();
  lock.acquireExclusiveLock();
  try {
    ORecord<?> record;
    if (key instanceof ORecord<?>) {
      record=(ORecord<?>)key;
      if (!record.getIdentity().isValid())       record.save();
    }
    if (value instanceof ORecord<?>) {
      record=(ORecord<?>)value;
      if (!record.getIdentity().isValid())       record.save();
    }
    final V v=super.put(key,value);
    commitChanges();
    return v;
  }
  finally {
    lock.releaseExclusiveLock();
    OProfiler.getInstance().stopChrono("OTreeMapPersistent.put",timer);
  }
}
