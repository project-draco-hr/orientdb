{
  listener.onMessage("\nExporting schema...");
  writer.beginObject(1,true,"schema");
  OSchema s=database.getMetadata().getSchema();
  writer.writeAttribute(2,true,"version",s.getVersion());
  if (s.getClasses().size() > 0) {
    writer.beginCollection(2,true,"classes");
    for (    OClass cls : s.getClasses()) {
      writer.beginObject(3,true,"class");
      writer.writeAttribute(0,false,"name",cls.getName());
      writer.writeAttribute(0,false,"id",cls.getId());
      writer.writeAttribute(0,false,"default-cluster-id",cls.getDefaultClusterId());
      writer.writeAttribute(0,false,"cluster-ids",cls.getClusterIds());
      if (cls.properties().size() > 0) {
        writer.beginCollection(4,true,"properties");
        for (        OProperty p : cls.properties()) {
          writer.beginObject(5,true,"property");
          writer.writeAttribute(0,false,"name",p.getName());
          writer.writeAttribute(0,false,"id",p.getId());
          writer.writeAttribute(0,false,"type",p.getType());
          if (p.getLinkedClass() != null)           writer.writeAttribute(0,false,"linked-class",p.getLinkedClass().getName());
          if (p.getLinkedType() != null)           writer.writeAttribute(0,false,"linked-type",p.getLinkedType());
          if (p.getMin() != null)           writer.writeAttribute(0,false,"min",p.getMin());
          if (p.getMax() != null)           writer.writeAttribute(0,false,"max",p.getMax());
        }
        writer.endCollection(4,true);
      }
      writer.endObject(3,true);
    }
    writer.endCollection(2,true);
  }
  writer.endObject(1,true);
  listener.onMessage("OK");
}
