{
  setDataCommandInfo("Load record");
  if (!isConnectionAlive())   return;
  final ORecordId rid=channel.readRID();
  final String fetchPlanString=channel.readString();
  boolean ignoreCache=false;
  ignoreCache=channel.readByte() == 1;
  boolean loadTombstones=false;
  loadTombstones=channel.readByte() > 0;
  if (rid.clusterId == 0 && rid.clusterPosition == 0) {
    OFetchHelper.checkFetchPlanValid(fetchPlanString);
    beginResponse();
    try {
      sendOk(clientTxId);
      channel.writeByte((byte)1);
      if (connection.data.protocolVersion <= OChannelBinaryProtocol.PROTOCOL_VERSION_27) {
        channel.writeBytes(connection.database.getStorage().getConfiguration().toStream(connection.data.protocolVersion));
        channel.writeVersion(OVersionFactory.instance().createVersion());
        channel.writeByte(ORecordBytes.RECORD_TYPE);
      }
 else {
        channel.writeByte(ORecordBytes.RECORD_TYPE);
        channel.writeVersion(OVersionFactory.instance().createVersion());
        channel.writeBytes(connection.database.getStorage().getConfiguration().toStream(connection.data.protocolVersion));
      }
      channel.writeByte((byte)0);
    }
  finally {
      endResponse();
    }
  }
 else {
    final ORecord record=connection.database.load(rid,fetchPlanString,ignoreCache,loadTombstones,OStorage.LOCKING_STRATEGY.NONE);
    beginResponse();
    try {
      sendOk(clientTxId);
      if (record != null) {
        channel.writeByte((byte)1);
        byte[] bytes=getRecordBytes(record);
        int length=trimCsvSerializedContent(bytes);
        if (connection.data.protocolVersion <= OChannelBinaryProtocol.PROTOCOL_VERSION_27) {
          channel.writeBytes(bytes,length);
          channel.writeVersion(record.getRecordVersion());
          channel.writeByte(ORecordInternal.getRecordType(record));
        }
 else {
          channel.writeByte(ORecordInternal.getRecordType(record));
          channel.writeVersion(record.getRecordVersion());
          channel.writeBytes(bytes,length);
        }
        if (fetchPlanString.length() > 0) {
          if (record instanceof ODocument) {
            final OFetchPlan fetchPlan=OFetchHelper.buildFetchPlan(fetchPlanString);
            final Set<ORecord> recordsToSend=new HashSet<ORecord>();
            final ODocument doc=(ODocument)record;
            final OFetchListener listener=new ORemoteFetchListener(){
              @Override protected void sendRecord(              ORecord iLinked){
                recordsToSend.add(iLinked);
              }
            }
;
            final OFetchContext context=new ORemoteFetchContext();
            OFetchHelper.fetch(doc,doc,fetchPlan,listener,context,"");
            for (            ORecord d : recordsToSend) {
              if (d.getIdentity().isValid()) {
                channel.writeByte((byte)2);
                writeIdentifiable(d);
              }
            }
          }
        }
      }
      channel.writeByte((byte)0);
    }
  finally {
      endResponse();
    }
  }
}
