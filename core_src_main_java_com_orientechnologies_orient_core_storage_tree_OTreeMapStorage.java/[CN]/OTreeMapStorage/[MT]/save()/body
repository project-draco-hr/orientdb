{
  lock.acquireExclusiveLock();
  try {
    record.fromStream(toStream());
    if (record.getIdentity().isValid())     record.setVersion(storage.updateRecord(0,record.getIdentity().getClusterId(),record.getIdentity().getClusterPosition(),record.toStream(),-1,record.getRecordType()));
 else {
      int cluster=record.getIdentity().getClusterId() == ORID.CLUSTER_ID_INVALID ? clusterId : record.getIdentity().getClusterId();
      record.setIdentity(cluster,storage.createRecord(cluster,record.toStream(),record.getRecordType()));
    }
    record.unsetDirty();
    return this;
  }
  finally {
    lock.releaseExclusiveLock();
  }
}
