{
  filesLock.acquireWriteLock();
  try {
    initNameIdMapping();
    Integer fileId=nameIdMap.get(fileName);
    OFileClassic fileClassic;
    if (fileId != null && fileId >= 0)     throw new OStorageException("File with name " + fileName + " already exists in storage "+ storageLocal.getName());
    if (fileId == null) {
      ++fileCounter;
      fileId=fileCounter;
    }
 else     fileId=-fileId;
    fileClassic=createFile(fileName);
    files.put(fileId,fileClassic);
    nameIdMap.put(fileName,fileId);
    writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    addFile(fileClassic);
    return composeFileId(id,fileId);
  }
  finally {
    filesLock.releaseWriteLock();
  }
}
