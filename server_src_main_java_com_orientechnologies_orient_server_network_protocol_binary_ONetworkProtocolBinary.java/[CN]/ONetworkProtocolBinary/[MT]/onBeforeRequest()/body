{
  waitNodeIsOnline();
  if (Boolean.FALSE.equals(tokenBased)) {
    solveSimpleSession();
  }
 else {
    solveTokenSession();
  }
  if (connection != null) {
    connection.acquire();
    if (connection.database != null) {
      connection.database.activateOnCurrentThread();
      connection.data.lastDatabase=connection.database.getName();
      connection.data.lastUser=connection.database.getUser() != null ? connection.database.getUser().getName() : null;
    }
 else {
      connection.data.lastDatabase=null;
      connection.data.lastUser=null;
    }
    ++connection.data.totalRequests;
    setDataCommandInfo("Listening");
    connection.data.commandDetail="-";
    connection.data.lastCommandReceived=System.currentTimeMillis();
  }
 else {
    ODatabaseRecordThreadLocal.INSTANCE.remove();
    if (requestType != OChannelBinaryProtocol.REQUEST_DB_CLOSE && requestType != OChannelBinaryProtocol.REQUEST_SHUTDOWN) {
      OLogManager.instance().debug(this,"Found unknown session %d, shutdown current connection",clientTxId);
      shutdown();
      throw new OIOException("Found unknown session " + clientTxId);
    }
  }
  OServerPluginHelper.invokeHandlerCallbackOnBeforeClientRequest(server,connection,(byte)requestType);
}
