{
  if (!(iRecord instanceof ODocument))   return (RET)super.save(iRecord,iMode,iForceCreate,iRecordCreatedCallback,iRecordUpdatedCallback);
  ODocument doc=(ODocument)iRecord;
  doc.validate();
  doc.convertAllMultiValuesToTrackedVersions();
  try {
    if (iForceCreate || doc.getIdentity().isNew()) {
      if (doc.getClassName() != null)       checkSecurity(ODatabaseSecurityResources.CLASS,ORole.PERMISSION_CREATE,doc.getClassName());
      final OClass schemaClass=doc.getSchemaClass();
      if (schemaClass != null && doc.getIdentity().getClusterId() < 0) {
        final String clusterName=getClusterNameById(doc.getSchemaClass().getClusterForNewInstance());
        return (RET)super.save(doc,clusterName,iMode,iForceCreate,iRecordCreatedCallback,iRecordUpdatedCallback);
      }
    }
 else {
      if (doc.getClassName() != null)       checkSecurity(ODatabaseSecurityResources.CLASS,ORole.PERMISSION_UPDATE,doc.getClassName());
    }
    doc=super.save(doc,iMode,iForceCreate,iRecordCreatedCallback,iRecordUpdatedCallback);
  }
 catch (  OException e) {
    throw e;
  }
catch (  Exception e) {
    OLogManager.instance().exception("Error on saving record %s of class '%s'",e,ODatabaseException.class,iRecord.getIdentity(),(doc.getClassName() != null ? doc.getClassName() : "?"));
  }
  return (RET)doc;
}
