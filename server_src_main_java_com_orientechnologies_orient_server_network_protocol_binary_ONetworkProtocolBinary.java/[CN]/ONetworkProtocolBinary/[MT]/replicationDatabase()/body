{
  setDataCommandInfo("Replication command");
  final ODocument request=new ODocument(channel.readBytes());
  final ODistributedServerManager manager=OServerMain.server().getHandler(ODistributedServerManager.class);
  ODocument response=null;
  final String operation=request.field("operation");
  if (operation.equals("start")) {
    checkServerAccess("server.replication.start");
    final ODistributedNode node=manager.getReplicator().getOrCreateDistributedNode((String)request.field("node"));
    final ODistributedDatabaseInfo db=node.getOrCreateDatabaseEntry((String)request.field("db"));
    node.startDatabaseReplication(db);
  }
 else   if (operation.equals("stop")) {
    checkServerAccess("server.replication.stop");
    final ODistributedNode node=manager.getReplicator().getOrCreateDistributedNode((String)request.field("node"));
    final ODistributedDatabaseInfo db=node.getOrCreateDatabaseEntry((String)request.field("db"));
    node.stopDatabaseReplication(db);
  }
 else   if (operation.equals("align")) {
    checkServerAccess("server.replication.align");
    final ODistributedNode node=manager.getReplicator().getOrCreateDistributedNode((String)request.field("node"));
    final ODistributedDatabaseInfo db=node.getOrCreateDatabaseEntry((String)request.field("db"));
    node.startDatabaseAlignment(node.getOrCreateDatabaseEntry(db.databaseName),(String)request.field("options"));
  }
 else   if (operation.equals("getJournal")) {
    checkServerAccess("server.replication.getJournal");
    final ORecordOperation op=new ORecordOperation();
    final OOperationLog log=manager.getReplicator().getOperationLog((String)request.field("node"),(String)request.field("db"));
    if (log != null) {
      response=new ODocument();
      final int tot=log.totalEntries();
      for (int i=0; i < tot; ++i) {
        log.getEntry(i,op);
        final String value=String.valueOf(op.type) + '-' + op.record.getIdentity()+ '-'+ op.date;
        response.field(String.valueOf(op.serial),value);
      }
    }
  }
 else   if (operation.equals("resetJournal")) {
    checkServerAccess("server.replication.resetJournal");
    response=new ODocument();
    final OOperationLog log=manager.getReplicator().getOperationLog((String)request.field("node"),(String)request.field("db"));
    response.field("removedEntries",log.totalEntries());
    log.reset();
  }
 else   if (operation.equals("getConflicts")) {
    checkServerAccess("server.replication.getConflicts");
    final ODatabaseDocumentTx db=(ODatabaseDocumentTx)OServerMain.server().openDatabase(ODatabaseDocument.TYPE,(String)request.field("dbUrl"),manager.getReplicator().getReplicatorUser().name,manager.getReplicator().getReplicatorUser().password);
    response=manager.getReplicator().getConflictResolver().getAllConflicts(db);
  }
  sendResponse(response);
}
