{
  this.maxRecordsCacheSize=maxRecordsCacheSize;
  this.commitDelay=commitDelay;
  this.maxSegmentSize=maxSegmentSize;
  this.maxLogSize=maxLogSize;
  this.storageName=storageName;
  try {
    this.walLocation=new File(walPath);
    File[] walFiles=this.walLocation.listFiles(new FilenameFilter(){
      @Override public boolean accept(      File dir,      String name){
        return validateName(name);
      }
    }
);
    if (walFiles.length == 0) {
      logSegments.add(new LogSegment(new File(this.walLocation,getSegmentName(0)),maxRecordsCacheSize));
      logSize=0;
    }
 else {
      for (      File walFile : walFiles) {
        LogSegment logSegment=new LogSegment(walFile,maxRecordsCacheSize);
        logSegments.add(logSegment);
        logSize+=logSegment.size();
      }
      Collections.sort(logSegments);
    }
    masterRecordFile=new File(walLocation,storageName + ".wmr");
    masterRecordLSNHolder=new RandomAccessFile(masterRecordFile,"rwd");
    if (masterRecordLSNHolder.length() > 0) {
      firstMasterRecord=readMasterRecord(storageName,0);
      secondMasterRecord=readMasterRecord(storageName,1);
      if (firstMasterRecord == null) {
        useFirstMasterRecord=true;
        lastCheckpoint=secondMasterRecord;
      }
 else       if (secondMasterRecord == null) {
        useFirstMasterRecord=false;
        lastCheckpoint=firstMasterRecord;
      }
 else {
        if (firstMasterRecord.compareTo(secondMasterRecord) >= 0) {
          lastCheckpoint=firstMasterRecord;
          useFirstMasterRecord=false;
        }
 else {
          lastCheckpoint=secondMasterRecord;
          useFirstMasterRecord=true;
        }
      }
    }
    if (commitDelay > 0)     commitExecutor.scheduleWithFixedDelay(new Runnable(){
      @Override public void run(){
        try {
          flush();
        }
 catch (        IOException e) {
          OLogManager.instance().error(this,"Error during WAL background flush",e);
        }
      }
    }
,commitDelay,commitDelay,TimeUnit.MILLISECONDS);
  }
 catch (  FileNotFoundException e) {
    OLogManager.instance().error(this,"Error during file initialization for storage %s",e,storageName);
    throw new IllegalStateException("Error during file initialization for storage " + storageName,e);
  }
}
