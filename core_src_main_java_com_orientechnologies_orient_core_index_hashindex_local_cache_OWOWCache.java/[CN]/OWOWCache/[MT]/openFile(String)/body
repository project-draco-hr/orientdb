{
synchronized (syncObject) {
    if (nameIdMapHolder == null) {
      final File storagePath=new File(storageLocal.getStoragePath());
      if (!storagePath.exists())       if (!storagePath.mkdirs())       throw new OStorageException("Can not create directories for the path " + storagePath);
      nameIdMapHolderFile=new File(storagePath,NAME_ID_MAP);
      nameIdMapHolder=new RandomAccessFile(nameIdMapHolderFile,"rw");
      readNameIdMap();
    }
    Long fileId=nameIdMap.get(fileName);
    if (fileId == null) {
      fileId=++fileCounter;
      writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    }
    OFileClassic fileClassic=new OFileClassic();
    String path=storageLocal.getVariableParser().resolveVariables(storageLocal.getStoragePath() + File.separator + fileName);
    fileClassic.init(path,storageLocal.getMode());
    if (fileClassic.exists())     fileClassic.open();
 else     fileClassic.create(-1);
    files.put(fileId,fileClassic);
    return fileId;
  }
}
