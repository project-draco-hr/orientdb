{
  checkConnection();
  if (!(iCommand instanceof OSerializableStream))   throw new OCommandExecutionException("Cannot serialize the command to be executed to the server side.");
  OSerializableStream command=iCommand;
  Object result=null;
  final ODatabaseRecord database=ODatabaseRecordThreadLocal.INSTANCE.get();
  do {
    OStorageRemoteThreadLocal.INSTANCE.get().commandExecuting=true;
    try {
      final OCommandRequestText aquery=iCommand;
      final boolean asynch=iCommand instanceof OCommandRequestAsynch && ((OCommandRequestAsynch)iCommand).isAsynchronous();
      OChannelBinaryClient network=null;
      try {
        network=beginRequest(OChannelBinaryProtocol.REQUEST_COMMAND);
        network.writeByte((byte)(asynch ? 'a' : 's'));
        network.writeBytes(OStreamSerializerAnyStreamable.INSTANCE.toStream(command));
      }
  finally {
        endRequest(network);
      }
      try {
        beginResponse(network);
        if (asynch) {
          byte status;
          while ((status=network.readByte()) > 0) {
            final ORecordInternal<?> record=(ORecordInternal<?>)OChannelBinaryProtocol.readIdentifiable(network);
            if (record == null)             continue;
switch (status) {
case 1:
              try {
                if (!aquery.getResultListener().result(record)) {
                  while (network.in.available() > 0)                   network.in.read();
                  break;
                }
              }
 catch (              Throwable t) {
                t.printStackTrace();
              }
            database.getLevel1Cache().updateRecord(record);
          break;
case 2:
        database.getLevel1Cache().updateRecord(record);
    }
  }
}
 else {
  final byte type=network.readByte();
switch (type) {
case 'n':
    result=null;
  break;
case 'r':
result=OChannelBinaryProtocol.readIdentifiable(network);
if (result instanceof ORecord<?>) database.getLevel1Cache().updateRecord((ORecordInternal<?>)result);
break;
case 'l':
final int tot=network.readInt();
final Collection<OIdentifiable> list=new ArrayList<OIdentifiable>(tot);
for (int i=0; i < tot; ++i) {
final OIdentifiable resultItem=OChannelBinaryProtocol.readIdentifiable(network);
if (resultItem instanceof ORecord<?>) database.getLevel1Cache().updateRecord((ORecordInternal<?>)resultItem);
list.add(resultItem);
}
result=list;
break;
case 'a':
final String value=new String(network.readBytes());
result=ORecordSerializerStringAbstract.fieldTypeFromStream(null,ORecordSerializerStringAbstract.getType(value),value);
break;
default :
OLogManager.instance().warn(this,"Received unexpected result from query: %d",type);
}
}
break;
}
  finally {
endResponse(network);
}
}
 catch (OModificationOperationProhibitedException mope) {
handleDBFreeze();
}
catch (Exception e) {
handleException("Error on executing command: " + iCommand,e);
}
 finally {
OStorageRemoteThreadLocal.INSTANCE.get().commandExecuting=false;
}
}
 while (true);
return result;
}
