{
  final long timer=OProfiler.getInstance().startChrono();
  lock.acquireExclusiveLock();
  try {
    if (!checkForClose(iForce))     return;
    saveVersion();
    for (    OCluster cluster : clusters)     if (cluster != null)     cluster.close();
    clusters=new OCluster[0];
    clusterMap.clear();
    for (    ODataLocal data : dataSegments)     data.close();
    dataSegments=new ODataLocal[0];
    txManager.close();
    configuration.close();
    level2Cache.shutdown();
    OMMapManager.flush();
    Orient.instance().unregisterStorage(this);
    open=false;
  }
 catch (  IOException e) {
    OLogManager.instance().error(this,"Error on closing of the storage '" + name,e,OStorageException.class);
  }
 finally {
    lock.releaseExclusiveLock();
    OProfiler.getInstance().stopChrono("storage." + name + ".close",timer);
  }
}
