{
  if (o == null)   channel.writeShort(OChannelBinaryProtocol.RECORD_NULL);
 else   if (o instanceof ORecordId) {
    channel.writeShort(OChannelBinaryProtocol.RECORD_RID);
    channel.writeRID((ORID)o);
  }
 else {
    channel.writeShort((short)(o instanceof ORecordSchemaAware<?> && ((ORecordSchemaAware<?>)o).getSchemaClass() != null ? ((ORecordSchemaAware<?>)o).getSchemaClass().getId() : -1));
    ORecordInternal<?> rec=(ORecordInternal<?>)o;
    channel.writeByte(rec.getRecordType());
    channel.writeRID(rec.getIdentity());
    channel.writeInt(rec.getVersion());
    try {
      byte[] stream=rec.toStream();
      int realLength=stream.length;
      for (int i=stream.length - 1; i > -1; --i) {
        if (stream[i] == 32)         --realLength;
 else         break;
      }
      channel.writeBytes(stream,realLength);
    }
 catch (    Exception e) {
      channel.writeBytes(null);
      OLogManager.instance().error(this,"Error on unmarshalling record #" + o.getIdentity().toString(),OSerializationException.class);
    }
  }
}
