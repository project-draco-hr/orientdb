{
  OAtomicOperation atomicOperation=startAtomicOperation();
  acquireExclusiveLock();
  try {
    long lastPage=getFilledUpTo(atomicOperation,diskCache,fileId) - 1;
    OCacheEntry cacheEntry;
    if (lastPage < 0)     cacheEntry=addPage(atomicOperation,fileId,diskCache);
 else     cacheEntry=loadPage(atomicOperation,fileId,lastPage,false,diskCache);
    cacheEntry.acquireExclusiveLock();
    try {
      OClusterPositionMapBucket bucket=new OClusterPositionMapBucket(cacheEntry,getChangesTree(atomicOperation,cacheEntry));
      if (bucket.isFull()) {
        cacheEntry.releaseExclusiveLock();
        releasePage(atomicOperation,cacheEntry,diskCache);
        cacheEntry=addPage(atomicOperation,fileId,diskCache);
        cacheEntry.acquireExclusiveLock();
        bucket=new OClusterPositionMapBucket(cacheEntry,getChangesTree(atomicOperation,cacheEntry));
      }
      final long index=bucket.add(pageIndex,recordPosition);
      final long result=index + cacheEntry.getPageIndex() * OClusterPositionMapBucket.MAX_ENTRIES;
      endAtomicOperation(false);
      return result;
    }
 catch (    Throwable e) {
      endAtomicOperation(true);
      throw new OStorageException("Error during creation of mapping between logical adn physical record position.",e);
    }
 finally {
      cacheEntry.releaseExclusiveLock();
      releasePage(atomicOperation,cacheEntry,diskCache);
    }
  }
  finally {
    releaseExclusiveLock();
  }
}
