{
  int[] base64=isURL ? fromBase64URL : fromBase64;
  int dp=0;
  int bits=0;
  int shiftto=18;
  while (sp < sl) {
    int b=src[sp++] & 0xff;
    if ((b=base64[b]) < 0) {
      if (b == -2) {
        if (shiftto == 6 && (sp == sl || src[sp++] != '=') || shiftto == 18) {
          throw new IllegalArgumentException("Input byte array has wrong 4-byte ending unit");
        }
        break;
      }
      if (isMIME)       continue;
 else       throw new IllegalArgumentException("Illegal base64 character " + Integer.toString(src[sp - 1],16));
    }
    bits|=(b << shiftto);
    shiftto-=6;
    if (shiftto < 0) {
      dst[dp++]=(byte)(bits >> 16);
      dst[dp++]=(byte)(bits >> 8);
      dst[dp++]=(byte)(bits);
      shiftto=18;
      bits=0;
    }
  }
  if (shiftto == 6) {
    dst[dp++]=(byte)(bits >> 16);
  }
 else   if (shiftto == 0) {
    dst[dp++]=(byte)(bits >> 16);
    dst[dp++]=(byte)(bits >> 8);
  }
 else   if (shiftto == 12) {
    throw new IllegalArgumentException("Last unit does not have enough valid bits");
  }
  while (sp < sl) {
    if (isMIME && base64[src[sp++]] < 0)     continue;
    throw new IllegalArgumentException("Input byte array has incorrect ending byte at " + sp);
  }
  return dp;
}
