{
  acquireExclusiveLock();
  try {
    checkForKeyType(key);
    final OIdentifiable currentValue=super.get(key);
    if (currentValue != null) {
      if (!currentValue.equals(value))       throw new ORecordDuplicatedException("Found duplicated key '" + key + "' on unique index '"+ getName()+ "' for record "+ value.getIdentity()+ ". The record already present in the index is "+ currentValue.getIdentity(),currentValue.getIdentity());
 else       return this;
    }
    if (!value.getIdentity().isPersistent())     ((ORecord<?>)value.getRecord()).save();
    super.put(key,value.getIdentity());
    get(key);
    return this;
  }
  finally {
    releaseExclusiveLock();
  }
}
