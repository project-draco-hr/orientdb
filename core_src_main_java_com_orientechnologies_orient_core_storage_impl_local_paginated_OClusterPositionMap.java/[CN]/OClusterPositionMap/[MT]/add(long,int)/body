{
  acquireExclusiveLock();
  try {
    OAtomicOperation atomicOperation=storage.getAtomicOperationsManager().getCurrentOperation();
    long lastPage=getFilledUpTo(atomicOperation,diskCache,fileId) - 1;
    OCacheEntry cacheEntry=diskCache.load(fileId,lastPage,false);
    if (cacheEntry == null)     cacheEntry=diskCache.allocateNewPage(fileId);
    cacheEntry.acquireExclusiveLock();
    try {
      atomicOperation=startAtomicOperation();
      OClusterPositionMapBucket bucket=new OClusterPositionMapBucket(cacheEntry,getChangesTree(atomicOperation,cacheEntry));
      if (bucket.isFull()) {
        cacheEntry.releaseExclusiveLock();
        diskCache.release(cacheEntry);
        cacheEntry=diskCache.allocateNewPage(fileId);
        cacheEntry.acquireExclusiveLock();
        bucket=new OClusterPositionMapBucket(cacheEntry,getChangesTree(atomicOperation,cacheEntry));
      }
      final long index=bucket.add(pageIndex,recordPosition);
      final long result=index + cacheEntry.getPageIndex() * OClusterPositionMapBucket.MAX_ENTRIES;
      endAtomicOperation(false);
      return result;
    }
 catch (    Throwable e) {
      endAtomicOperation(true);
      throw new OStorageException("Error during creation of mapping between logical adn physical record position.",e);
    }
 finally {
      cacheEntry.releaseExclusiveLock();
      diskCache.release(cacheEntry);
    }
  }
  finally {
    releaseExclusiveLock();
  }
}
