{
  ONetworkProtocol protocol;
  OClientConnection connection;
  final int socketBufferSize=OConfiguration.NETWORK_SOCKET_BUFFER_SIZE.getValue();
  try {
    while (active) {
      try {
        Socket socket=serverSocket.accept();
        socket.setPerformancePreferences(0,2,1);
        socket.setSendBufferSize(socketBufferSize);
        socket.setReceiveBufferSize(socketBufferSize);
        protocol=protocolType.newInstance();
        connection=new OClientConnection(connectionSerial++,socket,protocol);
        protocol.config(socket,connection);
        if (commands != null)         for (        OServerCommand c : commands) {
          protocol.registerCommand(c);
        }
        OClientConnectionManager.instance().connect(socket,connection);
      }
 catch (      Throwable e) {
        OLogManager.instance().error(this,"Error on client connection",e);
      }
 finally {
      }
    }
  }
  finally {
    try {
      if (serverSocket != null && !serverSocket.isClosed())       serverSocket.close();
    }
 catch (    IOException ioe) {
    }
  }
}
