{
  final int[] clusterIds;
  if (compiledFilter.getTargetClasses() != null) {
    OClass cls=compiledFilter.getTargetClasses().keySet().iterator().next();
    database.checkSecurity(ODatabaseSecurityResources.CLASS,ORole.PERMISSION_READ,cls.getName());
    clusterIds=cls.getPolymorphicClusterIds();
    for (    int clusterId : clusterIds)     database.checkSecurity(ODatabaseSecurityResources.CLUSTER,ORole.PERMISSION_READ,database.getClusterNameById(clusterId),clusterId);
    final List<ORecord<?>> resultSet=searchForIndexes(cls);
    if (resultSet.size() > 0) {
      OProfiler.getInstance().updateCounter("Query.indexUsage",1);
      for (      ORecord<?> record : resultSet)       addResult(record);
    }
 else     scanEntireClusters(clusterIds);
  }
 else   if (compiledFilter.getTargetClusters() != null) {
    String firstCluster=compiledFilter.getTargetClusters().keySet().iterator().next();
    if (firstCluster == null || firstCluster.length() == 0)     throw new OCommandExecutionException("No cluster or schema class selected in query");
    if (Character.isDigit(firstCluster.charAt(0)))     clusterIds=OStringSerializerHelper.splitIntArray(firstCluster);
 else     clusterIds=new int[]{database.getClusterIdByName(firstCluster.toLowerCase())};
    database.checkSecurity(ODatabaseSecurityResources.CLUSTER,ORole.PERMISSION_READ,firstCluster.toLowerCase(),clusterIds[0]);
    scanEntireClusters(clusterIds);
  }
 else   if (compiledFilter.getTargetRecords() != null) {
    ORecordId rid=new ORecordId();
    ORecordInternal<?> record;
    for (    String rec : compiledFilter.getTargetRecords()) {
      rid.fromString(rec);
      record=database.load(rid);
      foreach(record);
    }
  }
 else   throw new OQueryParsingException("No source found in query: specify class, clusters or single records");
  applyOrderBy();
  applyFlatten();
  return handleResult();
}
