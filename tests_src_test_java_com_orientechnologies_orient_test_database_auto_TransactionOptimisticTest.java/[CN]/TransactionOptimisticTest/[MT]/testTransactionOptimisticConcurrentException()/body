{
  if (database.getClusterIdByName("binary") == -1)   database.addCluster("binary");
  ODatabaseDocumentTx db2=new ODatabaseDocumentTx(database.getURL());
  db2.open("admin","admin");
  ODatabaseRecordThreadLocal.INSTANCE.set(database);
  ORecordBytes record1=new ORecordBytes("This is the first version".getBytes());
  record1.save("binary");
  try {
    database.begin();
    record1.load();
    ODatabaseRecordThreadLocal.INSTANCE.set(db2);
    ORecordBytes record2=db2.load(record1.getIdentity());
    record2.setDirty();
    record2.fromStream("This is the second version".getBytes());
    record2.save();
    ODatabaseRecordThreadLocal.INSTANCE.set(database);
    record1.setDirty();
    record1.fromStream("This is the third version".getBytes());
    record1.save();
    database.commit();
    Assert.assertTrue(false);
  }
 catch (  OResponseProcessingException e) {
    Assert.assertTrue(e.getCause() instanceof OConcurrentModificationException);
    database.rollback();
  }
catch (  OConcurrentModificationException e) {
    Assert.assertTrue(true);
    database.rollback();
  }
 finally {
    database.close();
    db2.close();
  }
}
