{
  checkForRebuild();
  key=getCollatingValue(key);
  final OIdentifiable indexedRID=get(key);
  if (indexedRID != null && !indexedRID.getIdentity().equals(record.getIdentity())) {
    String storageType=getDatabase().getStorage().getType();
    if (storageType.equals(OEngineMemory.NAME) || storageType.equals(OEngineLocal.NAME)) {
      final OTransactionIndexChanges indexChanges=ODatabaseRecordThreadLocal.INSTANCE.get().getTransaction().getIndexChanges(getName());
      if (indexChanges != null) {
        final OTransactionIndexChangesPerKey keyChanges=indexChanges.getChangesPerKey(key);
        if (keyChanges != null) {
          for (          OTransactionIndexChangesPerKey.OTransactionIndexEntry entry : keyChanges.entries) {
            if (entry.operation == OTransactionIndexChanges.OPERATION.REMOVE)             return;
          }
        }
      }
    }
    throw new OIndexException("Cannot index record : " + record + " found duplicated key '"+ key+ "' in index "+ getName()+ " previously assigned to the record "+ indexedRID);
  }
}
