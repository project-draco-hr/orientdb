{
  acquireExclusiveLock();
  try {
    if (!active)     return;
    active=false;
    shutdownHook.cancel();
    profiler.shutdown();
    OLogManager.instance().debug(this,"Orient Engine is shutting down...");
    for (    OOrientListener l : listeners) {
      l.onShutdown();
    }
    databaseFactory.shutdown();
    final List<OStorage> storagesCopy=new ArrayList<OStorage>(storages.values());
    for (    OStorage stg : storagesCopy) {
      OLogManager.instance().debug(this,"Shutting down storage: " + stg.getName() + "...");
      stg.close(true);
    }
    OMMapManagerLocator.getInstance().shutdown();
    threadGroup.interrupt();
    listeners.clear();
    OLogManager.instance().debug(this,"Orient Engine shutdown complete");
  }
  finally {
    releaseExclusiveLock();
  }
}
