{
  metadataLock.lock();
  try {
    Long fileId=fileNameIdMap.get(fileName);
    if (fileId == null) {
      final long id=counter.incrementAndGet();
      files.put(id,new MemoryFile(id,pageSize));
      fileNameIdMap.put(fileName,id);
      fileId=id;
    }
    fileIdNameMap.put(fileId,fileName);
    return fileId;
  }
  finally {
    metadataLock.unlock();
  }
}
