{
  if (link instanceof ORID) {
    if (((ORID)link).isValid() && ((ORID)link).isNew()) {
      final ODatabaseDocument database=ODatabaseRecordThreadLocal.INSTANCE.get();
      ORecord record=link.getRecord();
      if (record != null) {
        if (ONetworkThreadLocalSerializer.getNetworkSerializer() != null)         throw new ODatabaseException("Impossible save a record during network serialization");
        database.save(record);
        return record;
      }
    }
  }
 else   if (link instanceof ORecord) {
    ORID rid=link.getIdentity();
    if (((ORecord)link).isDirty() || (rid.isTemporary())) {
      if (ONetworkThreadLocalSerializer.getNetworkSerializer() != null)       throw new ODatabaseException("Impossible save a record during network serialization");
      ((ORecord)link).save();
    }
  }
  return link;
}
