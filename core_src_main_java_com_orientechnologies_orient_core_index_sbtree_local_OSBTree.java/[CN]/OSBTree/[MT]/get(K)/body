{
  acquireSharedLock();
  try {
    checkNullSupport(key);
    OAtomicOperation atomicOperation=storage.getAtomicOperationsManager().getCurrentOperation();
    if (key != null) {
      key=keySerializer.preprocess(key,(Object[])keyTypes);
      BucketSearchResult bucketSearchResult=findBucket(key);
      if (bucketSearchResult.itemIndex < 0)       return null;
      long pageIndex=bucketSearchResult.getLastPathItem();
      OCacheEntry keyBucketCacheEntry=loadPage(atomicOperation,fileId,pageIndex,false,diskCache);
      try {
        OSBTreeBucket<K,V> keyBucket=new OSBTreeBucket<K,V>(keyBucketCacheEntry,keySerializer,keyTypes,valueSerializer,getChangesTree(atomicOperation,keyBucketCacheEntry));
        OSBTreeBucket.SBTreeEntry<K,V> treeEntry=keyBucket.getEntry(bucketSearchResult.itemIndex);
        return readValue(treeEntry.value);
      }
  finally {
        diskCache.release(keyBucketCacheEntry);
      }
    }
 else {
      if (getFilledUpTo(atomicOperation,diskCache,nullBucketFileId) == 0)       return null;
      final OCacheEntry nullBucketCacheEntry=loadPage(atomicOperation,nullBucketFileId,0,false,diskCache);
      try {
        final ONullBucket<V> nullBucket=new ONullBucket<V>(nullBucketCacheEntry,getChangesTree(atomicOperation,nullBucketCacheEntry),valueSerializer,false);
        final OSBTreeValue<V> treeValue=nullBucket.getValue();
        if (treeValue == null)         return null;
        return readValue(treeValue);
      }
  finally {
        diskCache.release(nullBucketCacheEntry);
      }
    }
  }
 catch (  IOException e) {
    throw new OSBTreeException("Error during retrieving  of sbtree with name " + name,e);
  }
 finally {
    releaseSharedLock();
  }
}
