{
  final Set<ORID> vertexes=new HashSet<ORID>();
  for (  OIdentifiable id : iRecords)   vertexes.add(id.getIdentity());
  final Set<OIdentifiable> edges=new LinkedHashSet<OIdentifiable>();
  for (  OIdentifiable rec : iRecords) {
    if (rec.getRecord() instanceof ODocument) {
      final ODocument doc=rec.getRecord();
      json.resetAttributes();
      json.beginObject(0,false,null);
      json.beginObject(1,false,"an");
      json.beginObject(2,false,doc.getIdentity());
      for (      String field : doc.fieldNames()) {
        final Object v=doc.field(field);
        if (v != null) {
          if (OGraphDatabase.VERTEX_FIELD_OUT.equals(field)) {
            final Collection<ODocument> edgeSet=(Collection<ODocument>)v;
            for (            ODocument e : edgeSet) {
              if (vertexes.contains(e.field("in")))               edges.add(e);
            }
          }
 else           if (OGraphDatabase.VERTEX_FIELD_IN.equals(field)) {
            final Collection<ODocument> edgeSet=(Collection<ODocument>)v;
            for (            ODocument e : edgeSet) {
              if (vertexes.contains(e.field("out")))               edges.add(e);
            }
          }
 else           json.writeAttribute(3,false,field,v);
        }
      }
      json.endObject(2,false);
      json.endObject(1,false);
      json.endObject(0,false);
      json.newline();
    }
  }
  for (  OIdentifiable rec : edges) {
    final ODocument doc=rec.getRecord();
    json.resetAttributes();
    json.beginObject();
    json.beginObject(1,false,"ae");
    json.beginObject(2,false,doc.getIdentity());
    json.writeAttribute(3,false,"directed",false);
    for (    String field : doc.fieldNames()) {
      final Object v=doc.field(field);
      if (v != null) {
        if (OGraphDatabase.EDGE_FIELD_IN.equals(field))         json.writeAttribute(3,false,"source",v);
 else         if (OGraphDatabase.EDGE_FIELD_OUT.equals(field))         json.writeAttribute(3,false,"target",v);
 else         json.writeAttribute(3,false,field,v);
      }
    }
    json.endObject(2,false);
    json.endObject(1,false);
    json.endObject(0,false);
    json.newline();
  }
}
