{
  ORecordInternal<?> replicaToAdd=record;
  boolean result;
  final ORecordVersion replicaVersion=record.getRecordVersion();
  try {
    if (!replicaVersion.isTombstone()) {
      replicaToAdd=mergeWithRecord(null);
      callbackHooks(TYPE.BEFORE_REPLICA_ADD,replicaToAdd);
    }
 else     replicaToAdd=(ORecordInternal<?>)record.copy();
    byte[] stream=replicaToAdd.toStream();
    final int dataSegmentId=dataSegmentStrategy.assignDataSegmentId(ODatabaseRecordAbstract.this,replicaToAdd);
    result=underlying.updateReplica(dataSegmentId,rid,stream,replicaVersion,replicaToAdd.getRecordType());
    if (!replicaVersion.isTombstone()) {
      callbackHooks(TYPE.AFTER_REPLICA_ADD,replicaToAdd);
      replicaToAdd.unsetDirty();
      getLocalCache().updateRecord(replicaToAdd);
    }
  }
 catch (  Exception e) {
    if (!replicaVersion.isTombstone())     callbackHooks(TYPE.AFTER_REPLICA_ADD,replicaToAdd);
    throw e;
  }
  return result;
}
