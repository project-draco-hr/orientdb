{
  String[] urlParts=checkSyntax(iRequest.url,2,"Syntax error: allocation/<database>");
  iRequest.data.commandInfo="Storage allocation";
  iRequest.data.commandDetail=urlParts[1];
  ODatabaseDocumentTx db=null;
  try {
    db=getProfiledDatabaseInstance(iRequest);
    if (!(db.getStorage() instanceof OStorageLocal))     throw new IllegalArgumentException("Cannot get allocation information for database '" + iRequest.databaseName + "' because it is not a disk-based database");
    final List<ODataHoleInfo> holes=((OStorageLocal)db.getStorage()).getHolesList();
    Collections.sort(holes);
    final StringWriter buffer=new StringWriter();
    final OJSONWriter json=new OJSONWriter(buffer);
    final ODataLocal dataSegment=((OStorageLocal)db.getStorage()).getDataSegmentById(0);
    final long dbSize=dataSegment.getFilledUpTo();
    json.beginObject();
    json.writeAttribute(1,true,"size",dbSize);
    long current=0;
    long holesSize=0;
    json.beginCollection(1,true,"segments");
    for (    ODataHoleInfo h : holes) {
      if (h.dataOffset == -1)       continue;
      if (current < h.dataOffset) {
        json.beginObject(2,true,null);
        json.writeAttribute(3,false,"type","d");
        json.writeAttribute(3,false,"offset",current);
        json.writeAttribute(3,false,"size",h.dataOffset - current);
        json.endObject(2,false);
      }
      json.beginObject(2,true,null);
      json.writeAttribute(3,false,"type","h");
      json.writeAttribute(3,false,"offset",h.dataOffset);
      json.writeAttribute(3,false,"size",h.size);
      json.endObject(2,false);
      holesSize+=h.size;
      current=h.dataOffset + h.size;
    }
    if (dbSize > current) {
      json.beginObject(2,true,null);
      json.writeAttribute(3,false,"type","d");
      json.writeAttribute(3,false,"offset",current);
      json.writeAttribute(3,false,"size",dbSize - current);
      json.endObject(2,false);
    }
    json.endCollection(1,true);
    json.writeAttribute(1,true,"dataSize",dbSize - holesSize);
    json.writeAttribute(1,true,"dataSizePercent",(dbSize - holesSize) * 100 / dbSize);
    json.writeAttribute(1,true,"holesSize",holesSize);
    json.writeAttribute(1,true,"holesSizePercent",100 - (dbSize - holesSize) * 100 / dbSize);
    json.endObject();
    json.flush();
    iResponse.sendTextContent(iRequest,OHttpUtils.STATUS_OK_CODE,"OK",null,OHttpUtils.CONTENT_JSON,buffer.toString());
  }
  finally {
    if (db != null)     OSharedDocumentDatabase.release(db);
  }
  return false;
}
