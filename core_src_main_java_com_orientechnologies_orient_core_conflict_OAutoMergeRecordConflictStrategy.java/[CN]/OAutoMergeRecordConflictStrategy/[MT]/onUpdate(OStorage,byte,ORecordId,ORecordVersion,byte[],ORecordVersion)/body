{
  if (iRecordType == ODocument.RECORD_TYPE) {
    OStorageOperationResult<ORawBuffer> res=storage.readRecord(rid,null,false,null);
    final ODocument storedRecord=new ODocument(rid).fromStream(res.getResult().getBuffer());
    final ODocument newRecord=new ODocument(rid).fromStream(iRecordContent);
    storedRecord.merge(newRecord,true,true);
    iDatabaseVersion.setCounter(Math.max(iDatabaseVersion.getCounter(),iRecordVersion.getCounter()) + 1);
    final ODatabaseDocumentInternal db=ODatabaseRecordThreadLocal.INSTANCE.get();
    db.getLocalCache().updateRecord(storedRecord);
    final OTransaction tx=db.getTransaction();
    if (tx.isActive()) {
      final ORecord txRecord=tx.getRecord(rid);
      if (txRecord != null)       txRecord.fromStream(iRecordContent);
    }
    return storedRecord.toStream();
  }
 else   checkVersions(rid,iRecordVersion,iDatabaseVersion);
  return null;
}
