{
  filesLock.acquireWriteLock();
  try {
    initNameIdMapping();
    Long fileId=nameIdMap.get(fileName);
    OFileClassic fileClassic;
    if (fileId == null)     fileClassic=null;
 else     fileClassic=files.get(fileId);
    if (fileClassic == null) {
      fileId=++fileCounter;
      fileClassic=createFile(fileName);
      files.put(fileId,fileClassic);
      nameIdMap.put(fileName,fileId);
      writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    }
    openFile(fileClassic);
    return fileId;
  }
  finally {
    filesLock.releaseWriteLock();
  }
}
