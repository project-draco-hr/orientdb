{
  if (!isRelatedToLocalServer(iDatabase))   return;
  final ODatabaseDocumentInternal currDb=ODatabaseRecordThreadLocal.INSTANCE.getIfDefined();
  try {
    if (configurationMap.containsKey(OHazelcastPlugin.CONFIG_DATABASE_PREFIX + iDatabase.getName()))     throw new ODistributedException("Cannot create a new database with the same name of one available distributed");
    final ODistributedDatabaseImpl distribDatabase=messageService.registerDatabase(iDatabase.getName());
    distribDatabase.setOnline();
    try {
      Thread.sleep(1000);
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      throw new ODistributedException("Error on creating database '" + iDatabase.getName() + "' on distributed nodes");
    }
    final ODistributedConfiguration cfg=getDatabaseConfiguration(iDatabase.getName());
    final Set<String> servers=cfg.getAllConfiguredServers();
    if (servers.size() > 1) {
      boolean allServersAreOnline=true;
      while (true) {
        for (        String server : servers) {
          if (!isNodeOnline(server,iDatabase.getName())) {
            allServersAreOnline=false;
            break;
          }
        }
        if (allServersAreOnline)         break;
        try {
          Thread.sleep(200);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          throw new ODistributedException("Error on creating database '" + iDatabase.getName() + "' on distributed nodes");
        }
      }
    }
    onOpen(iDatabase);
  }
  finally {
    ODatabaseRecordThreadLocal.INSTANCE.set(currDb);
  }
}
