{
  if (writeAheadLog == null)   return;
  try {
    Set<ODirtyPage> dirtyPages;
    lock.acquireExclusiveLock();
    boolean exclusiveLock=true;
    boolean sharedLock=false;
    try {
      diskCache.forceSyncStoredChanges();
      writeAheadLog.logCheckPointStart();
      for (      OLocalPaginatedCluster cluster : clusters)       cluster.prohibitPageDefragmentation();
      for (      OLocalPaginatedCluster cluster : clusters)       cluster.logClusterState();
      dirtyPages=diskCache.logDirtyPagesTable(writeAheadLog);
      lock.acquireSharedLock();
      sharedLock=true;
      lock.releaseExclusiveLock();
      exclusiveLock=false;
      final Map<String,Long> fileNameIdMap=diskCache.getFileNameIdMap();
      for (      ODirtyPage dirtyPage : dirtyPages)       diskCache.logPage(writeAheadLog,fileNameIdMap.get(dirtyPage.getFileName()),dirtyPage.getPageIndex());
      writeAheadLog.logCheckPointEnd();
      for (      OLocalPaginatedCluster cluster : clusters)       cluster.allowPageDefragmentation();
    }
  finally {
      if (sharedLock)       lock.releaseSharedLock();
      if (exclusiveLock)       lock.releaseExclusiveLock();
    }
  }
 catch (  IOException ioe) {
    throw new OStorageException("Error during snapshot creation for storage " + name,ioe);
  }
}
