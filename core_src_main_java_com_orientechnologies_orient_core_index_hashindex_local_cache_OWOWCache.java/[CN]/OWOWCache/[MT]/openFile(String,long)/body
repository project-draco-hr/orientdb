{
  filesLock.writeLock().lock();
  try {
    initNameIdMapping();
    OFileClassic fileClassic;
    Long existingFileId=nameIdMap.get(fileName);
    if (existingFileId != null) {
      if (existingFileId == fileId)       fileClassic=files.get(fileId);
 else       throw new OStorageException("File with given name already exists but has different id " + existingFileId + " vs. proposed "+ fileId);
    }
 else {
      if (fileCounter < fileId)       fileCounter=fileId;
      fileClassic=createFile(fileName);
      files.put(fileId,fileClassic);
      nameIdMap.put(fileName,fileId);
      writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    }
    openFile(fileClassic);
  }
  finally {
    filesLock.writeLock().unlock();
  }
}
