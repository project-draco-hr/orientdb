{
  setDataCommandInfo("Load record");
  final ORecordId rid=channel.readRID();
  final String fetchPlanString=channel.readString();
  boolean ignoreCache=false;
  if (connection.data.protocolVersion >= 9)   ignoreCache=channel.readByte() == 1;
  if (rid.clusterId == 0 && rid.clusterPosition.longValue() == 0) {
    OFetchHelper.checkFetchPlanValid(fetchPlanString);
    beginResponse();
    try {
      sendOk(clientTxId);
      channel.writeByte((byte)1);
      channel.writeBytes(connection.database.getStorage().getConfiguration().toStream());
      channel.writeVersion(OVersionFactory.instance().createVersion());
      channel.writeByte(ORecordBytes.RECORD_TYPE);
      channel.writeByte((byte)0);
    }
  finally {
      endResponse();
    }
  }
 else {
    final ORecordInternal<?> record=connection.database.load(rid,fetchPlanString,ignoreCache);
    beginResponse();
    try {
      sendOk(clientTxId);
      if (record != null) {
        channel.writeByte((byte)1);
        channel.writeBytes(record.toStream());
        channel.writeVersion(record.getRecordVersion());
        channel.writeByte(record.getRecordType());
        if (fetchPlanString.length() > 0) {
          if (record instanceof ODocument) {
            final Map<String,Integer> fetchPlan=OFetchHelper.buildFetchPlan(fetchPlanString);
            final Set<ODocument> recordsToSend=new HashSet<ODocument>();
            final ODocument doc=(ODocument)record;
            final OFetchListener listener=new ORemoteFetchListener(recordsToSend);
            final OFetchContext context=new ORemoteFetchContext();
            OFetchHelper.fetch(doc,doc,fetchPlan,listener,context);
            for (            ODocument d : recordsToSend) {
              if (d.getIdentity().isValid()) {
                channel.writeByte((byte)2);
                writeIdentifiable(d);
              }
            }
          }
        }
      }
      channel.writeByte((byte)0);
    }
  finally {
      endResponse();
    }
  }
}
