{
  final StringBuilder buffer=new StringBuilder();
switch (iType) {
case LINK:
{
      final ORID rid=linkToStream(buffer,iRecord,iValue);
      if (rid != null)       iRecord.field(iName,rid);
      break;
    }
case LINKLIST:
{
    buffer.append(OStringSerializerHelper.COLLECTION_BEGIN);
    if (iValue != null) {
      ORID rid;
      int items=0;
      List<Object> coll=(List<Object>)iValue;
      for (int i=0; i < coll.size(); ++i) {
        if (items++ > 0)         buffer.append(OStringSerializerHelper.RECORD_SEPARATOR);
        rid=linkToStream(buffer,iRecord,coll.get(i));
        if (rid != null)         coll.set(i,rid);
      }
    }
    buffer.append(OStringSerializerHelper.COLLECTION_END);
    break;
  }
case LINKSET:
{
  buffer.append(OStringSerializerHelper.COLLECTION_BEGIN);
  ORID rid;
  int items=0;
  Set<Object> coll=(Set<Object>)iValue;
  Map<Object,Object> objToReplace=null;
  for (  Object item : coll) {
    if (items++ > 0)     buffer.append(OStringSerializerHelper.RECORD_SEPARATOR);
    rid=linkToStream(buffer,iRecord,item);
    if (rid != null) {
      if (objToReplace == null)       objToReplace=new HashMap<Object,Object>();
      objToReplace.put(item,rid);
    }
  }
  if (objToReplace != null)   for (  Map.Entry<Object,Object> entry : objToReplace.entrySet()) {
    coll.remove(entry.getKey());
    coll.add(entry.getValue());
  }
  buffer.append(OStringSerializerHelper.COLLECTION_END);
  break;
}
case LINKMAP:
{
buffer.append(OStringSerializerHelper.MAP_BEGIN);
ORID rid;
int items=0;
Map<String,Object> map=(Map<String,Object>)iValue;
Map<String,Object> objToReplace=null;
for (Map.Entry<String,Object> entry : map.entrySet()) {
  if (items++ > 0)   buffer.append(OStringSerializerHelper.RECORD_SEPARATOR);
  buffer.append(OStringSerializerHelper.fieldTypeToString(iDatabase,OType.STRING,entry.getKey()));
  buffer.append(OStringSerializerHelper.ENTRY_SEPARATOR);
  rid=linkToStream(buffer,iRecord,entry.getValue());
  if (rid != null) {
    if (objToReplace == null)     objToReplace=new HashMap<String,Object>();
    objToReplace.put(entry.getKey(),rid);
  }
}
if (objToReplace != null) for (Map.Entry<String,Object> entry : objToReplace.entrySet()) {
  map.put(entry.getKey(),entry.getValue());
}
buffer.append(OStringSerializerHelper.MAP_END);
break;
}
case EMBEDDED:
if (iValue instanceof ODocument) {
buffer.append(OStringSerializerHelper.EMBEDDED);
buffer.append(toString((ODocument)iValue,null,iObjHandler,iMarshalledRecords));
buffer.append(OStringSerializerHelper.EMBEDDED);
}
 else if (iValue != null) buffer.append(iValue.toString());
break;
case EMBEDDEDLIST:
case EMBEDDEDSET:
{
buffer.append(embeddedCollectionToStream(iDatabase,iObjHandler,iLinkedClass,iLinkedType,iValue,iMarshalledRecords));
break;
}
case EMBEDDEDMAP:
{
buffer.append(embeddedMapToStream(iDatabase,iObjHandler,iLinkedClass,iLinkedType,iValue,iMarshalledRecords));
break;
}
default :
return OStringSerializerHelper.fieldTypeToString(iDatabase,iType,iValue);
}
return buffer.toString();
}
