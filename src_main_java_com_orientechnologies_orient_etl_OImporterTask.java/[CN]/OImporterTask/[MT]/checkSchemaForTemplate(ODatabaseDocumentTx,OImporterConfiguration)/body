{
  OClass cls=db.getMetadata().getSchema().getClass(template.getClassName());
  OClass superCls=null;
  if (template.getSuperClass() != null) {
    superCls=db.getMetadata().getSchema().getClass(template.getSuperClass());
    if (superCls == null)     superCls=db.getMetadata().getSchema().createClass(template.getSuperClass());
  }
  if (cls == null) {
    if (superCls != null)     cls=db.getMetadata().getSchema().createClass(template.getClassName(),superCls);
 else     cls=db.getMetadata().getSchema().createClass(template.getClassName());
  }
 else {
    if (superCls != null) {
      if (template.getSuperClass() != null && !superCls.getName().equalsIgnoreCase(template.getSuperClass()) || cls.getSuperClass() != superCls)       cls.setSuperClass(superCls);
    }
 else     if (cls.getSuperClass() != null)     cls.setSuperClass(null);
  }
  for (  Entry<String[],String[]> it : template.getClassIndexes()) {
    final String indexName=it.getKey()[0];
    final String indexType=it.getKey()[1];
    final String[] indexFields=it.getValue();
    OIndex<?> idx=db.getMetadata().getIndexManager().getIndex(indexName);
    if (idx == null) {
      OLogManager.instance().info(this,"Creating new index '%s' of type '%s' against class '%s' fields '%s'...",indexName,indexType,template.getClassName(),Arrays.toString(indexFields));
      for (      String field : indexFields) {
        OProperty prop=cls.getProperty(field);
        if (prop == null)         prop=cls.createProperty(field,template.getFieldType(field));
      }
      idx=cls.createIndex(indexName,indexType,indexFields);
      OLogManager.instance().info(this,"Indexed %d records for index '%s'",idx.getSize(),template.getClassName(),it.getKey());
    }
  }
  for (  String field : template.getFieldNames()) {
    final List<OIndex<?>> idxs=new ArrayList<OIndex<?>>(cls.getInvolvedIndexes(field));
    final String idxType=template.getFieldIndex(field);
    if (idxType != null) {
      OProperty prop=cls.getProperty(field);
      if (prop == null)       prop=cls.createProperty(field,template.getFieldType(field));
      if (idxs == null || idxs.isEmpty()) {
        OLogManager.instance().info(this,"Creating new index of type '%s' against field '%s.%s'...",idxType,template.getClassName(),field);
        final OIndex<?> idx=prop.createIndex(idxType.toUpperCase());
        OLogManager.instance().info(this,"Indexed %d records for index '%s.%s'",idx.getSize(),template.getClassName(),field);
      }
    }
 else {
      for (      OIndex<?> idx : idxs) {
        if (idx.isAutomatic() && idx.getKeyTypes().length == 1) {
          OLogManager.instance().info(this,"Dropping index '%s' against field '%s.%s'...",idx.getName(),template.getClassName(),field);
          idx.delete();
        }
      }
    }
  }
  return cls;
}
