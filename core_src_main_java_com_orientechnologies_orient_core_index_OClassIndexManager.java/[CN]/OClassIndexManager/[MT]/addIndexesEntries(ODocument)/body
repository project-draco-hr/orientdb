{
  document=checkForLoading(document);
  final OIdentifiable rid=document.getIdentity();
  final OClass cls=ODocumentInternal.getImmutableSchemaClass(document);
  if (cls != null) {
    final Collection<OIndex<?>> indexes=cls.getIndexes();
    for (    final OIndex<?> index : indexes) {
      final OIndexDefinition indexDefinition=index.getDefinition();
      final Object key=indexDefinition.getDocumentValueToIndex(document);
      if (key instanceof Collection) {
        for (        final Object keyItem : (Collection<?>)key)         if (!indexDefinition.isNullValuesIgnored() || keyItem != null)         index.put(keyItem,rid);
      }
 else       if (!indexDefinition.isNullValuesIgnored() || key != null)       try {
        index.put(key,rid);
      }
 catch (      ORecordDuplicatedException e) {
        if (!database.getTransaction().isActive()) {
          database.delete(document);
        }
        throw e;
      }
    }
  }
}
