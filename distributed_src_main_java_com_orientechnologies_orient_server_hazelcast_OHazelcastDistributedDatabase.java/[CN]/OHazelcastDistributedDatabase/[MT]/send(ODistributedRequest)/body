{
  final Thread currentThread=Thread.currentThread();
  final long threadId=currentThread.getId();
  final String databaseName=iRequest.getDatabaseName();
  final String clusterName=iRequest.getClusterName();
  final ODistributedConfiguration cfg=manager.getDatabaseConfiguration(databaseName);
  final ODistributedPartitioningStrategy strategy=manager.getPartitioningStrategy(cfg.getPartitionStrategy(clusterName));
  final ODistributedPartition partition=strategy.getPartition(manager,databaseName,clusterName);
  final Set<String> nodes=partition.getNodes();
  final IQueue<ODistributedRequest>[] reqQueues=getRequestQueues(databaseName,nodes);
  final int queueSize=nodes.size();
  int quorum=calculateQuorum(iRequest,clusterName,cfg,nodes,queueSize);
  iRequest.setSenderNodeName(manager.getLocalNodeName());
  iRequest.setSenderThreadId(threadId);
  int availableNodes=0;
  for (  String node : nodes) {
    if (manager.isNodeAvailable(node))     availableNodes++;
 else {
      if (ODistributedServerLog.isDebugEnabled())       ODistributedServerLog.debug(this,getLocalNodeNameAndThread(),node,DIRECTION.OUT,"skip listening of response because node '%s' is not online",node);
    }
  }
  int expectedSynchronousResponses=quorum > 0 ? Math.min(quorum,availableNodes) : queueSize;
  final boolean waitLocalNode=nodes.contains(manager.getLocalNodeName()) && cfg.isReadYourWrites(clusterName);
  final ODistributedResponseManager currentResponseMgr=new ODistributedResponseManager(manager,iRequest,nodes,expectedSynchronousResponses,quorum,waitLocalNode,iRequest.getPayload().getSynchronousTimeout(expectedSynchronousResponses),iRequest.getPayload().getTotalTimeout(queueSize));
  msgService.registerRequest(iRequest.getId(),currentResponseMgr);
  if (ODistributedServerLog.isDebugEnabled())   ODistributedServerLog.debug(this,getLocalNodeNameAndThread(),nodes.toString(),DIRECTION.OUT,"request %s",iRequest.getPayload());
  final long timeout=OGlobalConfiguration.DISTRIBUTED_QUEUE_TIMEOUT.getValueAsLong();
  try {
    requestLock.lock();
    try {
      for (      IQueue<ODistributedRequest> queue : reqQueues) {
        queue.offer(iRequest,timeout,TimeUnit.MILLISECONDS);
      }
    }
  finally {
      requestLock.unlock();
    }
    Orient.instance().getProfiler().updateCounter("distributed.replication.msgSent","Number of replication messages sent from current node",+1);
    return collectResponses(iRequest,currentResponseMgr);
  }
 catch (  Throwable e) {
    throw new ODistributedException("Error on sending distributed request against " + databaseName + (clusterName != null ? ":" + clusterName : ""),e);
  }
}
