{
  final long timer=OProfiler.getInstance().startChrono();
  lock.acquireExclusiveLock();
  try {
    if (recordsToCommit.size() > 0) {
      final List<OMVRBTreeEntryPersistent<K,V>> tmp=new ArrayList<OMVRBTreeEntryPersistent<K,V>>();
      while (recordsToCommit.iterator().hasNext()) {
        tmp.addAll(recordsToCommit);
        recordsToCommit.clear();
        for (        OMVRBTreeEntryPersistent<K,V> node : tmp)         if (node.record.isDirty()) {
          if (iDatabase != null)           node.record.setDatabase(iDatabase);
          boolean wasNew=node.record.getIdentity().isNew();
          node.save();
          if (debug)           System.out.printf("\nSaved %s tree node %s: parent %s, left %s, right %s",wasNew ? "new" : "",node.record.getIdentity(),node.parentRid,node.leftRid,node.rightRid);
          if (wasNew) {
            if (node.record.getIdentity().getClusterPosition() < -1) {
              if (cache.get(node.record) != node)               cache.put(node.record.getIdentity().copy(),node);
            }
 else             if (node.parent != null)             ((OMVRBTreeEntryPersistent<K,V>)node.parent).markDirty();
            if (node.left != null)             ((OMVRBTreeEntryPersistent<K,V>)node.left).markDirty();
            if (node.right != null)             ((OMVRBTreeEntryPersistent<K,V>)node.right).markDirty();
            cache.put(node.record.getIdentity(),node);
          }
        }
        tmp.clear();
      }
    }
    if (record.isDirty()) {
      if (iDatabase != null)       record.setDatabase(iDatabase);
      save();
    }
  }
 catch (  IOException e) {
    OLogManager.instance().exception("Error on saving the tree",e,OStorageException.class);
  }
 finally {
    lock.releaseExclusiveLock();
    OProfiler.getInstance().stopChrono("OMVRBTreePersistent.commitChanges",timer);
  }
}
