{
  final Set<String> clusters=new HashSet<String>();
  final ODatabaseRecord db=getDatabase();
  if (parsedTarget.getTargetQuery() != null) {
    clusters.addAll(parsedTarget.getTargetQuery().getInvolvedClusters());
  }
 else   if (parsedTarget.getTargetRecords() != null) {
    for (    OIdentifiable identifiable : parsedTarget.getTargetRecords()) {
      clusters.add(db.getClusterNameById(identifiable.getIdentity().getClusterId()).toLowerCase());
    }
  }
  if (parsedTarget.getTargetClasses() != null) {
    for (    String clazz : parsedTarget.getTargetClasses().values()) {
      final OClass cls=db.getMetadata().getSchema().getClass(clazz);
      if (cls != null)       for (      int clId : cls.getClusterIds()) {
        clusters.add(db.getClusterNameById(clId).toLowerCase());
      }
    }
  }
  if (parsedTarget.getTargetClusters() != null) {
    for (    String cluster : parsedTarget.getTargetClusters().keySet()) {
      clusters.add(cluster.toLowerCase());
    }
  }
  if (parsedTarget.getTargetIndex() != null) {
    final OIndex<?> idx=db.getMetadata().getIndexManager().getIndex(parsedTarget.getTargetIndex());
    if (idx != null) {
      final String clazz=idx.getDefinition().getClassName();
      if (clazz != null) {
        final OClass cls=db.getMetadata().getSchema().getClass(clazz);
        if (cls != null)         for (        int clId : cls.getClusterIds()) {
          clusters.add(db.getClusterNameById(clId).toLowerCase());
        }
      }
    }
  }
  return clusters;
}
