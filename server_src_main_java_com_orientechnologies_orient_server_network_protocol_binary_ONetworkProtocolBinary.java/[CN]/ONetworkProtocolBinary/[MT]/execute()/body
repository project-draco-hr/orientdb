{
  lastRequestType=-1;
  data.commandInfo="Listening";
  data.commandDetail="-";
  lastClientTxId=0;
  try {
    lastRequestType=channel.readByte();
    lastClientTxId=channel.readInt();
    if (lastClientTxId > -1)     connection=OClientConnectionManager.instance().getConnection(lastClientTxId);
 else {
      if (connection == null) {
        sendShutdown();
        return;
      }
 else       connection=OClientConnectionManager.instance().connect(connection.protocol.getChannel().socket,this);
    }
    ODatabaseRecordThreadLocal.INSTANCE.set(connection.database);
    ++data.totalRequests;
    data.lastCommandReceived=System.currentTimeMillis();
    OServerHandlerHelper.invokeHandlerCallbackOnBeforeClientRequest(connection,(byte)lastRequestType);
    parseCommand();
    OServerHandlerHelper.invokeHandlerCallbackOnAfterClientRequest(connection,(byte)lastRequestType);
  }
 catch (  EOFException e) {
    handleConnectionError(e);
    sendShutdown();
  }
catch (  SocketException e) {
    handleConnectionError(e);
    sendShutdown();
  }
catch (  OException e) {
    sendError(lastClientTxId,e);
  }
catch (  RuntimeException e) {
    sendError(lastClientTxId,e);
  }
catch (  Throwable t) {
    OLogManager.instance().error(this,"Error on executing request",t);
    sendError(lastClientTxId,t);
  }
 finally {
    try {
      channel.flush();
    }
 catch (    Throwable t) {
      OLogManager.instance().debug(this,"Error on send data over the network",t);
    }
    OSerializationThreadLocal.INSTANCE.get().clear();
    data.lastCommandExecutionTime=System.currentTimeMillis() - data.lastCommandReceived;
    data.totalCommandExecutionTime+=data.lastCommandExecutionTime;
    data.lastCommandInfo=data.commandInfo;
    data.lastCommandDetail=data.commandDetail;
  }
}
