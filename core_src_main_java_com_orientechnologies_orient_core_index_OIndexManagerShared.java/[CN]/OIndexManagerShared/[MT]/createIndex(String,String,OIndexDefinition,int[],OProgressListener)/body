{
  if (getDatabase().getTransaction().isActive())   throw new IllegalStateException("Cannot create a new index inside a transaction");
  final Character c=OSchemaShared.checkNameIfValid(iName);
  if (c != null)   throw new IllegalArgumentException("Invalid index name '" + iName + "'. Character '"+ c+ "' is invalid");
  acquireExclusiveLock();
  try {
    final OIndexInternal<?> index=OIndexes.createIndex(getDatabase(),iType);
    final String clusterName=indexDefinition != null && indexDefinition.getClassName() != null ? defaultClusterName : manualClusterName;
    if (iProgressListener == null)     iProgressListener=new OIndexRebuildOutputListener(index);
    index.create(iName,indexDefinition,getDatabase(),clusterName,iClusterIdsToIndex,iProgressListener);
    addIndexInternal(index);
    setDirty();
    save();
    return getIndexInstance(index);
  }
  finally {
    releaseExclusiveLock();
  }
}
