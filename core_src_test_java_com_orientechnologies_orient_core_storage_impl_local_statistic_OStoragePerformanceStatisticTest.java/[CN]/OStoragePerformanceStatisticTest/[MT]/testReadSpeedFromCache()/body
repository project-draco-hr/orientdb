{
  final AtomicLong nanoIncrement=new AtomicLong();
  nanoIncrement.set(100);
  final OStoragePerformanceStatistic storagePerformanceStatistic=new OStoragePerformanceStatistic(1024,"test",1,new OStoragePerformanceStatistic.NanoTimer(){
    private long counter=0;
    @Override public long getNano(){
      return counter+=nanoIncrement.get();
    }
  }
,100000);
  Assert.assertFalse(storagePerformanceStatistic.isMeasurementEnabled());
  Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInPages(),-1);
  Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInMB(),-1);
  storagePerformanceStatistic.startMeasurement();
  final AtomicBoolean stop=new AtomicBoolean();
  final ExecutorService executor=Executors.newSingleThreadExecutor();
  final Future<Void> future=executor.submit(new Callable<Void>(){
    @Override public Void call() throws Exception {
      while (!stop.get()) {
        storagePerformanceStatistic.startCommitTimer();
        storagePerformanceStatistic.startPageReadFromCacheTimer();
        storagePerformanceStatistic.stopPageReadFromCacheTimer();
        storagePerformanceStatistic.stopCommitTimer();
      }
      return null;
    }
  }
);
  long notZeroSpeedCount=0;
  long msStart=System.currentTimeMillis();
  long counter=0;
  while (notZeroSpeedCount < 100000) {
    if (counter % 1000 == 0 && System.currentTimeMillis() - msStart > 10000)     break;
    final long pagesSpeed=storagePerformanceStatistic.getReadSpeedFromCacheInPages();
    final long mbSpeed=storagePerformanceStatistic.getReadSpeedFromCacheInMB();
    if (pagesSpeed == -1) {
      Thread.yield();
    }
 else {
      notZeroSpeedCount++;
      Assert.assertEquals(pagesSpeed,10000000);
      Assert.assertEquals(mbSpeed,10000000 / 1024);
    }
    Thread.yield();
    counter++;
  }
  Assert.assertTrue(notZeroSpeedCount > 0);
  System.out.println("testReadSpeedFromCache : not zero speed count " + notZeroSpeedCount);
  storagePerformanceStatistic.stopMeasurement();
  if (storagePerformanceStatistic.getReadSpeedFromCacheInPages() > 0) {
    System.out.println("testReadSpeedFromCache : check that values were not changed after stop measurement");
    nanoIncrement.set(10);
    Thread.sleep(200);
    Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInPages(),10000000);
    Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInMB(),10000000 / 1024);
    Assert.assertFalse(storagePerformanceStatistic.isMeasurementEnabled());
  }
  stop.set(true);
  future.get();
  storagePerformanceStatistic.startMeasurement();
  Thread.sleep(200);
  Assert.assertTrue(storagePerformanceStatistic.isMeasurementEnabled());
  Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInPages(),-1);
  Assert.assertEquals(storagePerformanceStatistic.getReadSpeedFromCacheInMB(),-1);
  executor.shutdown();
}
