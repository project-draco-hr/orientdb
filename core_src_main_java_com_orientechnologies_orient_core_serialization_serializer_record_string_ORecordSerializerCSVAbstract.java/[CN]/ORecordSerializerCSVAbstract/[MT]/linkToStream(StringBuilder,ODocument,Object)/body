{
  if (iLinked == null)   return null;
  OIdentifiable resultRid=null;
  ORID rid;
  if (iLinked instanceof ORID) {
    rid=(ORID)iLinked;
    if (rid.isValid() && rid.isNew()) {
      final ORecord record=rid.getRecord();
      final ODatabaseDocument database=ODatabaseRecordThreadLocal.INSTANCE.get();
      if (record != null) {
        database.save((ORecord)record);
        rid=record.getIdentity();
      }
      resultRid=rid;
    }
  }
 else {
    if (iLinked instanceof String)     iLinked=new ORecordId((String)iLinked);
 else     if (!(iLinked instanceof ORecord)) {
      final String boundDocumentField=OObjectSerializerHelperManager.getInstance().getDocumentBoundField(iLinked.getClass());
      if (boundDocumentField != null)       iLinked=OObjectSerializerHelperManager.getInstance().getFieldValue(iLinked,boundDocumentField);
    }
    if (!(iLinked instanceof OIdentifiable))     throw new IllegalArgumentException("Invalid object received. Expected a OIdentifiable but received type=" + iLinked.getClass().getName() + " and value="+ iLinked);
    ORecord iLinkedRecord=((OIdentifiable)iLinked).getRecord();
    rid=iLinkedRecord.getIdentity();
    if ((rid.isNew() && !rid.isTemporary()) || iLinkedRecord.isDirty()) {
      final ODatabaseDocumentInternal database=ODatabaseRecordThreadLocal.INSTANCE.get();
      if (iLinkedRecord instanceof ODocument) {
        final OClass schemaClass=ODocumentInternal.getImmutableSchemaClass(((ODocument)iLinkedRecord));
        database.save(iLinkedRecord,schemaClass != null ? database.getClusterNameById(schemaClass.getClusterForNewInstance((ODocument)iLinkedRecord)) : null);
      }
 else       database.save(iLinkedRecord);
      final ODatabase<?> dbOwner=database.getDatabaseOwner();
      dbOwner.registerUserObjectAfterLinkSave(iLinkedRecord);
      resultRid=iLinkedRecord;
    }
    final ODatabaseDocument database=ODatabaseRecordThreadLocal.INSTANCE.get();
    if (iParentRecord != null) {
      if (!database.isRetainRecords())       resultRid=iLinkedRecord.getIdentity();
    }
  }
  if (rid.isValid())   rid.toString(buffer);
  return resultRid;
}
