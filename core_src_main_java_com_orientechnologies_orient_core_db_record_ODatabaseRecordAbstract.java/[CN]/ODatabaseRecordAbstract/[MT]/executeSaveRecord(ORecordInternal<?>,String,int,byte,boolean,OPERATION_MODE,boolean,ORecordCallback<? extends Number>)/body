{
  checkOpeness();
  if (!iRecord.isDirty())   return (RET)iRecord;
  final ORecordId rid=(ORecordId)iRecord.getIdentity();
  if (rid == null)   throw new ODatabaseException("Cannot create record because it has no identity. Probably is not a regular record or contains projections of fields rather than a full record");
  setCurrentDatabaseinThreadLocal();
  try {
    final boolean wasNew=iForceCreate || rid.isNew();
    if (wasNew && rid.clusterId == -1 && iClusterName != null)     rid.clusterId=getClusterIdByName(iClusterName);
    byte[] stream=iRecord.toStream();
    final boolean isNew=iForceCreate || rid.isNew();
    if (isNew)     iRecord.onBeforeIdentityChanged(rid);
 else     if (stream == null || stream.length == 0)     return (RET)iRecord;
    if (isNew && rid.clusterId < 0)     rid.clusterId=iClusterName != null ? getClusterIdByName(iClusterName) : getDefaultClusterId();
    if (rid.clusterId > -1 && iClusterName == null)     iClusterName=getClusterNameById(rid.clusterId);
    if (stream != null && stream.length > 0) {
      if (iCallTriggers)       if (wasNew) {
        checkSecurity(ODatabaseSecurityResources.CLUSTER,ORole.PERMISSION_CREATE,iClusterName);
        if (callbackHooks(TYPE.BEFORE_CREATE,iRecord) == RESULT.RECORD_CHANGED)         stream=iRecord.toStream();
      }
 else {
        checkSecurity(ODatabaseSecurityResources.CLUSTER,ORole.PERMISSION_UPDATE,iClusterName);
        if (callbackHooks(TYPE.BEFORE_UPDATE,iRecord) == RESULT.RECORD_CHANGED)         stream=iRecord.toStream();
      }
    }
    if (!iRecord.isDirty())     return (RET)iRecord;
    final int realVersion=!mvcc || iVersion == -1 ? -1 : iRecord.getVersion();
    final int dataSegmentId=dataSegmentStrategy.assignDataSegmentId(this,iRecord);
    try {
      final OStorageOperationResult<Integer> operationResult=underlying.save(dataSegmentId,rid,stream == null ? new byte[0] : stream,realVersion,iRecord.getRecordType(),iMode.ordinal(),iForceCreate,iCallback);
      final int version=operationResult.getResult();
      if (isNew) {
        ((ORecordId)iRecord.getIdentity()).copyFrom(rid);
        iRecord.onAfterIdentityChanged(iRecord);
        iRecord.fill(rid,version,stream,stream == null || stream.length == 0);
      }
 else {
        iRecord.fill(rid,version,stream,stream == null || stream.length == 0);
      }
      if (iCallTriggers && stream != null && stream.length > 0) {
        if (!operationResult.isMoved()) {
          callbackHooks(wasNew ? TYPE.AFTER_CREATE : TYPE.AFTER_UPDATE,iRecord);
        }
 else {
          callbackHooks(wasNew ? TYPE.CREATE_REPLICATED : TYPE.UPDATE_REPLICATED,iRecord);
        }
      }
      if (stream != null && stream.length > 0 && !operationResult.isMoved())       getLevel1Cache().updateRecord(iRecord);
    }
 catch (    Throwable t) {
      if (iCallTriggers && stream != null && stream.length > 0)       callbackHooks(wasNew ? TYPE.CREATE_FAILED : TYPE.UPDATE_FAILED,iRecord);
      throw t;
    }
  }
 catch (  OException e) {
    throw e;
  }
catch (  Throwable t) {
    throw new ODatabaseException("Error on saving record in cluster #" + iRecord.getIdentity().getClusterId(),t);
  }
  return (RET)iRecord;
}
