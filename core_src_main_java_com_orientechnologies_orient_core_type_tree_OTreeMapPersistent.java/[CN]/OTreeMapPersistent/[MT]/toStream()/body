{
  final long timer=OProfiler.getInstance().startChrono();
  final Integer identityRecord=System.identityHashCode(record);
  final Set<Integer> marshalledRecords=OSerializationThreadLocal.INSTANCE.get();
  if (marshalledRecords.contains(identityRecord)) {
    return new byte[]{};
  }
 else   marshalledRecords.add(identityRecord);
  OMemoryOutputStream stream=new OMemoryOutputStream();
  try {
    if (root != null) {
      OTreeMapEntryPersistent<K,V> pRoot=(OTreeMapEntryPersistent<K,V>)root;
      if (pRoot.record.getIdentity().isNew()) {
        pRoot.save();
      }
      stream.add(pRoot.record.getIdentity().toStream());
    }
 else     stream.add(ORecordId.EMPTY_RECORD_ID_STREAM);
    stream.add(size);
    stream.add((short)lastPageSize);
    stream.add(keySerializer.getName());
    stream.add(valueSerializer.getName());
    record.fromStream(stream.getByteArray());
    return record.toStream();
  }
  finally {
    marshalledRecords.remove(identityRecord);
    OProfiler.getInstance().stopChrono("OTreeMapPersistent.toStream",timer);
  }
}
