{
  if (!(iRecord instanceof ODocument))   return (ODatabaseDocumentTx)super.save(iRecord,iMode);
  final ODocument doc=(ODocument)iRecord;
  doc.validate();
  try {
    if (doc.getIdentity().isNew()) {
      if (doc.getClassName() != null)       checkSecurity(ODatabaseSecurityResources.CLASS,ORole.PERMISSION_CREATE,doc.getClassName());
      if (doc.getSchemaClass() != null && doc.getIdentity().getClusterId() < 0) {
        String clusterName=getClusterNameById(doc.getSchemaClass().getDefaultClusterId());
        super.save(doc,clusterName);
        return this;
      }
    }
 else {
      if (doc.getClassName() != null)       checkSecurity(ODatabaseSecurityResources.CLASS,ORole.PERMISSION_UPDATE,doc.getClassName());
    }
    super.save(doc,iMode);
  }
 catch (  OException e) {
    throw e;
  }
catch (  Exception e) {
    OLogManager.instance().exception("Error on saving record %s of class '%s'",e,ODatabaseException.class,iRecord.getIdentity(),(doc.getClassName() != null ? doc.getClassName() : "?"));
  }
  return this;
}
