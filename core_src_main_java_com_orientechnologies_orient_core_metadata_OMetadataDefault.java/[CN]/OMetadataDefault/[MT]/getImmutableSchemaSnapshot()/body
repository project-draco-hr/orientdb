{
  final ThreadLocalSchemaSnapshot schemaSnapshot=threadLocalSchemaSnapshot.get();
  OImmutableSchema immutableSchema=null;
  if (schemaSnapshot != null)   immutableSchema=schemaSnapshot.schema;
  if (immutableSchema != null)   return immutableSchema;
  if (schema == null)   return null;
  OImmutableSchema newSchema;
  do {
    immutableSchema=schemaCache.get();
    if (immutableSchema != null && immutableSchema.getVersion() == schema.getVersion()) {
      newSchema=immutableSchema;
      break;
    }
    newSchema=schema.makeSnapshot();
  }
 while (!schemaCache.compareAndSet(immutableSchema,newSchema));
  return newSchema;
}
