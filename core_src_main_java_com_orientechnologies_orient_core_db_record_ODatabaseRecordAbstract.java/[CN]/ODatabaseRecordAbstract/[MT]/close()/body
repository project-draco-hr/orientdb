{
  setCurrentDatabaseinThreadLocal();
  callOnCloseListeners();
  for (  ORecordHook h : hooks.keySet())   h.onUnregister();
  hooks.clear();
  if (metadata != null) {
    if (!(getStorage() instanceof OStorageProxy)) {
      final OIndexManager indexManager=metadata.getIndexManager();
      if (indexManager != null)       indexManager.waitTillIndexRestore();
    }
    if (metadata != null) {
      metadata.close();
      metadata=null;
    }
  }
  super.close();
  user=null;
  level1Cache.shutdown();
  ODatabaseRecordThreadLocal.INSTANCE.remove();
}
