{
  final Map<String,OProperty> props;
  final OClass clazz=document.getSchemaClass();
  if (clazz != null) {
    writeString(bytes,clazz.getName());
    props=clazz.propertiesMap();
  }
 else {
    writeEmptyString(bytes);
    props=null;
  }
  final String[] fields=document.fieldNames();
  final int[] pos=new int[fields.length];
  final OProperty[] properties=new OProperty[fields.length];
  int i=0;
  final Entry<String,?> values[]=new Entry[fields.length];
  for (  Entry<String,Object> entry : document) {
    if (props != null)     properties[i]=props.get(entry.getKey());
    if (properties[i] != null) {
      OVarIntSerializer.write(bytes,(properties[i].getId() + 1) * -1);
      if (properties[i].getType() != OType.ANY)       pos[i]=bytes.alloc(OIntegerSerializer.INT_SIZE);
 else       pos[i]=bytes.alloc(OIntegerSerializer.INT_SIZE + 1);
    }
 else {
      writeString(bytes,entry.getKey());
      pos[i]=bytes.alloc(OIntegerSerializer.INT_SIZE + 1);
    }
    values[i]=entry;
    i++;
  }
  writeEmptyString(bytes);
  for (i=0; i < values.length; i++) {
    int pointer=0;
    final Object value=values[i].getValue();
    if (value != null) {
      final OType type=getFieldType(document,values[i].getKey(),value,props);
      if (type == null)       continue;
      pointer=writeSingleValue(bytes,value,type,getLinkedType(document,type,values[i].getKey()));
      OIntegerSerializer.INSTANCE.serializeLiteral(pointer,bytes.bytes,pos[i]);
      if (properties[i] == null || properties[i].getType() == OType.ANY)       writeOType(bytes,(pos[i] + OIntegerSerializer.INT_SIZE),type);
    }
  }
}
