{
  if (iFields == null)   return null;
  Set<ODocument> changedDocuments=null;
  for (  Entry<String,Object> field : iFields.entrySet()) {
    final String fieldName=field.getKey();
    Object fieldValue=field.getValue();
    if (fieldValue != null) {
      if (fieldValue instanceof OCommandSQL) {
        final OCommandSQL cmd=(OCommandSQL)fieldValue;
        cmd.getContext().setParent(iContext);
        fieldValue=ODatabaseRecordThreadLocal.INSTANCE.get().command(cmd).execute();
        if (iDocument.getSchemaClass() != null) {
          final OProperty prop=iDocument.getSchemaClass().getProperty(fieldName);
          if (prop != null) {
            if (prop.getType() == OType.LINK) {
              if (OMultiValue.isMultiValue(fieldValue) && OMultiValue.getSize(fieldValue) == 1)               fieldValue=OMultiValue.getFirstValue(fieldValue);
            }
          }
        }
      }
    }
    final ODocument doc=iDocument.field(fieldName,resolveFieldValue(iDocument,fieldName,fieldValue,iArguments));
    if (doc != null) {
      if (changedDocuments == null)       changedDocuments=new HashSet<ODocument>();
      changedDocuments.add(doc);
    }
  }
  return changedDocuments;
}
