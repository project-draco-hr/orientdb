{
  final long timer=OProfiler.getInstance().startChrono();
  ORecordId rid=null;
  lock.acquireExclusiveLock();
  try {
    if (recordsToCommit.size() > 0) {
      for (      OTreeMapEntryPersistent<K,V> node : recordsToCommit) {
        if (!node.record.getIdentity().isValid()) {
          node.save();
        }
      }
      for (      OTreeMapEntryPersistent<K,V> node : recordsToCommit) {
        rid=(ORecordId)node.record.getIdentity();
        if (rid.isValid())         node.save();
      }
      recordsToCommit.clear();
    }
    if (record.isDirty())     save();
  }
 catch (  IOException e) {
    OLogManager.instance().error(this,"Error on saving the tree",e,ODatabaseException.class);
    database.rollback();
  }
 finally {
    lock.releaseExclusiveLock();
    OProfiler.getInstance().stopChrono("OTreeMapPersistent.commitChanges",timer);
  }
}
