{
synchronized (syncObject) {
    writeCache.close(fileId,flush);
    final Set<Long> pageIndexes=filePages.get(fileId);
    for (    Long pageIndex : pageIndexes) {
      OReadCacheEntry cacheEntry=get(fileId,pageIndex,true);
      if (cacheEntry != null) {
        if (cacheEntry.dataPointer != null) {
          if (cacheEntry.dataPointer.getUsagesCount() == 0)           cacheEntry=remove(fileId,pageIndex);
 else           throw new OStorageException("Page with index " + pageIndex + " for file with id "+ fileId+ "can not be freed because it is used.");
          cacheEntry.dataPointer.decrementReferrer();
        }
      }
 else {
        throw new OStorageException("Page with index " + pageIndex + " for file with id "+ fileId+ " was not found in cache");
      }
    }
    pageIndexes.clear();
  }
}
