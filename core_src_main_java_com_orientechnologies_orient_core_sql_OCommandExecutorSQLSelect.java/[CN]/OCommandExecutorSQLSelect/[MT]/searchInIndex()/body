{
  final OIndex<Object> index=(OIndex<Object>)getDatabase().getMetadata().getIndexManager().getIndex(compiledFilter.getTargetIndex());
  if (index == null)   throw new OCommandExecutionException("Target index '" + compiledFilter.getTargetIndex() + "' not found");
  if (index.getDefinition() == null)   return;
  if (compiledFilter.getRootCondition() != null) {
    if (!"KEY".equalsIgnoreCase(compiledFilter.getRootCondition().getLeft().toString()))     throw new OCommandExecutionException("'Key' field is required for queries against indexes");
    final OQueryOperator indexOperator=compiledFilter.getRootCondition().getOperator();
    if (indexOperator instanceof OQueryOperatorBetween) {
      final Object[] values=(Object[])compiledFilter.getRootCondition().getRight();
      final Collection<ODocument> entries=index.getEntriesBetween(getIndexKey(index.getDefinition(),values[0]),getIndexKey(index.getDefinition(),values[2]));
      for (      final OIdentifiable r : entries) {
        final boolean continueResultParsing=addResult(r);
        if (!continueResultParsing)         break;
      }
    }
 else     if (indexOperator instanceof OQueryOperatorMajor) {
      final Object value=compiledFilter.getRootCondition().getRight();
      final Collection<ODocument> entries=index.getEntriesMajor(getIndexKey(index.getDefinition(),value),false);
      parseIndexSearchResult(entries);
    }
 else     if (indexOperator instanceof OQueryOperatorMajorEquals) {
      final Object value=compiledFilter.getRootCondition().getRight();
      final Collection<ODocument> entries=index.getEntriesMajor(getIndexKey(index.getDefinition(),value),true);
      parseIndexSearchResult(entries);
    }
 else     if (indexOperator instanceof OQueryOperatorMinor) {
      final Object value=compiledFilter.getRootCondition().getRight();
      final Collection<ODocument> entries=index.getEntriesMinor(getIndexKey(index.getDefinition(),value),false);
      parseIndexSearchResult(entries);
    }
 else     if (indexOperator instanceof OQueryOperatorMinorEquals) {
      final Object value=compiledFilter.getRootCondition().getRight();
      final Collection<ODocument> entries=index.getEntriesMinor(getIndexKey(index.getDefinition(),value),true);
      parseIndexSearchResult(entries);
    }
 else     if (indexOperator instanceof OQueryOperatorIn) {
      final List<Object> origValues=(List<Object>)compiledFilter.getRootCondition().getRight();
      final List<Object> values=new ArrayList<Object>(origValues.size());
      for (      Object val : origValues) {
        if (index.getDefinition() instanceof OCompositeIndexDefinition) {
          throw new OCommandExecutionException("Operator IN not supported yet.");
        }
        val=getIndexKey(index.getDefinition(),val);
        values.add(val);
      }
      final Collection<ODocument> entries=index.getEntries(values);
      parseIndexSearchResult(entries);
    }
 else {
      final Object right=compiledFilter.getRootCondition().getRight();
      final Object keyValue=getIndexKey(index.getDefinition(),right);
      final Object res;
      if (index.getDefinition().getParamCount() == 1) {
        res=index.get(keyValue);
      }
 else {
        final Object secondKey=getIndexKey(index.getDefinition(),right);
        res=index.getValuesBetween(keyValue,secondKey);
      }
      if (res != null)       if (res instanceof Collection<?>)       for (      final OIdentifiable r : (Collection<OIdentifiable>)res)       addResult(createIndexEntryAsDocument(keyValue,r.getIdentity()));
 else       addResult(createIndexEntryAsDocument(keyValue,((OIdentifiable)res).getIdentity()));
    }
  }
 else {
    for (Iterator<Entry<Object,Object>> it=index.iterator(); it.hasNext(); ) {
      final Entry<Object,Object> current=it.next();
      if (current.getValue() instanceof Collection<?>)       for (Iterator<OIdentifiable> collIt=((OMVRBTreeRIDSet)current.getValue()).iterator(); collIt.hasNext(); )       addResult(createIndexEntryAsDocument(current.getKey(),collIt.next().getIdentity()));
 else       addResult(createIndexEntryAsDocument(current.getKey(),(OIdentifiable)current.getValue()));
    }
  }
  if (anyFunctionAggregates) {
    for (    final Entry<String,Object> projection : projections.entrySet()) {
      if (projection.getValue() instanceof OSQLFunctionRuntime) {
        final OSQLFunctionRuntime f=(OSQLFunctionRuntime)projection.getValue();
        f.setResult(index.getSize());
      }
    }
  }
}
