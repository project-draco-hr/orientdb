{
  try {
    while (active) {
      try {
        final Socket socket=serverSocket.accept();
        if (server.getDistributedManager() != null) {
          final ODistributedServerManager.NODE_STATUS nodeStatus=server.getDistributedManager().getNodeStatus();
          if (nodeStatus != ODistributedServerManager.NODE_STATUS.ONLINE) {
            OLogManager.instance().warn(this,"Distributed server is not yet ONLINE (status=%s), reject incoming connection from %s. If you are trying to shutdown the server, please kill the process",nodeStatus,socket.getRemoteSocketAddress());
            socket.close();
            Thread.sleep(100);
            continue;
          }
        }
        int conns=OClientConnectionManager.instance().getTotal();
        if (conns >= OGlobalConfiguration.NETWORK_MAX_CONCURRENT_SESSIONS.getValueAsInteger()) {
          OClientConnectionManager.instance().cleanExpiredConnections();
          conns=OClientConnectionManager.instance().getTotal();
          if (conns >= OGlobalConfiguration.NETWORK_MAX_CONCURRENT_SESSIONS.getValueAsInteger()) {
            OLogManager.instance().warn(this,"Reached maximum number of concurrent connections (%d), reject incoming connection from %s",conns,socket.getRemoteSocketAddress());
            socket.close();
            Thread.sleep(100);
            continue;
          }
        }
        socket.setPerformancePreferences(0,2,1);
        socket.setSendBufferSize(socketBufferSize);
        socket.setReceiveBufferSize(socketBufferSize);
        ONetworkProtocol protocol=protocolType.newInstance();
        protocol.config(this,server,socket,configuration);
      }
 catch (      Throwable e) {
        if (active)         OLogManager.instance().error(this,"Error on client connection",e);
      }
 finally {
      }
    }
  }
  finally {
    try {
      if (serverSocket != null && !serverSocket.isClosed())       serverSocket.close();
    }
 catch (    IOException ioe) {
    }
  }
}
