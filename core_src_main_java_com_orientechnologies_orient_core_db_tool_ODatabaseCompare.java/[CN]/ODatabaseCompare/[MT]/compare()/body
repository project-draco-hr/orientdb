{
  if (isDocumentDatabases() && (databaseDocumentTxOne == null || databaseDocumentTxTwo == null)) {
    listener.onMessage("\nPassed in URLs are related to document databases but credentials " + "were not provided to open them. Please provide user name + password for databases to compare");
    return false;
  }
  if (!isDocumentDatabases() && (databaseDocumentTxOne != null || databaseDocumentTxTwo != null)) {
    listener.onMessage("\nPassed in URLs are not related to document databases but credentials " + "were provided to open them. Please do not provide user name + password for databases to compare");
    return false;
  }
  try {
    ODocumentHelper.RIDMapper ridMapper=null;
    if (autoDetectExportImportMap) {
      listener.onMessage("\nAuto discovery of mapping between RIDs of exported and imported records is switched on, try to discover mapping data on disk.");
      exportImportHashTable=(OIndex<OIdentifiable>)databaseDocumentTxTwo.getMetadata().getIndexManager().getIndex(ODatabaseImport.EXPORT_IMPORT_MAP_NAME);
      if (exportImportHashTable != null) {
        listener.onMessage("\nMapping data were found and will be loaded.");
        ridMapper=new ODocumentHelper.RIDMapper(){
          @Override public ORID map(          ORID rid){
            if (rid == null)             return null;
            if (!rid.isPersistent())             return null;
            final OIdentifiable result=exportImportHashTable.get(rid);
            if (result == null)             return null;
            return result.getIdentity();
          }
        }
;
      }
 else       listener.onMessage("\nMapping data were not found.");
    }
    compareClusters();
    compareRecords(ridMapper);
    if (isDocumentDatabases())     compareIndexes(ridMapper);
    if (differences == 0) {
      listener.onMessage("\n\nDatabases match.");
      return true;
    }
 else {
      listener.onMessage("\n\nDatabases do not match. Found " + differences + " difference(s).");
      return false;
    }
  }
 catch (  Exception e) {
    OLogManager.instance().error(this,"Error on comparing database '%s' against '%s'",e,storage1.getName(),storage2.getName());
    throw new ODatabaseExportException("Error on comparing database '" + storage1.getName() + "' against '"+ storage2.getName()+ "'",e);
  }
 finally {
    storage1.close();
    storage2.close();
  }
}
