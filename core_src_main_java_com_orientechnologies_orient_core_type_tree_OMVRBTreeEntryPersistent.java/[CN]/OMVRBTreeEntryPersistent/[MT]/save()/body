{
  if (!record.isDirty())   return this;
  final boolean isNew=record.getIdentity().isNew();
  if (record.isDirty()) {
    record.setDatabase(ODatabaseRecordThreadLocal.INSTANCE.get());
    if (record.getDatabase() == null) {
      throw new IllegalStateException("Current thread has no database setted and the tree can't be saved correctly. Assure to close the database before the application if off.");
    }
    record.save(pTree.getClusterName());
  }
  if (isNew) {
    final ORecordId rid=(ORecordId)record.getIdentity();
    if (left != null) {
      left.parentRid=rid;
      left.markDirty();
    }
    if (right != null) {
      right.parentRid=rid;
      right.markDirty();
    }
    if (parent != null) {
      parentRid=parent.record.getIdentity();
      if (parent.left == this)       parent.leftRid=rid;
 else       if (parent.right == this)       parent.rightRid=rid;
      parent.markDirty();
    }
  }
  return this;
}
