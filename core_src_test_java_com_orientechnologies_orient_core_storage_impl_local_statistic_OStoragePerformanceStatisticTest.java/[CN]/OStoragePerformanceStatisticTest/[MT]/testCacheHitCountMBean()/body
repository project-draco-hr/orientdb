{
  final OStoragePerformanceStatistic storagePerformanceStatistic=new OStoragePerformanceStatistic(1024,"test",1,new OStoragePerformanceStatistic.NanoTimer(){
    private long counter=0;
    @Override public long getNano(){
      return counter+=100;
    }
  }
);
  storagePerformanceStatistic.registerMBean();
  final MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
  final ObjectName objectName=new ObjectName("com.orientechnologies.orient.core.storage.impl.local." + "statistic:type=OStoragePerformanceStatisticMXBean,name=test,id=1");
  Assert.assertTrue(mbs.isRegistered(objectName));
  storagePerformanceStatistic.registerMBean();
  final OStoragePerformanceStatisticMXBean mxBean=MBeanServerInvocationHandler.newProxyInstance(mbs,objectName,OStoragePerformanceStatisticMXBean.class,false);
  Assert.assertFalse(mxBean.isMeasurementEnabled());
  Assert.assertEquals(mxBean.getCacheHits(),-1);
  mxBean.startMeasurement();
  for (int i=0; i < 100; i++) {
    storagePerformanceStatistic.incrementPageAccessOnCacheLevel();
    if (i % 2 == 0)     storagePerformanceStatistic.incrementCacheHit();
  }
  Thread.sleep(2000);
  Assert.assertEquals(mxBean.getCacheHits(),50);
  mxBean.stopMeasurement();
  for (int i=0; i < 100; i++) {
    storagePerformanceStatistic.incrementPageAccessOnCacheLevel();
    storagePerformanceStatistic.incrementCacheHit();
  }
  Thread.sleep(2000);
  Assert.assertEquals(mxBean.getCacheHits(),50);
  Assert.assertFalse(mxBean.isMeasurementEnabled());
  storagePerformanceStatistic.unregisterMBean();
  Assert.assertFalse(mbs.isRegistered(objectName));
  storagePerformanceStatistic.unregisterMBean();
}
