{
  acquireExclusiveLock();
  try {
    this.storage=storageLocal;
    this.keyTypes=keyTypes;
    this.nullKeyIsSupported=nullKeyIsSupported;
    this.diskCache=storage.getDiskCache();
    if (this.diskCache == null)     throw new IllegalStateException("Disk cache was not initialized on storage level");
    this.name=name;
    init(storage);
    this.directory=new OHashTableDirectory(treeStateFileExtension,name,durableInNonTxMode,storage);
    startAtomicOperation();
    try {
      fileStateId=diskCache.openFile(name + metadataConfigurationFileExtension);
      logFileCreation(name + metadataConfigurationFileExtension,fileStateId);
      directory.create();
      hashStateEntry=diskCache.allocateNewPage(fileStateId);
      diskCache.pinPage(hashStateEntry);
      hashStateEntry.acquireExclusiveLock();
      try {
        OHashIndexFileLevelMetadataPage page=new OHashIndexFileLevelMetadataPage(hashStateEntry,getTrackMode(),true);
        createFileMetadata(0,page);
        hashStateEntry.markDirty();
        logPageChanges(page,hashStateEntry.getFileId(),hashStateEntry.getPageIndex(),true);
      }
  finally {
        hashStateEntry.releaseExclusiveLock();
        diskCache.release(hashStateEntry);
      }
      setKeySerializer(keySerializer);
      setValueSerializer(valueSerializer);
      initHashTreeState();
      if (nullKeyIsSupported) {
        nullBucketFileId=diskCache.openFile(name + nullBucketFileExtension);
        logFileCreation(name + nullBucketFileExtension,nullBucketFileId);
      }
      endAtomicOperation(false);
    }
 catch (    IOException e) {
      endAtomicOperation(true);
      throw e;
    }
catch (    RuntimeException e) {
      endAtomicOperation(true);
      throw e;
    }
  }
 catch (  IOException e) {
    throw new OIndexException("Error during local hash table creation.",e);
  }
 finally {
    releaseExclusiveLock();
  }
}
