{
  OScenarioThreadLocal.INSTANCE.set(OScenarioThreadLocal.RUN_MODE.RUNNING_DISTRIBUTED);
  try {
    final OAbstractRemoteTask task=iRequest.getTask();
    if (ODistributedServerLog.isDebugEnabled())     ODistributedServerLog.debug(this,manager.getLocalNodeName(),iRequest.getSenderNodeName(),DIRECTION.OUT,"received request: %s",iRequest);
    Serializable responsePayload;
    OSecurityUser origin=null;
    try {
      for (int retry=1; ; ++retry) {
        if (task.isRequiredOpenDatabase())         initDatabaseInstance();
        database.activateOnCurrentThread();
        task.setNodeSource(iRequest.getSenderNodeName());
        if (database != null) {
          origin=database.getUser();
          try {
            if (lastUser == null || !(lastUser.getIdentity()).equals(iRequest.getUserRID()))             lastUser=database.getMetadata().getSecurity().getUser(iRequest.getUserRID());
            database.setUser(lastUser);
          }
 catch (          Throwable ex) {
            OLogManager.instance().error(this,"Failed on user switching " + ex.getMessage());
          }
        }
        responsePayload=manager.executeOnLocalNode(iRequest,database);
        if (responsePayload instanceof OModificationOperationProhibitedException) {
          OLogManager.instance().info(this,"Database is locked on current node (backup is running?) retrying to execute the operation (retry=%d)",retry);
          try {
            Thread.sleep(1000);
          }
 catch (          InterruptedException e) {
          }
        }
 else         break;
      }
    }
  finally {
      if (database != null && !database.isClosed()) {
        database.activateOnCurrentThread();
        database.rollback();
        database.getLocalCache().clear();
        database.setUser(origin);
      }
    }
    sendResponseBack(iRequest,task,responsePayload);
  }
  finally {
    OScenarioThreadLocal.INSTANCE.set(OScenarioThreadLocal.RUN_MODE.DEFAULT);
  }
}
