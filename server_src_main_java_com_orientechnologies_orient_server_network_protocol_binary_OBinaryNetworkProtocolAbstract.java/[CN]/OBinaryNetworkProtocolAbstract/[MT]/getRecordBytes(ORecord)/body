{
  final byte[] stream;
  try {
    String dbSerializerName=null;
    if (ODatabaseRecordThreadLocal.INSTANCE.getIfDefined() != null)     dbSerializerName=((ODatabaseDocumentInternal)iRecord.getDatabase()).getSerializer().toString();
    String name=getRecordSerializerName();
    if (ORecordInternal.getRecordType(iRecord) == ODocument.RECORD_TYPE && (dbSerializerName == null || !dbSerializerName.equals(name))) {
      ORecordSerializer ser=ORecordSerializerFactory.instance().getFormat(dbSerializerName);
      ONetworkThreadLocalSerializer.setNetworkSerializer(ser);
      ((ODocument)iRecord).deserializeFields();
      ser=ORecordSerializerFactory.instance().getFormat(name);
      ONetworkThreadLocalSerializer.setNetworkSerializer(ser);
    }
    stream=iRecord.toStream();
  }
  finally {
    ONetworkThreadLocalSerializer.setNetworkSerializer(null);
  }
  return stream;
}
