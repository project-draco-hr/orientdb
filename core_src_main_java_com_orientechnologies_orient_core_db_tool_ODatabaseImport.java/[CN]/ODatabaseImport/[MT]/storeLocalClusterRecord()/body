{
  long nextAvailablePos=database.getStorage().getClusterDataRange(record.getIdentity().getClusterId())[1].longValue() + 1;
  if (record.getIdentity().getClusterPosition().longValue() < nextAvailablePos) {
    record.getRecordVersion().setRollbackMode();
    if (record instanceof ODocument)     record.save();
 else     ((ODatabaseRecord)database.getUnderlying()).save(record);
  }
 else {
    String clusterName=database.getClusterNameById(record.getIdentity().getClusterId());
    if (record.getIdentity().getClusterPosition().longValue() > nextAvailablePos) {
      int holes=(int)(record.getIdentity().getClusterPosition().longValue() - nextAvailablePos);
      ODocument tempRecord=new ODocument();
      for (int i=0; i < holes; ++i) {
        tempRecord.reset();
        ((ODatabaseRecord)database.getUnderlying()).save(tempRecord,clusterName);
        recordToDelete.add(tempRecord.getIdentity().toString());
      }
    }
    record.setIdentity(-1,ORecordId.CLUSTER_POS_INVALID);
    if (record instanceof ODocument)     record.save(clusterName);
 else     ((ODatabaseRecord)database.getUnderlying()).save(record,clusterName);
  }
}
