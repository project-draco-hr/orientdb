{
  setDataCommandInfo("Transaction commit");
  if (!isConnectionAlive())   return;
  final OTransactionOptimisticProxy tx=new OTransactionOptimisticProxy(connection.database,channel,connection.data.protocolVersion,this);
  try {
    connection.database.begin(tx);
    try {
      connection.database.commit();
      beginResponse();
      try {
        sendOk(clientTxId);
        channel.writeInt(tx.getCreatedRecords().size());
        for (        Entry<ORecordId,ORecord> entry : tx.getCreatedRecords().entrySet()) {
          channel.writeRID(entry.getKey());
          channel.writeRID(entry.getValue().getIdentity());
          if (entry.getValue().getVersion() > 0)           tx.getUpdatedRecords().put((ORecordId)entry.getValue().getIdentity(),entry.getValue());
        }
        channel.writeInt(tx.getUpdatedRecords().size());
        for (        Entry<ORecordId,ORecord> entry : tx.getUpdatedRecords().entrySet()) {
          channel.writeRID(entry.getKey());
          channel.writeVersion(entry.getValue().getVersion());
        }
        if (connection.data.protocolVersion >= 20)         sendCollectionChanges();
      }
  finally {
        endResponse();
      }
    }
 catch (    Exception e) {
      if (connection != null && connection.database != null) {
        if (connection.database.getTransaction().isActive())         connection.database.rollback(true);
        final OSBTreeCollectionManager collectionManager=connection.database.getSbTreeCollectionManager();
        if (collectionManager != null)         collectionManager.clearChangedIds();
      }
      sendErrorOrDropConnection(clientTxId,e);
    }
  }
 catch (  OTransactionAbortedException e) {
  }
catch (  Exception e) {
    if (tx.isActive())     tx.rollback(true,-1);
    sendErrorOrDropConnection(clientTxId,e);
  }
}
