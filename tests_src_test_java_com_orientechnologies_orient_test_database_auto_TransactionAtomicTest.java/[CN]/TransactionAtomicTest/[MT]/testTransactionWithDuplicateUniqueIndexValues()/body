{
  OClass fruitClass=database.getMetadata().getSchema().getClass("Fruit");
  if (fruitClass == null) {
    fruitClass=database.getMetadata().getSchema().createClass("Fruit");
    fruitClass.createProperty("name",OType.STRING);
    fruitClass.createProperty("color",OType.STRING);
    database.getMetadata().getSchema().getClass("Fruit").getProperty("color").createIndex(OClass.INDEX_TYPE.UNIQUE);
  }
  Assert.assertEquals(database.countClusterElements("Fruit"),0);
  try {
    database.begin();
    ODocument apple=new ODocument("Fruit").field("name","Apple").field("color","Red");
    ODocument orange=new ODocument("Fruit").field("name","Orange").field("color","Orange");
    ODocument banana=new ODocument("Fruit").field("name","Banana").field("color","Yellow");
    ODocument kumquat=new ODocument("Fruit").field("name","Kumquat").field("color","Orange");
    apple.save();
    Assert.assertEquals(apple.getIdentity().getClusterId(),fruitClass.getDefaultClusterId());
    orange.save();
    Assert.assertEquals(orange.getIdentity().getClusterId(),fruitClass.getDefaultClusterId());
    banana.save();
    Assert.assertEquals(banana.getIdentity().getClusterId(),fruitClass.getDefaultClusterId());
    kumquat.save();
    Assert.assertEquals(kumquat.getIdentity().getClusterId(),fruitClass.getDefaultClusterId());
    database.commit();
    Assert.assertTrue(false);
  }
 catch (  OResponseProcessingException e) {
    Assert.assertTrue(e.getCause() instanceof ORecordDuplicatedException);
    database.rollback();
  }
catch (  ORecordDuplicatedException e) {
    Assert.assertTrue(true);
    database.rollback();
  }
  Assert.assertEquals(database.countClusterElements("Fruit"),0);
}
