{
  ODatabaseDocumentTx db=(ODatabaseDocumentTx)database.getUnderlying();
  database.getMetadata().getSchema().createClass("ManualIndexTxRecursiveStoreClass");
  OIndexManager idxManager=db.getMetadata().getIndexManager();
  idxManager.createIndex("manualTxIndexRecursiveStoreTest","UNIQUE",new OSimpleKeyIndexDefinition(OType.INTEGER),null,null);
  OIndex<OIdentifiable> idx=(OIndex<OIdentifiable>)idxManager.getIndex("manualTxIndexRecursiveStoreTest");
  ODocument v0=new ODocument("ManualIndexTxRecursiveStoreClass");
  v0.field("counter",0);
  v0.save();
  idx.put(0,v0);
  Assert.assertTrue(idx.contains(0));
  db.begin(OTransaction.TXTYPE.OPTIMISTIC);
  ODocument v=new ODocument("ManualIndexTxRecursiveStoreClass");
  v.field("counter",52);
  ODocument v2=new ODocument("ManualIndexTxRecursiveStoreClass");
  v2.field("counter",54);
  v2.field("link",v);
  v2.save();
  v.field("link",v2);
  v.save();
  Assert.assertNotNull(idx);
  idx.remove(0);
  idx.put(52,v);
  idx.put(54,v2);
  db.commit();
  Assert.assertTrue(idx.contains(52));
  Assert.assertTrue(idx.contains(54));
  Assert.assertFalse(idx.contains(0));
  Assert.assertTrue(idx.get(52).getIdentity().isPersistent());
  Assert.assertEquals(idx.get(52).getIdentity(),v.getIdentity());
  Assert.assertTrue(idx.get(54).getIdentity().isPersistent());
  Assert.assertEquals(idx.get(54).getIdentity(),v2.getIdentity());
}
