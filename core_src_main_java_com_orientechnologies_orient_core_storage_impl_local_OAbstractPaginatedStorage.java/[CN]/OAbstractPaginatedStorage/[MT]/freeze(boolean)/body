{
  checkOpeness();
  stateLock.acquireReadLock();
  try {
    checkOpeness();
    final long freezeId;
    if (throwException)     freezeId=atomicOperationsManager.freezeAtomicOperations(OModificationOperationProhibitedException.class,"Modification requests are prohibited");
 else     freezeId=atomicOperationsManager.freezeAtomicOperations(null,null);
    synch();
    try {
      unlock();
      writeCache.setSoftlyClosed(true);
      if (configuration != null)       configuration.setSoftlyClosed(true);
    }
 catch (    IOException e) {
      atomicOperationsManager.releaseAtomicOperations(freezeId);
      try {
        lock();
      }
 catch (      IOException ignored) {
      }
      throw new OStorageException("Error on freeze of storage '" + name + "'",e);
    }
  }
  finally {
    stateLock.releaseReadLock();
  }
}
