{
  checkForRebuild();
  final ODatabase database=getDatabase();
  final boolean txIsActive=database.getTransaction().isActive();
  if (!txIsActive)   keyLockManager.lockAllExclusive();
  try {
    modificationLock.requestModificationLock();
    try {
      acquireSharedLock();
      try {
        markStorageDirty();
        indexEngine.clear();
        return this;
      }
  finally {
        releaseSharedLock();
      }
    }
  finally {
      modificationLock.releaseModificationLock();
    }
  }
  finally {
    if (!txIsActive)     keyLockManager.unlockAllExclusive();
  }
}
