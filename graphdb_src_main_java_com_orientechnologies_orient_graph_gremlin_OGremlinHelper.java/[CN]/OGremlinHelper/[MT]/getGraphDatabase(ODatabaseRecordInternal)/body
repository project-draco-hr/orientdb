{
  ODatabaseRecordInternal currentDb=ODatabaseRecordThreadLocal.INSTANCE.get();
  if (currentDb == null && iCurrentDatabase != null)   currentDb=iCurrentDatabase;
  currentDb=(ODatabaseRecordInternal)currentDb.getDatabaseOwner();
  final ODatabaseDocumentTx db;
  if (currentDb instanceof ODatabaseDocumentTx)   db=(ODatabaseDocumentTx)currentDb;
 else   if (currentDb instanceof ODatabaseDocumentTx) {
    db=new ODatabaseDocumentTx((ODatabaseRecordTx)currentDb.getUnderlying());
    ODatabaseRecordThreadLocal.INSTANCE.set(db);
  }
 else   if (currentDb instanceof ODatabaseRecordTx) {
    db=new ODatabaseDocumentTx((ODatabaseRecordTx)currentDb);
    ODatabaseRecordThreadLocal.INSTANCE.set(db);
  }
 else   throw new OCommandExecutionException("Cannot find a database of type ODatabaseDocumentTx or ODatabaseRecordTx");
  return db;
}
