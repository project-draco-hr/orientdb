{
  if (!(iRecord instanceof ODocument))   throw new OSerializationException("Can't marshall a record of type " + iRecord.getClass().getSimpleName() + " to CSV");
  final ODocument record=(ODocument)iRecord;
  if (iMarshalledRecords.containsKey(record)) {
    return "-";
  }
 else   iMarshalledRecords.put(record,ORecordId.EMPTY_RECORD_ID);
  ODatabaseRecord<?> database=record.getDatabase();
  final StringBuilder buffer=new StringBuilder();
  if (record.getClassName() != null) {
    buffer.append(record.getClassName());
    buffer.append(OStringSerializerHelper.CLASS_SEPARATOR);
  }
  OProperty prop;
  Object fieldValue;
  OType type;
  OClass linkedClass;
  OType linkedType;
  String fieldClassName;
  int i=0;
  for (  Entry<String,Object> f : record) {
    if (i > 0)     buffer.append(OStringSerializerHelper.RECORD_SEPARATOR);
    prop=record.getSchemaClass() != null ? record.getSchemaClass().getProperty(f.getKey()) : null;
    fieldValue=f.getValue();
    fieldClassName=getClassName(fieldValue);
    type=record.fieldType(f.getKey());
    linkedClass=null;
    linkedType=null;
    if (prop != null) {
      type=prop.getType();
      linkedClass=prop.getLinkedClass();
      linkedType=prop.getLinkedType();
    }
 else     if (fieldValue != null) {
      if (fieldValue instanceof Collection<?> || fieldValue.getClass().isArray()) {
        Collection<?> coll=fieldValue instanceof Collection<?> ? (Collection<?>)fieldValue : null;
        int size=coll != null ? coll.size() : Array.getLength(fieldValue);
        if (size > 0) {
          Object firstValue=coll != null ? coll.iterator().next() : Array.get(fieldValue,0);
          if (database != null && (firstValue instanceof ORID || firstValue instanceof ORecordSchemaAware<?> || (database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(getClassName(firstValue)) != null))) {
            linkedClass=getLinkInfo(database,getClassName(firstValue));
            if (type == null) {
              linkedType=OType.LINK;
              if (coll instanceof Set<?>)               type=OType.LINKSET;
 else               type=OType.LINKLIST;
            }
 else             linkedType=OType.EMBEDDED;
          }
 else {
            linkedType=OType.getTypeByAssignability(firstValue.getClass());
            if (linkedType != OType.LINK) {
              if (linkedType == null) {
                linkedType=OType.EMBEDDED;
                linkedClass=new OClass(firstValue.getClass());
              }
              if (type == null)               if (coll instanceof Set<?>)               type=OType.EMBEDDEDSET;
 else               type=OType.EMBEDDEDLIST;
            }
          }
        }
 else         if (type == null)         type=OType.EMBEDDEDLIST;
      }
 else       if (fieldValue instanceof Map<?,?>) {
        if (type == null)         type=OType.EMBEDDEDMAP;
        Map<?,?> map=(Map<?,?>)fieldValue;
        if (map.size() > 0) {
          Object firstValue=map.values().iterator().next();
          if (database != null && (firstValue instanceof ORecordSchemaAware<?> || (database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(getClassName(firstValue)) != null))) {
            linkedType=OType.LINK;
            linkedClass=getLinkInfo(database,getClassName(firstValue));
          }
 else           linkedType=OType.getTypeByClass(firstValue.getClass());
        }
      }
 else       if (database != null && fieldValue instanceof ORecordSchemaAware<?>) {
        if (type == null)         type=OType.LINK;
        linkedClass=getLinkInfo(database,fieldClassName);
      }
 else       if (database != null && database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(fieldClassName) != null) {
        if (type == null)         type=OType.LINK;
        linkedClass=getLinkInfo(database,fieldClassName);
      }
 else       if (fieldValue instanceof Date) {
        if (type == null)         type=OType.DATE;
      }
 else       if (fieldValue instanceof String)       type=OType.STRING;
    }
    if (type == null)     type=OType.EMBEDDED;
    fieldValue=fieldToStream((ODocument)iRecord,iRecord.getDatabase(),iObjHandler,type,linkedClass,linkedType,f.getKey(),f.getValue(),iMarshalledRecords);
    buffer.append(f.getKey());
    buffer.append(FIELD_VALUE_SEPARATOR);
    if (fieldValue != null)     buffer.append(fieldValue);
    i++;
  }
  return buffer.toString();
}
