{
  clear();
  long documentIndexed=0;
  final boolean intentInstalled=getDatabase().declareIntent(new OIntentMassiveInsert());
  acquireExclusiveLock();
  try {
    int documentNum=0;
    long documentTotal=0;
    for (    String cluster : clustersToIndex)     documentTotal+=getDatabase().countClusterElements(cluster);
    if (iProgressListener != null)     iProgressListener.onBegin(this,documentTotal);
    for (    String clusterName : clustersToIndex)     for (    ORecord<?> record : getDatabase().browseCluster(clusterName)) {
      if (record instanceof ODocument) {
        final ODocument doc=(ODocument)record;
        final Object fieldValue=callback.getDocumentValueToIndex(doc);
        if (fieldValue != null) {
          put(fieldValue,doc);
          ++documentIndexed;
        }
      }
      documentNum++;
      if (iProgressListener != null)       iProgressListener.onProgress(this,documentNum,documentNum * 100f / documentTotal);
    }
    lazySave();
    if (iProgressListener != null)     iProgressListener.onCompletition(this,true);
  }
 catch (  Exception e) {
    if (iProgressListener != null)     iProgressListener.onCompletition(this,false);
    clear();
    throw new OIndexException("Error on rebuilding the index for clusters: " + clustersToIndex,e);
  }
 finally {
    if (intentInstalled)     getDatabase().declareIntent(null);
    releaseExclusiveLock();
  }
  return documentIndexed;
}
