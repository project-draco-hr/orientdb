{
  filesLock.acquireWriteLock();
  try {
    initNameIdMapping();
    OFileClassic fileClassic;
    Long existingFileId=nameIdMap.get(fileName);
    if (existingFileId != null) {
      if (existingFileId == fileId)       throw new OStorageException("File with name " + fileName + " already exists in storage "+ storageLocal.getName());
 else       throw new OStorageException("File with given name already exists but has different id " + existingFileId + " vs. proposed "+ fileId);
    }
    fileClassic=files.get(fileId);
    if (fileClassic != null)     throw new OStorageException("File with given id exists but has different name " + fileClassic.getName() + " vs. proposed "+ fileName);
    if (fileCounter < fileId)     fileCounter=fileId;
    fileClassic=createFile(fileName);
    files.put(fileId,fileClassic);
    nameIdMap.put(fileName,fileId);
    writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    addFile(fileClassic);
  }
  finally {
    filesLock.releaseWriteLock();
  }
}
