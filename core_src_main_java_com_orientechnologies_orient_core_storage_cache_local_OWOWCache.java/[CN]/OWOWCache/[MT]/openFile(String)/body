{
  filesLock.acquireWriteLock();
  try {
    initNameIdMapping();
    Integer fileId=nameIdMap.get(fileName);
    OFileClassic fileClassic;
    if (fileId == null || fileId < 0)     fileClassic=null;
 else     fileClassic=files.get(fileId);
    if (fileClassic == null) {
      fileClassic=createFile(fileName);
      if (!fileClassic.exists())       throw new OStorageException("File with name " + fileName + " does not exist in storage "+ storageLocal.getName());
 else {
        OLogManager.instance().error(this,"File " + fileName + " is not registered in 'file name - id' map but exists in file system, "+ "probably you work in distributed storage. If it is not true, please create bug in bug tracker https://github.com/orientechnologies/orientdb/issues .");
        if (fileId == null) {
          ++fileCounter;
          fileId=fileCounter;
        }
 else         fileId=-fileId;
        files.put(fileId,fileClassic);
        nameIdMap.put(fileName,fileId);
        writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
      }
    }
    openFile(fileClassic);
    return composeFileId(id,fileId);
  }
  finally {
    filesLock.releaseWriteLock();
  }
}
