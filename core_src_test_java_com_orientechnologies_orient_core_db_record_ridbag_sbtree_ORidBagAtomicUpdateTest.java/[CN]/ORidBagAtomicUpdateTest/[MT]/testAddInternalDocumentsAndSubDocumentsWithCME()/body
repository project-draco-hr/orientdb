{
  final ODocument cmeDoc=new ODocument();
  cmeDoc.save();
  db.begin();
  ODocument rootDoc=new ODocument();
  ORidBag ridBag=new ORidBag();
  rootDoc.field("ridBag",ridBag);
  ODocument docOne=new ODocument();
  docOne.save();
  ODocument docTwo=new ODocument();
  docTwo.save();
  ridBag.add(docOne);
  ridBag.add(docTwo);
  rootDoc.save();
  db.commit();
  long recordsCount=db.countClusterElements(db.getDefaultClusterId());
  rootDoc=db.load(rootDoc.getIdentity());
  ridBag=rootDoc.field("ridBag");
  ODocument staleCMEDoc=db.load(cmeDoc.getIdentity());
  Assert.assertNotSame(staleCMEDoc,cmeDoc);
  cmeDoc.field("v","v");
  cmeDoc.save();
  db.begin();
  ODocument docThree=new ODocument();
  docThree.save();
  ODocument docFour=new ODocument();
  docFour.save();
  ridBag.add(docThree);
  ridBag.add(docFour);
  rootDoc.save();
  ODocument docThreeOne=new ODocument();
  docThreeOne.save();
  ODocument docThreeTwo=new ODocument();
  docThreeTwo.save();
  ORidBag ridBagThree=new ORidBag();
  ridBagThree.add(docThreeOne);
  ridBagThree.add(docThreeTwo);
  docThree.field("ridBag",ridBagThree);
  docThree.save();
  ODocument docFourOne=new ODocument();
  docFourOne.save();
  ODocument docFourTwo=new ODocument();
  docFourTwo.save();
  ORidBag ridBagFour=new ORidBag();
  ridBagFour.add(docFourOne);
  ridBagFour.add(docFourTwo);
  docFour.field("ridBag",ridBagFour);
  docFour.save();
  staleCMEDoc.field("v","vn");
  staleCMEDoc.save();
  try {
    db.commit();
    Assert.fail();
  }
 catch (  OConcurrentModificationException e) {
  }
  Assert.assertEquals(db.countClusterElements(db.getDefaultClusterId()),recordsCount);
  List<OIdentifiable> addedDocs=new ArrayList<OIdentifiable>(Arrays.asList(docOne,docTwo));
  rootDoc=db.load(rootDoc.getIdentity());
  ridBag=rootDoc.field("ridBag");
  Iterator<OIdentifiable> iterator=ridBag.iterator();
  Assert.assertTrue(addedDocs.remove(iterator.next()));
  Assert.assertTrue(addedDocs.remove(iterator.next()));
}
