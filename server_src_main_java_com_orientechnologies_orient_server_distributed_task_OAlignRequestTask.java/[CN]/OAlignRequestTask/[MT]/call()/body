{
  if (lastRunId == -1 && lastOperationId == -1)   ODistributedServerLog.info(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.IN,"db=%s align request starting from the beginning (no log found)",databaseName);
 else   ODistributedServerLog.info(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.IN,"db=%s align request starting from operation %d.%d",databaseName,lastRunId,lastOperationId);
  int totAligned;
  final ODistributedServerManager dManager=getDistributedServerManager();
  final String localNode=dManager.getLocalNodeId();
  final OStorageSynchronizer synchronizer=getDatabaseSynchronizer();
  if (synchronizer == null)   return 0;
  final ODatabaseJournal log=synchronizer.getLog();
  final Lock alignmentLock=dManager.getLock("align." + databaseName);
  if (alignmentLock.tryLock())   try {
    totAligned=0;
    int aligned=0;
    ODistributedServerLog.warn(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.OUT,"****** BEGIN PREPARING ALIGNMENT BLOCK db=%s ******",databaseName);
    final OMultipleRemoteTasks tasks=new OMultipleRemoteTasks(serverInstance,dManager,databaseName,EXECUTION_MODE.SYNCHRONOUS);
    final List<Long> positions=new ArrayList<Long>();
    final Iterator<Long> it=log.browseLastOperations(new long[]{lastRunId,lastOperationId},ODatabaseJournal.OPERATION_STATUS.COMMITTED,-1);
    while (it.hasNext()) {
      final long pos=it.next();
      final OAbstractReplicatedTask<?> operation=log.getOperation(pos);
      if (operation == null) {
        ODistributedServerLog.info(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.OUT,"#%d db=%s skipped operation",aligned,databaseName);
        continue;
      }
      ODistributedServerLog.info(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.OUT,"#%d aligning operation=%d.%d db=%s %s",aligned,operation.getRunId(),operation.getOperationSerial(),databaseName,operation);
      operation.setNodeSource(localNode);
      operation.setDatabaseName(databaseName);
      tasks.addTask(operation);
      positions.add(pos);
      aligned++;
      if (tasks.getTasks() >= OP_BUFFER)       totAligned+=flushBufferedTasks(dManager,synchronizer,tasks,positions);
    }
    if (tasks.getTasks() > 0)     totAligned+=flushBufferedTasks(dManager,synchronizer,tasks,positions);
    ODistributedServerLog.warn(this,getDistributedServerManager().getLocalNodeId(),getNodeSource(),DIRECTION.OUT,"****** END PREPARING ALIGNMENT BLOCK db=%s total=%d ******",databaseName,totAligned);
  }
  finally {
    alignmentLock.unlock();
  }
 else   totAligned=-1;
  dManager.sendTask2Node(getNodeSource(),new OAlignResponseTask(serverInstance,dManager,databaseName,totAligned),EXECUTION_MODE.ASYNCHRONOUS,new HashMap<String,Object>());
  return totAligned;
}
