{
  ORawBuffer recordBuffer;
  long positionInPhyCluster;
  try {
    if (iLockEntireCluster)     cluster.lock();
    OClusterPositionIterator iterator=cluster.absoluteIterator(iBeginRange,iEndRange);
    while (iterator.hasNext()) {
      positionInPhyCluster=iterator.next();
      if (positionInPhyCluster == -1)       continue;
      recordBuffer=cache.getRecord(ORecordId.generateString(cluster.getId(),positionInPhyCluster));
      if (recordBuffer == null) {
        recordBuffer=readRecord(iRequesterId,cluster,positionInPhyCluster,!iLockEntireCluster);
        if (recordBuffer == null)         continue;
      }
      if (recordBuffer.recordType != ODocument.RECORD_TYPE && recordBuffer.recordType != ORecordColumn.RECORD_TYPE)       continue;
      if (ioRecord == null)       ioRecord=ORecordFactory.newInstance(recordBuffer.recordType);
 else       if (ioRecord.getRecordType() != recordBuffer.recordType) {
        final ORecordInternal<?> newRecord=ORecordFactory.newInstance(recordBuffer.recordType);
        newRecord.setDatabase(ioRecord.getDatabase());
        ioRecord=newRecord;
      }
 else       ioRecord.reset();
      ioRecord.setVersion(recordBuffer.version);
      ioRecord.setIdentity(cluster.getId(),positionInPhyCluster);
      ioRecord.fromStream(recordBuffer.buffer);
      if (!iListener.foreach(ioRecord))       break;
    }
  }
  finally {
    if (iLockEntireCluster)     cluster.unlock();
  }
  return ioRecord;
}
