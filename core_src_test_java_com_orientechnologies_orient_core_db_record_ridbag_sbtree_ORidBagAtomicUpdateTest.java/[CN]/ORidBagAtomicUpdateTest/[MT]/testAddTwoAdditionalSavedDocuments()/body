{
  database.begin();
  ODocument rootDoc=new ODocument();
  ORidBag ridBag=new ORidBag();
  rootDoc.field("ridBag",ridBag);
  ODocument docOne=new ODocument();
  ODocument docTwo=new ODocument();
  ridBag.add(docOne);
  ridBag.add(docTwo);
  rootDoc.save();
  database.commit();
  long recordsCount=database.countClusterElements(database.getDefaultClusterId());
  rootDoc=database.load(rootDoc.getIdentity());
  ridBag=rootDoc.field("ridBag");
  database.begin();
  ODocument docThree=new ODocument();
  docThree.save();
  ODocument docFour=new ODocument();
  docFour.save();
  ridBag.add(docThree);
  ridBag.add(docFour);
  rootDoc.save();
  database.rollback();
  Assert.assertEquals(database.countClusterElements(database.getDefaultClusterId()),recordsCount);
  rootDoc=database.load(rootDoc.getIdentity());
  ridBag=rootDoc.field("ridBag");
  Assert.assertEquals(ridBag.size(),2);
  List<OIdentifiable> addedDocs=new ArrayList<OIdentifiable>(Arrays.asList(docOne,docTwo));
  Iterator<OIdentifiable> iterator=ridBag.iterator();
  Assert.assertTrue(addedDocs.remove(iterator.next()));
  Assert.assertTrue(addedDocs.remove(iterator.next()));
}
