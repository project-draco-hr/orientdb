{
  final String[] parts=checkSyntax(iRequest.url,3,"Syntax error: function/<database>/<name>[/param]*");
  iRequest.data.commandInfo="Execute a function";
  ODatabaseDocumentTx db=null;
  Object result=null;
  try {
    db=getProfiledDatabaseInstance(iRequest);
    db.getMetadata().getFunctionLibrary().load();
    final OFunction f=db.getMetadata().getFunctionLibrary().getFunction(parts[2]);
    if (f == null)     throw new IllegalArgumentException("Function '" + parts[2] + "' is not configured");
    if (iRequest.httpMethod.equalsIgnoreCase("GET") && !f.isIdempotent()) {
      iResponse.sendTextContent(OHttpUtils.STATUS_BADREQ_CODE,OHttpUtils.STATUS_BADREQ_DESCRIPTION,null,OHttpUtils.CONTENT_TEXT_PLAIN,"GET method is not allowed to execute function '" + parts[2] + "' because has been declared as non idempotent. Use POST instead.",true);
      return false;
    }
    final Object[] args=new Object[parts.length - 3];
    for (int i=3; i < parts.length; ++i)     args[i - 3]=parts[i];
    final Map<String,Object> context=new HashMap<String,Object>();
    context.put("request",new OHttpRequestWrapper(iRequest));
    context.put("response",new OHttpResponseWrapper(iResponse));
    result=f.executeInContext(context,args);
    if (result != null) {
      if (result instanceof ODocument && ((ODocument)result).isEmbedded()) {
        iResponse.sendTextContent(OHttpUtils.STATUS_OK_CODE,OHttpUtils.STATUS_OK_DESCRIPTION,null,OHttpUtils.CONTENT_JSON,((ODocument)result).toJSON(),true);
      }
 else       iResponse.sendTextContent(OHttpUtils.STATUS_OK_CODE,OHttpUtils.STATUS_OK_DESCRIPTION,null,OHttpUtils.CONTENT_TEXT_PLAIN,result,true);
    }
 else     iResponse.sendTextContent(OHttpUtils.STATUS_OK_NOCONTENT_CODE,"",null,OHttpUtils.CONTENT_TEXT_PLAIN,null,true);
  }
 catch (  OCommandScriptException e) {
    final StringBuilder msg=new StringBuilder();
    for (Exception currentException=e; currentException != null; currentException=(Exception)currentException.getCause()) {
      if (msg.length() > 0)       msg.append("\n");
      msg.append(currentException.getMessage());
    }
    iResponse.sendTextContent(OHttpUtils.STATUS_BADREQ_CODE,OHttpUtils.STATUS_BADREQ_DESCRIPTION,null,OHttpUtils.CONTENT_TEXT_PLAIN,msg.toString(),true);
  }
 finally {
    if (db != null)     OSharedDocumentDatabase.release(db);
  }
  return false;
}
