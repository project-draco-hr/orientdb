{
  try {
    final StringWriter buffer=new StringWriter();
    final OJSONWriter json=new OJSONWriter(buffer,iFormat);
    final FormatSettings settings=new FormatSettings(iFormat);
    json.beginObject(settings.indentLevel);
    OJSONFetchContext context=new OJSONFetchContext(json,settings);
    context.writeSignature(json,iRecord);
    if (iRecord instanceof ORecordSchemaAware<?>) {
      OFetchHelper.fetch(iRecord,null,OFetchHelper.buildFetchPlan(settings.fetchPlan),new OJSONFetchListener(),context);
    }
 else     if (iRecord instanceof ORecordStringable) {
      final ORecordStringable record=(ORecordStringable)iRecord;
      json.writeAttribute(settings.indentLevel + 1,true,"value",record.value());
    }
 else     if (iRecord instanceof ORecordBytes) {
      final ORecordBytes record=(ORecordBytes)iRecord;
      json.writeAttribute(settings.indentLevel + 1,true,"value",OBase64Utils.encodeBytes(record.toStream()));
    }
 else     throw new OSerializationException("Error on marshalling record of type '" + iRecord.getClass() + "' to JSON. The record type cannot be exported to JSON");
    json.endObject(settings.indentLevel);
    iOutput.append(buffer);
    return iOutput;
  }
 catch (  IOException e) {
    throw new OSerializationException("Error on marshalling of record to JSON",e);
  }
}
