{
  acquireExclusiveLock();
  try {
    if (!active)     return;
    active=false;
    if (shutdownHook != null)     shutdownHook.cancel();
    if (profiler != null)     profiler.shutdown();
    OLogManager.instance().debug(this,"Orient Engine is shutting down...");
    if (listeners != null)     for (    OOrientListener l : listeners) {
      if (l != null)       l.onShutdown();
    }
    for (    OEngine engine : engines.values()) {
      engine.shutdown();
    }
    if (databaseFactory != null)     databaseFactory.shutdown();
    if (storages != null) {
      final List<OStorage> storagesCopy=new ArrayList<OStorage>(storages.values());
      for (      OStorage stg : storagesCopy) {
        OLogManager.instance().debug(this,"Shutting down storage: " + stg.getName() + "...");
        stg.close(true);
      }
    }
    if (OMMapManagerLocator.getInstance() != null)     OMMapManagerLocator.getInstance().shutdown();
    if (threadGroup != null)     threadGroup.interrupt();
    if (listeners != null)     listeners.clear();
    OLogManager.instance().debug(this,"Orient Engine shutdown complete");
  }
  finally {
    releaseExclusiveLock();
  }
}
