{
  Lock fileLock;
  cacheLock.acquireReadLock();
  try {
    fileLock=fileLockManager.acquireExclusiveLock(fileId);
    try {
      writeCache.truncateFile(fileId);
      final Set<Long> pageEntries=filePages.get(fileId);
      for (      Long pageIndex : pageEntries) {
        OCacheEntry cacheEntry=get(fileId,pageIndex,true);
        if (cacheEntry == null)         cacheEntry=pinnedPages.get(new PinnedPage(fileId,pageIndex));
        if (cacheEntry != null) {
          if (cacheEntry.usagesCount == 0) {
            cacheEntry=remove(fileId,pageIndex);
            if (cacheEntry == null)             cacheEntry=pinnedPages.remove(new PinnedPage(fileId,pageIndex));
            if (cacheEntry.dataPointer != null) {
              cacheEntry.dataPointer.decrementReferrer();
              cacheEntry.dataPointer=null;
            }
          }
        }
 else         throw new OStorageException("Page with index " + pageIndex + " was  not found in cache for file with id "+ fileId);
      }
      pageEntries.clear();
    }
  finally {
      fileLockManager.releaseLock(fileLock);
    }
  }
  finally {
    cacheLock.releaseReadLock();
  }
}
