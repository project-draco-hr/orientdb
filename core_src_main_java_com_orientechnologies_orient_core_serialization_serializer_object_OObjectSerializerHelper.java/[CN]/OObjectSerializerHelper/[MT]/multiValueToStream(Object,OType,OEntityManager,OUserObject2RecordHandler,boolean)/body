{
  if (iMultiValue == null)   return null;
  final Collection<Object> sourceValues=(Collection<Object>)(iMultiValue instanceof Collection<?> ? iMultiValue : ((Map<?,?>)iMultiValue).values());
  if (iType == null) {
    if (sourceValues.size() == 0)     return iMultiValue;
    final Object firstValue=sourceValues.iterator().next();
    if (firstValue == null)     return iMultiValue;
    if (OType.isSimpleType(firstValue.getClass())) {
      if (iMultiValue instanceof List)       iType=OType.EMBEDDEDLIST;
 else       if (iMultiValue instanceof Set)       iType=OType.EMBEDDEDSET;
 else       iType=OType.EMBEDDEDMAP;
    }
 else {
      if (iMultiValue instanceof List)       iType=OType.LINKLIST;
 else       if (iMultiValue instanceof Set)       iType=OType.LINKSET;
 else       iType=OType.LINKMAP;
    }
  }
  Object result=null;
  final OType linkedType;
  if (iType.equals(OType.EMBEDDEDLIST) || iType.equals(OType.LINKLIST)) {
    result=new ArrayList<Object>();
  }
 else   if (iType.equals(OType.EMBEDDEDSET) || iType.equals(OType.LINKSET)) {
    result=new HashSet<Object>();
  }
 else   if (iType.equals(OType.EMBEDDEDMAP) || iType.equals(OType.LINKMAP)) {
    result=new HashMap<String,Object>();
  }
 else   throw new IllegalArgumentException("Type " + iType + " must be a collection");
  if (iType.equals(OType.LINKLIST) || iType.equals(OType.LINKSET) || iType.equals(OType.LINKMAP))   linkedType=OType.LINK;
 else   if (iType.equals(OType.EMBEDDEDLIST) || iType.equals(OType.EMBEDDEDSET) || iType.equals(OType.EMBEDDEDMAP))   linkedType=OType.EMBEDDED;
 else   throw new IllegalArgumentException("Type " + iType + " must be a multi value type (collection or map)");
  if (iMultiValue instanceof Collection<?>)   for (  Object o : sourceValues) {
    ((Collection<Object>)result).add(typeToStream(o,linkedType,iEntityManager,iObj2RecHandler,iSaveOnlyDirty));
  }
 else   for (  Entry<String,Object> entry : ((Map<String,Object>)iMultiValue).entrySet()) {
    ((Map<String,Object>)result).put(entry.getKey(),typeToStream(entry.getValue(),linkedType,iEntityManager,iObj2RecHandler,iSaveOnlyDirty));
  }
  return result;
}
