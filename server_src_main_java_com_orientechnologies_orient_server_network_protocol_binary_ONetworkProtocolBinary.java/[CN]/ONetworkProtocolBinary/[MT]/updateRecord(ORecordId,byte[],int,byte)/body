{
  final ORecordInternal<?> newRecord=Orient.instance().getRecordFactoryManager().newInstance(connection.database,recordType);
  newRecord.fill(connection.database,rid,version,buffer,true);
  if (((OSchemaProxy)connection.database.getMetadata().getSchema()).getIdentity().equals(rid))   throw new OSecurityAccessException("Can't update internal record " + rid);
  final ORecordInternal<?> currentRecord;
  if (newRecord instanceof ODocument) {
    currentRecord=connection.database.load(rid);
    if (currentRecord == null)     throw new ORecordNotFoundException(rid.toString());
    final ODocument doc=(ODocument)currentRecord;
    doc.merge((ODocument)newRecord,false,false);
  }
 else   currentRecord=newRecord;
  currentRecord.setVersion(version);
  connection.database.save(currentRecord);
  if (currentRecord.getIdentity().toString().equals(connection.database.getStorage().getConfiguration().indexMgrRecordId)) {
    connection.database.getMetadata().getIndexManager().reload();
  }
  return currentRecord.getVersion();
}
