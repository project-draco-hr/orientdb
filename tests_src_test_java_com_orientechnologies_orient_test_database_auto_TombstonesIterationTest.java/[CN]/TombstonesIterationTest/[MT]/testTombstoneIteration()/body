{
  if (!OGlobalConfiguration.USE_LHPEPS_MEMORY_CLUSTER.getValueAsBoolean())   return;
  final int docCount=10000;
  final ODocument document=new ODocument();
  final TreeSet<OClusterPosition> clusterPositions=new TreeSet<OClusterPosition>();
  for (int i=0; i < docCount; i++) {
    document.reset();
    document.setClassName("Zombie");
    document.field("name","Flasheater" + i);
    document.field("rank",i);
    document.save();
    clusterPositions.add(document.getIdentity().getClusterPosition());
  }
  final HashSet<OClusterPosition> deletedItems=new HashSet<OClusterPosition>();
  final Random random=new Random();
  ORecordIteratorCluster<ODocument> clusterIterator=db.browseCluster("Zombie",OClusterPosition.INVALID_POSITION,OClusterPosition.INVALID_POSITION,true);
  while (clusterIterator.hasNext()) {
    final ODocument doc=clusterIterator.next();
    if (random.nextBoolean()) {
      deletedItems.add(doc.getIdentity().getClusterPosition());
      doc.delete();
    }
  }
  Assert.assertEquals(db.countClass("Zombie"),docCount - deletedItems.size());
  clusterIterator=db.browseCluster("Zombie",OClusterPosition.INVALID_POSITION,OClusterPosition.INVALID_POSITION,true);
  Iterator<OClusterPosition> positionIterator=clusterPositions.iterator();
  while (clusterIterator.hasNext()) {
    final ODocument doc=clusterIterator.next();
    final OClusterPosition position=positionIterator.next();
    Assert.assertEquals(position,doc.getIdentity().getClusterPosition());
    if (deletedItems.contains(position))     Assert.assertTrue(doc.getRecordVersion().isTombstone());
  }
  Assert.assertFalse(clusterIterator.hasNext());
  Assert.assertFalse(positionIterator.hasNext());
  clusterIterator=db.browseCluster("Zombie");
  positionIterator=clusterPositions.iterator();
  while (positionIterator.hasNext()) {
    final OClusterPosition position=positionIterator.next();
    if (deletedItems.contains(position))     continue;
    Assert.assertTrue(clusterIterator.hasNext());
    Assert.assertEquals(position,clusterIterator.next().getIdentity().getClusterPosition());
  }
  Assert.assertFalse(clusterIterator.hasNext());
  Assert.assertFalse(positionIterator.hasNext());
}
