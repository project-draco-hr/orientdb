{
  final Map<Object,OIdentifiable> result=new HashMap<Object,OIdentifiable>();
  for (  Map.Entry<Object,OIdentifiable> keyValueEntry : keyValueEntries.entrySet()) {
    OIdentifiable keyResult=keyValueEntry.getValue();
    Object key=keyValueEntry.getKey();
    if (indexChanges.containsChangesPerKey(key)) {
      final OTransactionIndexChangesPerKey value=indexChanges.getChangesPerKey(key);
      if (value != null) {
        for (        final OTransactionIndexEntry entry : value.entries) {
          if (entry.operation == OPERATION.REMOVE) {
            if (entry.value == null || entry.value.equals(keyResult)) {
              if (keysToRemove != null)               keysToRemove.add(key);
              keyResult=null;
            }
          }
 else           if (entry.operation == OPERATION.PUT) {
            if (keysToRemove != null)             keysToRemove.add(key);
            keyResult=entry.value;
          }
        }
      }
    }
    if (keyResult != null)     result.put(key,keyResult.getIdentity());
  }
  return result;
}
