{
  if (iRequest.authorization == null)   throw new OSecurityAccessException(iRequest.databaseName,"No user and password received");
  final List<String> parts=OStringSerializerHelper.split(iRequest.authorization,':');
  final ODatabaseDocumentTx db=OSharedDocumentDatabase.acquire(iRequest.databaseName,parts.get(0),parts.get(1));
  ODatabaseRecord localDatabase=ODatabaseRecordThreadLocal.INSTANCE.getIfDefined();
  String currentUserId=iRequest.data.currentUserId;
  if (currentUserId != null && currentUserId.length() > 0 && localDatabase != null && localDatabase.getUser() != null) {
    if (!currentUserId.equals(localDatabase.getUser().getDocument().getIdentity().toString())) {
      ODocument userDoc=localDatabase.load(new ORecordId(currentUserId));
      localDatabase.setUser(new OUser(userDoc));
    }
  }
  if (db != null) {
    iRequest.data.lastDatabase=db.getName();
    iRequest.data.lastUser=db.getUser() != null ? db.getUser().getName() : null;
  }
 else {
    iRequest.data.lastDatabase=null;
    iRequest.data.lastUser=null;
  }
  return db;
}
