{
  if (open) {
    if (getUsers() > 0) {
      while (removeUser() > 0)       ;
    }
  }
  close(true);
  try {
    Orient.instance().unregisterStorage(this);
  }
 catch (  Exception e) {
    OLogManager.instance().error(this,"Can't unregister storage",e);
  }
  final long timer=OProfiler.getInstance().startChrono();
  File dbDir=new File(OSystemVariableResolver.resolveSystemVariables(url));
  if (!dbDir.exists() || !dbDir.isDirectory())   dbDir=dbDir.getParentFile();
  final boolean locked=lock.acquireExclusiveLock();
  try {
    for (int i=0; i < DELETE_MAX_RETRIES; ++i) {
      if (dbDir.exists() && dbDir.isDirectory()) {
        int notDeletedFiles=0;
        for (        File f : dbDir.listFiles()) {
          for (          String ext : ALL_FILE_EXTENSIONS)           if (f.getPath().endsWith(ext)) {
            if (!f.delete()) {
              notDeletedFiles++;
            }
            break;
          }
        }
        if (notDeletedFiles == 0) {
          dbDir.delete();
          return;
        }
      }
 else       return;
      try {
        OLogManager.instance().debug(this,"Can't delete database files because are locked by the OrientDB process yet: waiting a %d ms and retry %d/%d...",DELETE_WAIT_TIME,i,DELETE_MAX_RETRIES);
        System.gc();
        Thread.sleep(DELETE_WAIT_TIME);
      }
 catch (      InterruptedException e) {
      }
    }
    throw new OStorageException("Can't delete database '" + name + "' located in: "+ dbDir+ ". Database files seems locked");
  }
  finally {
    lock.releaseExclusiveLock(locked);
    OProfiler.getInstance().stopChrono("storage." + name + ".delete",timer);
  }
}
