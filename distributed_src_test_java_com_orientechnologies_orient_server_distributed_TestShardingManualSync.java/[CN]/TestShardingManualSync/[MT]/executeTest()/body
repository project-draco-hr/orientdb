{
  final OrientGraphFactory localFactoryEurope=new OrientGraphFactory("plocal:target/server0/databases/" + getDatabaseName());
  final OrientGraphFactory localFactoryUsa=new OrientGraphFactory("plocal:target/server1/databases/" + getDatabaseName());
  OrientGraphNoTx graphNoTxEurope=localFactoryEurope.getNoTx();
  try {
    final OrientVertexType clientType=graphNoTxEurope.createVertexType("Client");
    for (int i=1; i < serverInstance.size(); ++i) {
      final String serverName=serverInstance.get(i).getServerInstance().getDistributedManager().getLocalNodeName();
      clientType.addCluster("client_" + serverName);
    }
    final OrientVertex v1=graphNoTxEurope.addVertex("class:Client");
    log("Created vertex " + v1.getIdentity() + "...");
  }
  finally {
    graphNoTxEurope.shutdown();
  }
  OrientGraphNoTx graphNoTxUsa=localFactoryUsa.getNoTx();
  try {
    Assert.assertEquals(1,graphNoTxUsa.countVertices());
    serverInstance.get(1).shutdownServer();
  }
  finally {
    graphNoTxEurope.shutdown();
  }
  final String clusterName;
  graphNoTxEurope=localFactoryEurope.getNoTx();
  try {
    log("Adding vertex to europe node...");
    final OrientVertex v2=graphNoTxEurope.addVertex("class:Client");
    clusterName=graphNoTxEurope.getRawGraph().getClusterNameById(v2.getIdentity().getClusterId());
    log("Restarting USA server...");
    serverInstance.get(1).startServer(getDistributedServerConfiguration(serverInstance.get(1)));
    Assert.assertEquals(2,graphNoTxEurope.countVertices());
  }
  finally {
    graphNoTxEurope.shutdown();
  }
  graphNoTxUsa=localFactoryUsa.getNoTx();
  try {
    Assert.assertEquals(1,graphNoTxUsa.countVertices());
    log("Manually syncing cluster client of node USA...");
    graphNoTxUsa.command(new OCommandSQL("sync cluster " + clusterName)).execute();
    Assert.assertEquals(2,graphNoTxUsa.countVertices());
  }
  finally {
    graphNoTxEurope.shutdown();
  }
  localFactoryEurope.close();
  localFactoryUsa.close();
}
