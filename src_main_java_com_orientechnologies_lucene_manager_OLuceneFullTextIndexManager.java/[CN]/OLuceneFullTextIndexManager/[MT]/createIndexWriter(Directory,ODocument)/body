{
  Analyzer analyzer=getAnalyzer(metadata);
  Version version=getLuceneVersion(metadata);
  IndexWriterConfig iwc=new IndexWriterConfig(version,analyzer);
  iwc.setOpenMode(IndexWriterConfig.OpenMode.CREATE_OR_APPEND);
  buildFacetIndexIfNeeded(metadata);
  return new IndexWriter(directory,iwc);
}
