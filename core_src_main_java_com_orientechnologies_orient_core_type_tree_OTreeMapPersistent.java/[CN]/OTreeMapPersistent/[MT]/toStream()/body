{
  final long timer=OProfiler.getInstance().startChrono();
  try {
    OMemoryOutputStream stream=new OMemoryOutputStream();
    if (root != null) {
      OTreeMapEntryPersistent<K,V> pRoot=(OTreeMapEntryPersistent<K,V>)root;
      if (pRoot.record.getIdentity().isNew()) {
        pRoot.save();
      }
      stream.add(pRoot.record.getIdentity().toStream());
    }
 else     stream.add(ORecordId.EMPTY_RECORD_ID_STREAM);
    stream.add(size);
    stream.add((short)lastPageSize);
    stream.add(keySerializer.getName());
    stream.add(valueSerializer.getName());
    record.fromStream(stream.getByteArray());
    return record.toStream();
  }
  finally {
    OProfiler.getInstance().stopChrono("OTreeMapPersistent.toStream",timer);
  }
}
