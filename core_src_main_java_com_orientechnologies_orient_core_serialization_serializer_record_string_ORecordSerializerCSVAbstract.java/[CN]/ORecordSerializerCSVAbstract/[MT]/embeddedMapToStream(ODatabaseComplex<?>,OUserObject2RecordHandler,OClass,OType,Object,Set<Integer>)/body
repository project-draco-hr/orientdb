{
  final StringBuilder buffer=new StringBuilder();
  buffer.append(OStringSerializerHelper.MAP_BEGIN);
  if (iValue != null) {
    int items=0;
    ODocument record;
    for (    Entry<String,Object> o : ((Map<String,Object>)iValue).entrySet()) {
      if (items > 0)       buffer.append(OStringSerializerHelper.RECORD_SEPARATOR);
      if (o != null) {
        buffer.append(OStringSerializerHelper.fieldTypeToString(iDatabase,OType.STRING,o.getKey()));
        buffer.append(OStringSerializerHelper.ENTRY_SEPARATOR);
        if (o.getValue() instanceof ORecord<?>) {
          if (o.getValue() instanceof ODocument)           record=(ODocument)o.getValue();
 else           record=OObjectSerializerHelper.toStream(o.getValue(),new ODocument((ODatabaseRecord<?>)iDatabase,o.getValue().getClass().getSimpleName()),iDatabase instanceof ODatabaseObjectTx ? ((ODatabaseObjectTx)iDatabase).getEntityManager() : OEntityManagerInternal.INSTANCE,iLinkedClass,iObjHandler != null ? iObjHandler : new OUserObject2RecordHandler(){
            public Object getUserObjectByRecord(            ORecordInternal<?> iRecord,            final String iFetchPlan){
              return iRecord;
            }
            public ORecordInternal<?> getRecordByUserObject(            Object iPojo,            boolean iIsMandatory){
              return new ODocument(iLinkedClass);
            }
            public boolean existsUserObjectByRecord(            ORecordInternal<?> iRecord){
              return false;
            }
          }
);
          buffer.append(OStringSerializerHelper.EMBEDDED);
          buffer.append(toString(record,null,iObjHandler,iMarshalledRecords));
          buffer.append(OStringSerializerHelper.EMBEDDED);
        }
 else         if (o.getValue() instanceof Map<?,?>) {
          buffer.append(OStringSerializerHelper.fieldTypeToString(iDatabase,OType.EMBEDDEDMAP,o.getValue()));
        }
 else         buffer.append(OStringSerializerHelper.fieldTypeToString(iDatabase,iLinkedType,o.getValue()));
      }
      items++;
    }
  }
  buffer.append(OStringSerializerHelper.MAP_END);
  return buffer.toString();
}
