{
  final ODiskCache expectedDiskCache=((OAbstractPaginatedStorage)expectedDatabaseDocumentTx.getStorage()).getDiskCache();
  for (  OWALRecord walRecord : records) {
    atomicUnit.add(walRecord);
    if (!atomicChangeIsProcessed && walRecord instanceof OAtomicUnitStartRecord) {
      atomicChangeIsProcessed=true;
    }
 else     if (walRecord instanceof OAtomicUnitEndRecord) {
      atomicChangeIsProcessed=false;
      for (      OWALRecord restoreRecord : atomicUnit) {
        if (restoreRecord instanceof OAtomicUnitStartRecord || restoreRecord instanceof OAtomicUnitEndRecord || restoreRecord instanceof ONonTxOperationPerformedWALRecord|| restoreRecord instanceof OFullCheckpointStartRecord|| restoreRecord instanceof OCheckpointEndRecord)         continue;
        if (restoreRecord instanceof OUpdatePageRecord) {
          final OUpdatePageRecord updatePageRecord=(OUpdatePageRecord)restoreRecord;
          final long fileId=updatePageRecord.getFileId();
          final long pageIndex=updatePageRecord.getPageIndex();
          if (!expectedDiskCache.isOpen(fileId))           expectedDiskCache.openFile(fileId);
          OCacheEntry cacheEntry=expectedDiskCache.load(fileId,pageIndex,true);
          if (cacheEntry == null)           do {
            cacheEntry=expectedDiskCache.allocateNewPage(fileId);
          }
 while (cacheEntry.getPageIndex() != pageIndex);
          cacheEntry.acquireExclusiveLock();
          try {
            ODurablePage durablePage=new ODurablePage(cacheEntry,null);
            durablePage.restoreChanges(updatePageRecord.getChanges());
            durablePage.setLsn(updatePageRecord.getLsn());
          }
  finally {
            cacheEntry.releaseExclusiveLock();
            expectedDiskCache.release(cacheEntry);
          }
        }
 else         if (restoreRecord instanceof OFileCreatedCreatedWALRecord) {
          final OFileCreatedCreatedWALRecord fileCreatedCreatedRecord=(OFileCreatedCreatedWALRecord)restoreRecord;
          String fileName=fileCreatedCreatedRecord.getFileName().replace("actualLocalHashTable","expectedLocalHashTable");
          if (expectedDiskCache.exists(fileName))           expectedDiskCache.openFile(fileName,fileCreatedCreatedRecord.getFileId());
 else           expectedDiskCache.addFile(fileName);
        }
      }
      atomicUnit.clear();
    }
 else {
      Assert.assertTrue(walRecord instanceof OUpdatePageRecord || walRecord instanceof OFileCreatedCreatedWALRecord || walRecord instanceof ONonTxOperationPerformedWALRecord|| walRecord instanceof OFullCheckpointStartRecord|| walRecord instanceof OCheckpointEndRecord);
    }
  }
  return atomicChangeIsProcessed;
}
