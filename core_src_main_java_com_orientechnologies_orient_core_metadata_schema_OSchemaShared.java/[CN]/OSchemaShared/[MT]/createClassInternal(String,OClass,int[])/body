{
  acquireSchemaWriteLock();
  try {
    if (className == null || className.length() == 0)     throw new OSchemaException("Found class name null or empty");
    if (Character.isDigit(className.charAt(0)))     throw new OSchemaException("Found invalid class name. Cannot start with numbers");
    final Character wrongCharacter=checkNameIfValid(className);
    if (wrongCharacter != null)     throw new OSchemaException("Found invalid class name. Character '" + wrongCharacter + "' cannot be used in class name.");
    final ODatabaseRecord database=getDatabase();
    final OStorage storage=database.getStorage();
    checkEmbedded(storage);
    checkClustersAreAbsent(clusterIdsToAdd);
    final int[] clusterIds;
    if (clusterIdsToAdd == null || clusterIdsToAdd.length == 0) {
      final int minimumClusters=storage.getConfiguration().getMinimumClusters();
      clusterIds=new int[minimumClusters];
      if (minimumClusters <= 1)       clusterIds[0]=database.addCluster(CLUSTER_TYPE.PHYSICAL.toString(),className,null,null);
 else       for (int i=0; i < minimumClusters; ++i) {
        clusterIds[i]=database.getClusterIdByName(className + "_" + i);
        if (clusterIds[i] == -1)         clusterIds[i]=database.addCluster(CLUSTER_TYPE.PHYSICAL.toString(),className + "_" + i,null,null);
      }
    }
 else     clusterIds=clusterIdsToAdd;
    database.checkSecurity(ODatabaseSecurityResources.SCHEMA,ORole.PERMISSION_CREATE);
    final String key=className.toLowerCase();
    if (classes.containsKey(key))     throw new OSchemaException("Class " + className + " already exists in current database");
    OClassImpl cls=new OClassImpl(this,className,clusterIds);
    classes.put(key,cls);
    if (cls.getShortName() != null)     classes.put(cls.getShortName().toLowerCase(),cls);
    if (superClass != null) {
      cls.setSuperClassInternal(superClass);
      final int[] clustersToIndex=superClass.getPolymorphicClusterIds();
      final String[] clusterNames=new String[clustersToIndex.length];
      for (int i=0; i < clustersToIndex.length; i++)       clusterNames[i]=database.getClusterNameById(clustersToIndex[i]);
      for (      OIndex<?> index : superClass.getIndexes())       for (      String clusterName : clusterNames)       if (clusterName != null)       database.getMetadata().getIndexManager().addClusterToIndex(clusterName,index.getName());
    }
    addClusterClassMap(cls);
    return cls;
  }
  finally {
    releaseSchemaWriteLock();
  }
}
