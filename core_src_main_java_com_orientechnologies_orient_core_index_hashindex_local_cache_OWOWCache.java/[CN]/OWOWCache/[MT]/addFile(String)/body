{
  filesLock.acquireWriteLock();
  try {
    initNameIdMapping();
    Long fileId=nameIdMap.get(fileName);
    OFileClassic fileClassic;
    if (fileId != null)     throw new OStorageException("File with name " + fileName + " already exists in storage "+ storageLocal.getName());
    ++fileCounter;
    fileId=fileCounter;
    fileClassic=createFile(fileName);
    files.put(fileId,fileClassic);
    nameIdMap.put(fileName,fileId);
    writeNameIdEntry(new NameFileIdEntry(fileName,fileId),true);
    addFile(fileClassic);
    return fileId;
  }
  finally {
    filesLock.releaseWriteLock();
  }
}
