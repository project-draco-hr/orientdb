{
  if (!backupDirectory.exists()) {
    if (!backupDirectory.mkdirs()) {
      throw new OStorageException("Backup directory " + backupDirectory.getAbsolutePath() + " does not exist and can not be created");
    }
  }
  RandomAccessFile rndIBUFile=null;
  try {
    final String[] files=fetchIBUFiles(backupDirectory);
    final OLogSequenceNumber lastLsn;
    final long nextIndex;
    if (files.length == 0) {
      lastLsn=null;
      nextIndex=0;
    }
 else {
      lastLsn=extractIBULsn(backupDirectory,files[files.length - 1]);
      nextIndex=extractIndexFromIBUFile(backupDirectory,files[files.length - 1]) + 1;
    }
    final SimpleDateFormat dateFormat=new SimpleDateFormat(INCREMENTAL_BACKUP_DATEFORMAT);
    final String fileName;
    if (lastLsn != null)     fileName=getName() + "_" + dateFormat.format(new Date())+ "_"+ nextIndex+ IBU_EXTENSION;
 else     fileName=getName() + "_" + dateFormat.format(new Date())+ "_"+ nextIndex+ "_full"+ IBU_EXTENSION;
    final File ibuFile=new File(backupDirectory,fileName);
    rndIBUFile=new RandomAccessFile(ibuFile,"rw");
    try {
      final FileChannel ibuChannel=rndIBUFile.getChannel();
      ibuChannel.position(3 * OLongSerializer.LONG_SIZE + OByteSerializer.BYTE_SIZE);
      final OLogSequenceNumber maxLsn=incrementalBackup(Channels.newOutputStream(ibuChannel),lastLsn);
      final ByteBuffer dataBuffer=ByteBuffer.allocate(3 * OLongSerializer.LONG_SIZE + OByteSerializer.BYTE_SIZE);
      dataBuffer.putLong(nextIndex);
      dataBuffer.putLong(maxLsn.getSegment());
      dataBuffer.putLong(maxLsn.getPosition());
      if (lastLsn == null)       dataBuffer.put((byte)1);
 else       dataBuffer.put((byte)0);
      dataBuffer.rewind();
      ibuChannel.position(0);
      ibuChannel.write(dataBuffer);
    }
 catch (    RuntimeException e) {
      rndIBUFile.close();
      if (!ibuFile.delete()) {
        OLogManager.instance().error(this,ibuFile.getAbsolutePath() + " is closed but can not be deleted");
      }
    }
  }
 catch (  IOException e) {
    throw OException.wrapException(new OStorageException("Error during incremental backup"),e);
  }
 finally {
    try {
      if (rndIBUFile != null)       rndIBUFile.close();
    }
 catch (    IOException e) {
      throw OException.wrapException(new OStorageException("Error during incremental backup"),e);
    }
  }
}
