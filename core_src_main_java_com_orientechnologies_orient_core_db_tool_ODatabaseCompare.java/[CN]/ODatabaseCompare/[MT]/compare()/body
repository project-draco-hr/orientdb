{
  if (isDocumentDatabases() && (databaseDocumentTxOne == null || databaseDocumentTxTwo == null)) {
    listener.onMessage("\nPassed in URLs are related to document databases but credentials " + "were not provided to open them. Please provide user name + password for databases to compare");
    return false;
  }
  if (!isDocumentDatabases() && (databaseDocumentTxOne != null || databaseDocumentTxTwo != null)) {
    listener.onMessage("\nPassed in URLs are not related to document databases but credentials " + "were provided to open them. Please do not provide user name + password for databases to compare");
    return false;
  }
  try {
    ODocumentHelper.RIDMapper ridMapper=null;
    if (autoDetectExportImportMap) {
      listener.onMessage("\nAuto discovery of mapping between RIDs of exported and imported records is switched on, try to discover mapping data on disk.");
      File file=new File(databaseDocumentTxTwo.getStorage().getConfiguration().getDirectory() + File.separator + ODatabaseImport.EXPORT_IMPORT_MAP_NAME+ ODatabaseImport.EXPORT_IMPORT_MAP_TREE_STATE_EXT);
      if (file.exists()) {
        listener.onMessage("\nMapping data were found and will be loaded.");
        OMurmurHash3HashFunction<OIdentifiable> keyHashFunction=new OMurmurHash3HashFunction<OIdentifiable>();
        keyHashFunction.setValueSerializer(OLinkSerializer.INSTANCE);
        exportImportHashTable=new OLocalHashTable<OIdentifiable,OIdentifiable>(ODatabaseImport.EXPORT_IMPORT_MAP_METADATA_EXT,ODatabaseImport.EXPORT_IMPORT_MAP_TREE_STATE_EXT,ODatabaseImport.EXPORT_IMPORT_MAP_BF_EXT,keyHashFunction);
        exportImportHashTable.load(ODatabaseImport.EXPORT_IMPORT_MAP_NAME,(OStorageLocalAbstract)databaseDocumentTxTwo.getStorage());
        ridMapper=new ODocumentHelper.RIDMapper(){
          @Override public ORID map(          ORID rid){
            if (rid == null)             return null;
            if (!rid.isPersistent())             return null;
            final OIdentifiable result=exportImportHashTable.get(rid);
            if (result == null)             return null;
            return result.getIdentity();
          }
        }
;
      }
 else       listener.onMessage("\nMapping data were not found.");
    }
    compareClusters();
    compareRecords(ridMapper);
    if (isDocumentDatabases())     compareIndexes(ridMapper);
    if (exportImportHashTable != null)     exportImportHashTable.close();
    if (differences == 0) {
      listener.onMessage("\n\nDatabases match.");
      return true;
    }
 else {
      listener.onMessage("\n\nDatabases do not match. Found " + differences + " difference(s).");
      return false;
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw new ODatabaseExportException("Error on compare of database '" + storage1.getName() + "' against '"+ storage2.getName()+ "'",e);
  }
 finally {
    storage1.close();
    storage2.close();
  }
}
