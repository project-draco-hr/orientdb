{
  lock.acquireExclusiveLock();
  try {
    record.fromStream(toStream());
    if (record.getIdentity().isValid())     record.setVersion(storage.updateRecord(0,clusterId,record.getIdentity().getClusterPosition(),record.toStream(),record.getVersion(),record.getRecordType()));
 else     record.setIdentity(clusterId,storage.createRecord(record.getIdentity().getClusterId(),record.toStream(),record.getRecordType()));
    record.unsetDirty();
    return this;
  }
  finally {
    lock.releaseExclusiveLock();
  }
}
