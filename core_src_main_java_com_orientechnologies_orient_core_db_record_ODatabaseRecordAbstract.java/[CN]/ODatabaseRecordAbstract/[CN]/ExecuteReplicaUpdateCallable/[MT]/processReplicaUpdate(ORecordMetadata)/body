{
  ORecordInternal<?> replicaToUpdate=record;
  boolean result;
  final ORecordVersion version=record.getRecordVersion();
  try {
    if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      replicaToUpdate=mergeWithDocument();
      callbackHooks(TYPE.BEFORE_REPLICA_ADD,replicaToUpdate);
    }
 else     if (!recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      replicaToUpdate=mergeWithDocument();
      callbackHooks(TYPE.BEFORE_REPLICA_UPDATE,replicaToUpdate);
    }
 else     if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      replicaToUpdate=mergeWithDocument();
      callbackHooks(TYPE.BEFORE_REPLICA_DELETE,replicaToUpdate);
    }
    byte[] stream=replicaToUpdate.toStream();
    final int dataSegmentId=dataSegmentStrategy.assignDataSegmentId(ODatabaseRecordAbstract.this,replicaToUpdate);
    result=underlying.updateReplica(dataSegmentId,rid,stream,version,recordType);
    if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.AFTER_REPLICA_ADD,replicaToUpdate);
      replicaToUpdate.unsetDirty();
      getLevel1Cache().updateRecord(replicaToUpdate);
    }
 else     if (!recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.AFTER_REPLICA_UPDATE,replicaToUpdate);
      replicaToUpdate.unsetDirty();
      getLevel1Cache().updateRecord(replicaToUpdate);
    }
 else     if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.AFTER_REPLICA_DELETE,replicaToUpdate);
      replicaToUpdate.unsetDirty();
      getLevel1Cache().deleteRecord(rid);
    }
  }
 catch (  Exception e) {
    if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.REPLICA_ADD_FAILED,replicaToUpdate);
    }
 else     if (!recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.REPLICA_UPDATE_FAILED,replicaToUpdate);
    }
 else     if (recordMetadata.getRecordVersion().isTombstone() && !version.isTombstone()) {
      callbackHooks(TYPE.REPLICA_DELETE_FAILED,replicaToUpdate);
    }
    throw e;
  }
  return result;
}
