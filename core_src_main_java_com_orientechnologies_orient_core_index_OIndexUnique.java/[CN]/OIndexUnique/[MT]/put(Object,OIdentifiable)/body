{
  checkForOptimization();
  acquireExclusiveLock();
  try {
    Set<OIdentifiable> values=map.get(iKey);
    checkForOptimization();
    if (values == null)     values=new ORecordLazySet(configuration.getDatabase());
 else     if (values.size() == 1) {
      if (!values.contains(iSingleValue))       throw new OIndexException("Found duplicated key '" + iKey + "' on unique index '"+ name+ "' for record "+ iSingleValue.getIdentity()+ ". The record already present in the index is "+ values.iterator().next().getIdentity());
 else       return this;
    }
 else     if (values.size() > 1)     throw new OIndexException("Found duplicated key '" + iKey + "' on unique index '"+ name+ "' for record "+ iSingleValue.getIdentity()+ ". The record already present in the index are "+ values);
    values.add(iSingleValue);
    map.put(iKey,values);
    return this;
  }
  finally {
    releaseExclusiveLock();
  }
}
