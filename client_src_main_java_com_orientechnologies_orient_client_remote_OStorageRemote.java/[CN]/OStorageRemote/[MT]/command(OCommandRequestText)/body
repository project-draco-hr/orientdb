{
  if (!(iCommand instanceof OSerializableStream))   throw new OCommandExecutionException("Cannot serialize the command to be executed to the server side.");
  Object result=null;
  final boolean live=iCommand instanceof OLiveQuery;
  final ODatabaseDocument database=ODatabaseRecordThreadLocal.INSTANCE.get();
  try {
    OChannelBinaryAsynchClient network=null;
    do {
      OStorageRemoteThreadLocal.INSTANCE.get().commandExecuting=true;
      try {
        final boolean asynch=iCommand instanceof OCommandRequestAsynch && ((OCommandRequestAsynch)iCommand).isAsynchronous();
        try {
          network=beginRequest(OChannelBinaryProtocol.REQUEST_COMMAND);
          if (live) {
            network.writeByte((byte)'l');
          }
 else {
            network.writeByte((byte)(asynch ? 'a' : 's'));
          }
          network.writeBytes(OStreamSerializerAnyStreamable.INSTANCE.toStream(iCommand));
        }
  finally {
          endRequest(network);
        }
        try {
          beginResponse(network);
          boolean addNextRecord=true;
          if (asynch) {
            byte status;
            while ((status=network.readByte()) > 0) {
              final ORecord record=(ORecord)OChannelBinaryProtocol.readIdentifiable(network);
              if (record == null)               continue;
switch (status) {
case 1:
                if (addNextRecord) {
                  addNextRecord=iCommand.getResultListener().result(record);
                  database.getLocalCache().updateRecord(record);
                }
              break;
case 2:
            database.getLocalCache().updateRecord(record);
        }
      }
    }
 else {
      final byte type=network.readByte();
switch (type) {
case 'n':
        result=null;
      break;
case 'r':
    result=OChannelBinaryProtocol.readIdentifiable(network);
  if (result instanceof ORecord)   database.getLocalCache().updateRecord((ORecord)result);
break;
case 'l':
final int tot=network.readInt();
final Collection<OIdentifiable> list=new ArrayList<OIdentifiable>(tot);
for (int i=0; i < tot; ++i) {
final OIdentifiable resultItem=OChannelBinaryProtocol.readIdentifiable(network);
if (resultItem instanceof ORecord) database.getLocalCache().updateRecord((ORecord)resultItem);
list.add(resultItem);
}
result=list;
break;
case 'a':
final String value=new String(network.readBytes());
result=ORecordSerializerStringAbstract.fieldTypeFromStream(null,ORecordSerializerStringAbstract.getType(value),value);
break;
default :
OLogManager.instance().warn(this,"Received unexpected result from query: %d",type);
}
if (network.getSrvProtocolVersion() >= 17) {
byte status;
while ((status=network.readByte()) > 0) {
final ORecord record=(ORecord)OChannelBinaryProtocol.readIdentifiable(network);
if (record != null && status == 2) database.getLocalCache().updateRecord(record);
}
}
if (live) {
ODocument doc=((List<ODocument>)result).get(0);
Integer token=doc.field("token");
Boolean unsubscribe=doc.field("unsubscribe");
if (token != null) {
if (Boolean.TRUE.equals(unsubscribe)) {
this.asynchEventListener.unregisterLiveListener(token);
}
 else {
OLiveResultListener listener=(OLiveResultListener)iCommand.getResultListener();
this.asynchEventListener.registerLiveListener(token,listener);
}
}
 else {
throw new OStorageException("Cannot execute live query, returned null token");
}
}
}
break;
}
  finally {
endResponse(network);
}
}
 catch (OModificationOperationProhibitedException mope) {
handleDBFreeze();
}
catch (Exception e) {
handleException(network,"Error on executing command: " + iCommand,e);
}
 finally {
OStorageRemoteThreadLocal.INSTANCE.get().commandExecuting=false;
}
}
 while (true);
}
  finally {
if (iCommand.getResultListener() != null && !live) iCommand.getResultListener().end();
}
return result;
}
