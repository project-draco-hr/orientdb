{
  String[] urlParts=checkSyntax(iRequest.url,4,"Syntax error: query/<database>/sql/query[/<limit>][/<fetchPlan>]. <br/>Limit is optional and is setted to 20 by default. Set expressely to 0 to have no limits.");
  final int limit=urlParts.length > 4 ? Integer.parseInt(urlParts[4]) : 20;
  final String fetchPlan=urlParts.length > 5 ? urlParts[5] : null;
  final String text=urlParts[3];
  iRequest.data.commandInfo="Query";
  iRequest.data.commandDetail=text;
  if (!text.toLowerCase().startsWith("select"))   throw new IllegalArgumentException("Only SQL Select are valid using Query command");
  ODatabaseDocumentTx db=null;
  final List<ORecord<?>> response;
  try {
    db=getProfiledDatabaseInstance(iRequest,urlParts[1]);
    response=(List<ORecord<?>>)db.command(new OSQLSynchQuery<ORecordSchemaAware<?>>(text,limit)).execute();
  }
  finally {
    if (db != null)     OSharedDocumentDatabase.release(db);
  }
  sendRecordsContent(iRequest,response,fetchPlan);
}
