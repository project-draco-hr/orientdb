{
  if (lastRequestType < 80) {
    super.parseCommand();
    return;
  }
switch (lastRequestType) {
case OChannelDistributedProtocol.REQUEST_DISTRIBUTED_HEARTBEAT:
    data.commandInfo="Keep-alive";
  manager.updateHeartBeatTime();
sendOk(lastClientTxId);
channel.writeLong(connection.database == null ? 0 : connection.database.getStorage().getVersion());
break;
case OChannelDistributedProtocol.REQUEST_DISTRIBUTED_CONNECT:
{
data.commandInfo="Cluster connection";
manager.receivedLeaderConnection(this);
final String dbName=channel.readString();
if (dbName != null) {
connection.database=openDatabase(dbName,channel.readString(),channel.readString());
}
sendOk(lastClientTxId);
channel.writeLong(connection.database != null ? connection.database.getStorage().getVersion() : 0);
break;
}
case OChannelDistributedProtocol.REQUEST_DISTRIBUTED_DB_SHARE_SENDER:
{
data.commandInfo="Share the database to a remote server";
final String dbName=channel.readString();
final String dbUser=channel.readString();
final String dbPassword=channel.readString();
final String remoteServerName=channel.readString();
final boolean synchronousMode=channel.readByte() == 1;
checkServerAccess("database.share");
connection.database=openDatabase(dbName,dbUser,dbPassword);
final String engineName=connection.database.getStorage() instanceof OStorageLocal ? "local" : "memory";
final ODistributedServerNodeRemote remoteServerNode=manager.getNode(remoteServerName);
remoteServerNode.shareDatabase(connection.database,remoteServerName,dbUser,dbPassword,engineName,synchronousMode);
sendOk(lastClientTxId);
manager.addServerInConfiguration(dbName,remoteServerName,engineName,synchronousMode);
break;
}
case OChannelDistributedProtocol.REQUEST_DISTRIBUTED_DB_SHARE_RECEIVER:
{
data.commandInfo="Received a shared database from a remote server to install";
final String dbName=channel.readString();
final String dbUser=channel.readString();
final String dbPasswd=channel.readString();
final String engineName=channel.readString();
manager.setStatus(ODistributedServerManager.STATUS.SYNCHRONIZING);
try {
OLogManager.instance().info(this,"Received database '%s' to share on local server node",dbName);
connection.database=getDatabaseInstance(dbName,engineName);
if (connection.database.exists()) {
OLogManager.instance().info(this,"Deleting existent database '%s'",connection.database.getName());
connection.database.delete();
}
createDatabase(connection.database,dbUser,dbPasswd);
if (connection.database.isClosed()) connection.database.open(dbUser,dbPasswd);
OLogManager.instance().info(this,"Importing database '%s' via streaming from remote server node...",dbName);
new ODatabaseImport(connection.database,new OChannelBinaryInputStream(channel),this).importDatabase();
OLogManager.instance().info(this,"Database imported correctly",dbName);
sendOk(lastClientTxId);
channel.writeLong(connection.database.getStorage().getVersion());
}
  finally {
manager.updateHeartBeatTime();
manager.setStatus(ODistributedServerManager.STATUS.ONLINE);
}
break;
}
case OChannelDistributedProtocol.REQUEST_DISTRIBUTED_DB_CONFIG:
{
data.commandInfo="Update db configuration from server node leader";
final ODocument config=(ODocument)new ODocument().fromStream(channel.readBytes());
manager.getClusterConfiguration(connection.database.getName(),config);
OLogManager.instance().warn(this,"Changed distributed server configuration:\n%s",config.toJSON("indent:2"));
sendOk(lastClientTxId);
break;
}
default :
super.parseCommand();
}
}
