{
  setCurrentDatabaseinThreadLocal();
  try {
    super.open(iUserName,iUserPassword);
    initAtFirstOpen(iUserName,iUserPassword);
    if (!(getStorage() instanceof OStorageProxy)) {
      final OSchemaProxy schema=getMetadata().getSchema();
      if (user == null || user.getVersion() != schema.getVersion() || !user.getName().equalsIgnoreCase(iUserName)) {
        final OUser usr=metadata.getSecurity().authenticate(iUserName,iUserPassword);
        if (usr != null)         user=new OImmutableUser(schema.getVersion(),usr);
 else         user=null;
        checkSecurity(ODatabaseSecurityResources.DATABASE,ORole.PERMISSION_READ);
      }
    }
    callOnOpenListeners();
  }
 catch (  OException e) {
    close();
    throw e;
  }
catch (  Exception e) {
    close();
    throw new ODatabaseException("Cannot open database",e);
  }
  return (DB)this;
}
