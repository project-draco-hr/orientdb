{
  record.fromStream(toStream());
  if (record.getIdentity().isValid())   ORecordInternal.setVersion(record,iStorage.updateRecord((ORecordId)record.getIdentity(),true,record.toStream(),-1,ORecordInternal.getRecordType(record),(byte)0,null).getResult());
 else {
    if (record.getIdentity().getClusterId() == ORID.CLUSTER_ID_INVALID)     ((ORecordId)record.getIdentity()).clusterId=treeDataProvider.clusterId;
    final OPhysicalPosition ppos=iStorage.createRecord((ORecordId)record.getIdentity(),record.toStream(),0,ORecordInternal.getRecordType(record),(byte)0,null).getResult();
    ORecordInternal.setIdentity(record,record.getIdentity().getClusterId(),ppos.clusterPosition);
    ORecordInternal.setVersion(record,ppos.recordVersion);
  }
  ORecordInternal.unsetDirty(record);
  if (!record.getIdentity().isTemporary())   ORecordListenerManager.removeListener(record,this);
}
