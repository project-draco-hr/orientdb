{
  final AtomicLong nanoIncrement=new AtomicLong();
  nanoIncrement.set(100);
  final OStoragePerformanceStatistic storagePerformanceStatistic=new OStoragePerformanceStatistic(1024,"test",1,new OStoragePerformanceStatistic.NanoTimer(){
    private long counter=0;
    @Override public long getNano(){
      return counter+=nanoIncrement.get();
    }
  }
,100000);
  storagePerformanceStatistic.registerMBean();
  final MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
  final ObjectName objectName=new ObjectName("com.orientechnologies.orient.core.storage.impl.local." + "statistic:type=OStoragePerformanceStatisticMXBean,name=test,id=1");
  Assert.assertTrue(mbs.isRegistered(objectName));
  storagePerformanceStatistic.registerMBean();
  final OStoragePerformanceStatisticMXBean mxBean=MBeanServerInvocationHandler.newProxyInstance(mbs,objectName,OStoragePerformanceStatisticMXBean.class,false);
  Assert.assertFalse(mxBean.isMeasurementEnabled());
  Assert.assertEquals(mxBean.getReadSpeedFromCacheInPages(),-1);
  Assert.assertEquals(mxBean.getReadSpeedFromCacheInMB(),-1);
  mxBean.startMeasurement();
  final AtomicBoolean stop=new AtomicBoolean();
  final ExecutorService executor=Executors.newSingleThreadExecutor();
  final Future<Void> future=executor.submit(new Callable<Void>(){
    @Override public Void call() throws Exception {
      while (!stop.get()) {
        storagePerformanceStatistic.startCommitTimer();
        storagePerformanceStatistic.startPageReadFromCacheTimer();
        storagePerformanceStatistic.stopPageReadFromCacheTimer();
        storagePerformanceStatistic.stopCommitTimer();
      }
      return null;
    }
  }
);
  long notZeroSpeedCount=0;
  long msStart=System.currentTimeMillis();
  long counter=0;
  while (notZeroSpeedCount < 1000) {
    if (counter % 1000 == 0 && System.currentTimeMillis() - msStart > 10000)     break;
    final long pagesSpeed=mxBean.getReadSpeedFromCacheInPages();
    final long mbSpeed=mxBean.getReadSpeedFromCacheInMB();
    if (pagesSpeed == -1) {
      Thread.yield();
    }
 else {
      notZeroSpeedCount++;
      Assert.assertEquals(pagesSpeed,10000000);
      Assert.assertEquals(mbSpeed,10000000 / 1024);
    }
    Thread.yield();
    counter++;
  }
  Assert.assertTrue(notZeroSpeedCount > 0);
  System.out.println("testReadSpeedFromCacheMBean : not zero speed count " + notZeroSpeedCount);
  mxBean.stopMeasurement();
  if (mxBean.getReadSpeedFromCacheInPages() > 0) {
    System.out.println("testReadSpeedFromCacheMBean : check that values were not changed after stop measurement");
    nanoIncrement.set(10);
    Thread.sleep(200);
    Assert.assertEquals(mxBean.getReadSpeedFromCacheInPages(),10000000);
    Assert.assertEquals(mxBean.getReadSpeedFromCacheInMB(),10000000 / 1024);
    Assert.assertFalse(mxBean.isMeasurementEnabled());
  }
  stop.set(true);
  future.get();
  mxBean.startMeasurement();
  Thread.sleep(200);
  Assert.assertTrue(mxBean.isMeasurementEnabled());
  Assert.assertEquals(mxBean.getReadSpeedFromCacheInPages(),-1);
  Assert.assertEquals(mxBean.getReadSpeedFromCacheInMB(),-1);
  executor.shutdown();
  storagePerformanceStatistic.unregisterMBean();
  Assert.assertFalse(mbs.isRegistered(objectName));
  storagePerformanceStatistic.unregisterMBean();
}
