{
  key=getCollatingValue(key);
  final ODatabase database=getDatabase();
  final boolean txIsActive=database.getTransaction().isActive();
  if (txIsActive)   keyLockManager.acquireSharedLock(key);
  try {
    modificationLock.requestModificationLock();
    try {
      checkForKeyType(key);
      acquireSharedLock();
      try {
        markStorageDirty();
        indexEngine.put(key,value);
        return this;
      }
  finally {
        releaseSharedLock();
      }
    }
  finally {
      modificationLock.releaseModificationLock();
    }
  }
  finally {
    if (txIsActive)     keyLockManager.releaseSharedLock(key);
  }
}
