{
  ODatabaseRecord currentDb=ODatabaseRecordThreadLocal.INSTANCE.get();
  if (currentDb == null && iCurrentDatabase != null)   currentDb=iCurrentDatabase;
  currentDb=(ODatabaseRecord)currentDb.getDatabaseOwner();
  final OGraphDatabase db;
  if (currentDb instanceof OGraphDatabase)   db=(OGraphDatabase)currentDb;
 else   if (currentDb instanceof ODatabaseDocumentTx) {
    db=new OGraphDatabase((ODatabaseRecordTx)currentDb.getUnderlying());
    ODatabaseRecordThreadLocal.INSTANCE.set(db);
  }
 else   if (currentDb instanceof ODatabaseRecordTx) {
    db=new OGraphDatabase((ODatabaseRecordTx)currentDb);
    ODatabaseRecordThreadLocal.INSTANCE.set(db);
  }
 else   throw new OCommandExecutionException("Can't find a database of type OGraphDatabase or ODatabaseRecordTx");
  return db;
}
