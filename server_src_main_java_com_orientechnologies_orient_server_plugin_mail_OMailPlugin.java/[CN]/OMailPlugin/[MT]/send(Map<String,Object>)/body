{
  final String profileName=(String)iMessage.get("profile");
  final OMailProfile profile=profiles.get(profileName);
  if (profile == null)   throw new IllegalArgumentException("Mail profile '" + profileName + "' is not configured on server");
  Authenticator auth=new OSMTPAuthenticator((String)profile.getProperty("mail.smtp.user"),(String)profile.getProperty("mail.smtp.password"));
  Session session=Session.getInstance(profile,auth);
  MimeMessage msg=new MimeMessage(session);
  msg.setFrom(new InternetAddress((String)iMessage.get("from")));
  InternetAddress[] toAddresses={new InternetAddress((String)iMessage.get("to"))};
  msg.setRecipients(Message.RecipientType.TO,toAddresses);
  String cc=(String)iMessage.get("cc");
  if (cc != null && !cc.isEmpty()) {
    InternetAddress[] ccAddresses={new InternetAddress(cc)};
    msg.setRecipients(Message.RecipientType.CC,ccAddresses);
  }
  String bcc=(String)iMessage.get("bcc");
  if (bcc != null && !bcc.isEmpty()) {
    InternetAddress[] bccAddresses={new InternetAddress(bcc)};
    msg.setRecipients(Message.RecipientType.BCC,bccAddresses);
  }
  msg.setSubject((String)iMessage.get("subject"));
  Object date=iMessage.get("date");
  final Date sendDate;
  if (date == null)   sendDate=new Date();
 else   if (date instanceof Date)   sendDate=(Date)date;
 else {
    String dateFormat=(String)profile.getProperty("mail.date.format");
    if (dateFormat == null)     dateFormat="yyyy-MM-dd HH:mm:ss";
    sendDate=new SimpleDateFormat(dateFormat).parse(date.toString());
  }
  msg.setSentDate(sendDate);
  MimeBodyPart messageBodyPart=new MimeBodyPart();
  messageBodyPart.setContent(iMessage.get("message"),"text/html");
  Multipart multipart=new MimeMultipart();
  multipart.addBodyPart(messageBodyPart);
  final String[] attachments=(String[])iMessage.get("attachments");
  if (attachments != null && attachments.length > 0) {
    for (    String filePath : attachments) {
      addAttachment(multipart,filePath);
    }
  }
  msg.setContent(multipart);
  Transport.send(msg);
}
