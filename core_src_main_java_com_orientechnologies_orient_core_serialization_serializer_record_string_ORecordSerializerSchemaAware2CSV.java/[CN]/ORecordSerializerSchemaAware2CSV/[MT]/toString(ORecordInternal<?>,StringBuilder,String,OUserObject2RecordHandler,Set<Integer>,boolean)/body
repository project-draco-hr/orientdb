{
  if (!(iRecord instanceof ODocument))   throw new OSerializationException("Can't marshall a record of type " + iRecord.getClass().getSimpleName() + " to CSV");
  final ODocument record=(ODocument)iRecord;
  final Integer identityRecord=System.identityHashCode(record);
  if (iMarshalledRecords != null)   if (iMarshalledRecords.contains(identityRecord)) {
    return iOutput;
  }
 else   iMarshalledRecords.add(identityRecord);
  final ODatabaseRecord database=record.getDatabase();
  if (!iOnlyDelta && record.getSchemaClass() != null) {
    iOutput.append(record.getSchemaClass().getStreamableName());
    iOutput.append(OStringSerializerHelper.CLASS_SEPARATOR);
  }
  OProperty prop;
  OType type;
  OClass linkedClass;
  OType linkedType;
  String fieldClassName;
  int i=0;
  final Set<String> fieldNamesIterator=iOnlyDelta && record.isTrackingChanges() ? record.getDirtyFields() : record.fieldNames();
  for (  String fieldName : fieldNamesIterator) {
    Object fieldValue=record.rawField(fieldName);
    if (i > 0)     iOutput.append(OStringSerializerHelper.RECORD_SEPARATOR);
    prop=record.getSchemaClass() != null ? record.getSchemaClass().getProperty(fieldName) : null;
    fieldClassName=getClassName(fieldValue);
    type=record.fieldType(fieldName);
    linkedClass=null;
    linkedType=null;
    if (prop != null) {
      type=prop.getType();
      linkedClass=prop.getLinkedClass();
      linkedType=prop.getLinkedType();
    }
 else     if (fieldValue != null) {
      if (fieldValue.getClass() == byte[].class) {
        type=OType.BINARY;
      }
 else       if (fieldValue instanceof Collection<?> || fieldValue.getClass().isArray()) {
        int size=OMultiValue.getSize(fieldValue);
        if (size > 0) {
          Object firstValue=OMultiValue.getFirstValue(fieldValue);
          if (firstValue != null) {
            if (firstValue instanceof ORID) {
              linkedClass=null;
              linkedType=OType.LINK;
              if (fieldValue instanceof Set<?>)               type=OType.LINKSET;
 else               type=OType.LINKLIST;
            }
 else             if (database != null && (firstValue instanceof ORecordSchemaAware<?> || (database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(getClassName(firstValue)) != null))) {
              linkedClass=getLinkInfo(database,getClassName(firstValue));
              if (type == null) {
                linkedType=OType.LINK;
                if (fieldValue instanceof Set<?>)                 type=OType.LINKSET;
 else                 type=OType.LINKLIST;
              }
 else               linkedType=OType.EMBEDDED;
            }
 else {
              linkedType=OType.getTypeByClass(firstValue.getClass());
              if (linkedType != OType.LINK) {
                if (linkedType == null) {
                  linkedType=OType.EMBEDDED;
                }
                if (type == null)                 if (fieldValue instanceof Set<?>)                 type=OType.EMBEDDEDSET;
 else                 type=OType.EMBEDDEDLIST;
              }
            }
          }
        }
 else         if (type == null)         type=OType.EMBEDDEDLIST;
      }
 else       if (fieldValue instanceof Map<?,?>) {
        if (type == null)         type=OType.EMBEDDEDMAP;
        if (OMultiValue.getSize(fieldValue) > 0) {
          Object firstValue=OMultiValue.getFirstValue(fieldValue);
          if (firstValue instanceof ORID) {
            linkedClass=null;
            linkedType=OType.LINK;
            type=OType.LINKMAP;
          }
 else           if (database != null && (firstValue instanceof ORecordSchemaAware<?> || (database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(getClassName(firstValue)) != null))) {
            if (((ORecordInternal<?>)firstValue).getIdentity().isValid())             type=OType.LINKMAP;
            linkedType=type == OType.EMBEDDEDLIST || type == OType.EMBEDDEDSET || type == OType.EMBEDDEDMAP ? OType.EMBEDDED : OType.LINK;
            linkedClass=getLinkInfo(database,getClassName(firstValue));
          }
 else {
            linkedType=OType.getTypeByClass(firstValue.getClass());
            if (linkedType == OType.LINK && type == OType.EMBEDDEDMAP)             type=OType.LINKMAP;
          }
        }
      }
 else       if (database != null && fieldValue instanceof ORecord<?>) {
        if (type == null)         if (fieldValue instanceof ODocument && ((ODocument)fieldValue).hasOwners())         type=OType.EMBEDDED;
 else         type=OType.LINK;
        linkedClass=getLinkInfo(database,fieldClassName);
      }
 else       if (fieldValue instanceof ORID) {
        if (type == null)         type=OType.LINK;
      }
 else       if (database != null && database.getDatabaseOwner() instanceof ODatabaseObject && ((ODatabaseObject)database.getDatabaseOwner()).getEntityManager().getEntityClass(fieldClassName) != null) {
        if (type == null)         type=OType.LINK;
        linkedClass=getLinkInfo(database,fieldClassName);
      }
 else       if (fieldValue instanceof Date) {
        if (type == null)         type=OType.DATETIME;
      }
 else       if (fieldValue instanceof String)       type=OType.STRING;
 else       if (fieldValue instanceof Integer)       type=OType.INTEGER;
 else       if (fieldValue instanceof Long)       type=OType.LONG;
 else       if (fieldValue instanceof Float)       type=OType.FLOAT;
 else       if (fieldValue instanceof Short)       type=OType.SHORT;
 else       if (fieldValue instanceof Byte)       type=OType.BYTE;
 else       if (fieldValue instanceof Double)       type=OType.DOUBLE;
    }
    if (type == OType.TRANSIENT)     continue;
    if (type == null)     type=OType.EMBEDDED;
    iOutput.append(fieldName);
    iOutput.append(FIELD_VALUE_SEPARATOR);
    fieldToStream((ODocument)iRecord,iRecord.getDatabase(),iOutput,iObjHandler,type,linkedClass,linkedType,fieldName,fieldValue,iMarshalledRecords,true);
    i++;
  }
  if (iMarshalledRecords != null)   iMarshalledRecords.remove(identityRecord);
  final float overSize;
  if (record.getSchemaClass() != null)   overSize=record.getSchemaClass().getOverSize();
 else   overSize=0;
  final int newSize;
  if (record.hasOwners())   newSize=iOutput.length();
 else   if (record.getSize() == iOutput.length())   newSize=record.getSize();
 else   if (record.getSize() > iOutput.length()) {
    newSize=record.getSize();
  }
 else   if (overSize > 0) {
    newSize=(int)(iOutput.length() * overSize);
  }
 else   newSize=iOutput.length();
  if (newSize > iOutput.length())   for (int b=iOutput.length(); b < newSize; ++b)   iOutput.append(' ');
  return iOutput;
}
