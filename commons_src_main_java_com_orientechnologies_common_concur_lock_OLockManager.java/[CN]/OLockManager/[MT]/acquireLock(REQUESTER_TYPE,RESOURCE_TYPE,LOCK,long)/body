{
  CountableLock lock;
synchronized (map) {
    lock=map.get(iResourceId);
    if (lock == null) {
      lock=new CountableLock();
      map.put(iResourceId,lock);
    }
    lock.countLocks++;
  }
  try {
    if (iLockType == LOCK.SHARED)     lock.readLock().lock();
 else     lock.writeLock().lock();
  }
 catch (  RuntimeException e) {
synchronized (map) {
      lock.countLocks--;
      if (lock.countLocks == 0)       map.remove(iResourceId);
    }
    throw e;
  }
}
