{
  setDataCommandInfo("Open database");
  readConnectionData();
  final String dbURL=channel.readString();
  dbType=ODatabaseDocument.TYPE;
  if (connection.data.protocolVersion >= 8)   dbType=channel.readString();
  final String user=channel.readString();
  final String passwd=channel.readString();
  connection.database=(ODatabaseDocumentTx)OServerMain.server().openDatabase(dbType,dbURL,user,passwd);
  connection.rawDatabase=((ODatabaseRaw)((ODatabaseComplex<?>)connection.database.getUnderlying()).getUnderlying());
  if (connection.database.getStorage() instanceof OStorageProxy && !loadUserFromSchema(user,passwd)) {
    sendError(clientTxId,new OSecurityAccessException(connection.database.getName(),"User or password not valid for database: '" + connection.database.getName() + "'"));
  }
 else {
    beginResponse();
    try {
      sendOk(clientTxId);
      channel.writeInt(connection.id);
      sendDatabaseInformation();
      final OServerHandler plugin=OServerMain.server().getPlugin("cluster");
      ODocument distributedCfg=null;
      if (plugin != null && plugin instanceof ODistributedServerManager)       distributedCfg=((ODistributedServerManager)plugin).getClusterConfiguration();
      channel.writeBytes(distributedCfg != null ? distributedCfg.toStream() : null);
      if (connection.data.protocolVersion >= 14)       channel.writeString(OConstants.getVersion());
    }
  finally {
      endResponse();
    }
  }
}
