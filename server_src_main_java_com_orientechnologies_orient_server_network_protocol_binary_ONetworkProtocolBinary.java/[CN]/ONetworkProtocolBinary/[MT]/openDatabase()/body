{
  setDataCommandInfo("Open database");
  readConnectionData();
  final String dbURL=channel.readString();
  String dbType=ODatabaseDocument.TYPE;
  if (connection.data.protocolVersion >= 8)   dbType=channel.readString();
  final String user=channel.readString();
  final String passwd=channel.readString();
  connection.database=(ODatabaseDocumentTx)server.openDatabase(dbType,dbURL,user,passwd);
  if (connection.database.getStorage() instanceof OStorageProxy && !loadUserFromSchema(user,passwd)) {
    sendErrorOrDropConnection(clientTxId,new OSecurityAccessException(connection.database.getName(),"User or password not valid for database: '" + connection.database.getName() + "'"));
  }
 else {
    beginResponse();
    try {
      sendOk(clientTxId);
      channel.writeInt(connection.id);
      if (connection.data.protocolVersion > OChannelBinaryProtocol.PROTOCOL_VERSION_26) {
        byte[] token=tokenHandler.getSignedBinaryToken(connection.database,connection.database.getUser());
        channel.writeBytes(token);
      }
      sendDatabaseInformation();
      final OServerPlugin plugin=server.getPlugin("cluster");
      ODocument distributedCfg=null;
      if (plugin != null && plugin instanceof ODistributedServerManager)       distributedCfg=((ODistributedServerManager)plugin).getClusterConfiguration();
      channel.writeBytes(distributedCfg != null ? distributedCfg.toStream() : null);
      if (connection.data.protocolVersion >= 14)       channel.writeString(OConstants.getVersion());
    }
  finally {
      endResponse();
    }
  }
}
