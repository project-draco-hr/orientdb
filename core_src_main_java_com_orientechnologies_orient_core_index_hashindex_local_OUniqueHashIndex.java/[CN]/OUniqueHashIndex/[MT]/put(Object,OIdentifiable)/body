{
  acquireExclusiveLock();
  try {
    checkForKeyType(key);
    final OIdentifiable currentValue=super.get(key);
    if (currentValue != null) {
      if (!currentValue.equals(value))       throw new ORecordDuplicatedException(String.format("Cannot index record %s: found duplicated key '%s' in index '%s' previously assigned to the record %s",null,OIndexException.class,value.getIdentity(),key,getName(),currentValue.getIdentity()),currentValue.getIdentity());
 else       return this;
    }
    if (!value.getIdentity().isPersistent())     ((ORecord<?>)value.getRecord()).save();
    super.put(key,value.getIdentity());
    return this;
  }
  finally {
    releaseExclusiveLock();
  }
}
