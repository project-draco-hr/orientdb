{
  final long operationId=operationStarted.incrementAndGet();
  return new OrientEdgeFuture(Orient.instance().getWorkers().submit(new Callable<OrientEdge>(){
    @Override public OrientEdge call() throws Exception {
      final OrientBaseGraph g=acquire();
      try {
        OrientVertex vOut=outVertex instanceof OrientVertexFuture ? ((OrientVertexFuture)outVertex).get() : (OrientVertex)outVertex;
        OrientVertex vIn=inVertex instanceof OrientVertexFuture ? ((OrientVertexFuture)inVertex).get() : (OrientVertex)inVertex;
        vOut.attach(g);
        vIn.attach(g);
        boolean reloaded=false;
        for (int retry=0; ; retry++) {
          try {
            final OrientEdge e=g.addEdge(id,vOut,vIn,label);
            if (reloaded) {
              addInCache(vOut.getProperty(keyFieldName),vOut);
              addInCache(vIn.getProperty(keyFieldName),vIn);
            }
            edgesCreated.incrementAndGet();
            return e;
          }
 catch (          OConcurrentModificationException e) {
            concurrentException.incrementAndGet();
            reloadVertices(vOut,vIn,retry,e);
            reloaded=true;
          }
catch (          ORecordDuplicatedException e) {
            indexUniqueException.incrementAndGet();
            reloadVertices(vOut,vIn,retry,e);
            reloaded=true;
          }
catch (          Exception e) {
            unknownException.incrementAndGet();
            OLogManager.instance().warn(this,"Error on addEdge(" + id + ","+ outVertex+ ","+ inVertex+ ","+ label+ "), retrying (retry="+ retry+ "/"+ maxRetries+ ")");
            e.printStackTrace();
          }
        }
      }
  finally {
        g.shutdown();
        asynchOperationCompleted();
      }
    }
    protected void reloadVertices(    final OrientVertex vOut,    final OrientVertex vIn,    final int retry,    final OException e){
      if (retry < maxRetries) {
        if (OLogManager.instance().isDebugEnabled())         OLogManager.instance().debug(this,"Conflict on addEdge(" + id + ","+ outVertex+ ","+ inVertex+ ","+ label+ "), retrying (retry="+ retry+ "/"+ maxRetries+ "). Cause: "+ e);
        if (e instanceof OConcurrentModificationException) {
          if (((OConcurrentModificationException)e).getRid().equals(vOut.getIdentity()))           vOut.reload();
 else           vIn.reload();
          verticesReloaded.incrementAndGet();
        }
 else {
          vOut.reload();
          verticesReloaded.incrementAndGet();
          vIn.reload();
          verticesReloaded.incrementAndGet();
        }
      }
 else       throw e;
    }
  }
));
}
