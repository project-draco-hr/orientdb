{
  if (txEntry.type != ORecordOperation.DELETED && !txEntry.getRecord().isDirty())   return;
  final ORecordId rid=(ORecordId)txEntry.getRecord().getIdentity();
  final boolean wasNew=rid.isNew();
  if (rid.clusterId == ORID.CLUSTER_ID_INVALID && txEntry.getRecord() instanceof ODocument && ((ODocument)txEntry.getRecord()).getSchemaClass() != null) {
    rid.clusterId=((ODocument)txEntry.getRecord()).getSchemaClass().getDefaultClusterId();
  }
  final OCluster cluster=storage.getClusterById(rid.clusterId);
  final ODataLocal dataSegment=storage.getDataSegmentById(txEntry.dataSegmentId);
  if (cluster.getName().equals(OStorage.CLUSTER_INDEX_NAME))   return;
  if (!(cluster instanceof OClusterLocal))   return;
  if (txEntry.getRecord() instanceof OTxListener)   ((OTxListener)txEntry.getRecord()).onEvent(txEntry,OTxListener.EVENT.BEFORE_COMMIT);
switch (txEntry.type) {
case ORecordOperation.LOADED:
    break;
case ORecordOperation.CREATED:
{
    byte[] stream=txEntry.getRecord().toStream();
    if (wasNew) {
      if (iTx.getDatabase().callbackHooks(ORecordHook.TYPE.BEFORE_CREATE,txEntry.getRecord()))       stream=txEntry.getRecord().toStream();
    }
 else {
      if (iTx.getDatabase().callbackHooks(ORecordHook.TYPE.BEFORE_UPDATE,txEntry.getRecord()))       stream=txEntry.getRecord().toStream();
    }
    if (rid.isNew()) {
      txEntry.getRecord().onBeforeIdentityChanged(rid);
      rid.clusterId=cluster.getId();
    }
    if (rid.isNew()) {
      final OPhysicalPosition ppos;
      if (iUseLog)       ppos=createRecord(iTx.getId(),dataSegment,cluster,rid,stream,txEntry.getRecord().getVersion(),txEntry.getRecord().getRecordType(),txEntry.dataSegmentId);
 else       ppos=iTx.getDatabase().getStorage().createRecord(txEntry.dataSegmentId,rid,stream,0,txEntry.getRecord().getRecordType(),(byte)0,null);
      rid.clusterPosition=ppos.clusterPosition;
      txEntry.getRecord().setVersion(ppos.recordVersion);
      txEntry.getRecord().onAfterIdentityChanged(txEntry.getRecord());
      iTx.getDatabase().callbackHooks(ORecordHook.TYPE.AFTER_CREATE,txEntry.getRecord());
    }
 else {
      if (iUseLog)       txEntry.getRecord().setVersion(updateRecord(iTx.getId(),cluster,rid,stream,txEntry.getRecord().getVersion(),txEntry.getRecord().getRecordType()));
 else       txEntry.getRecord().setVersion(iTx.getDatabase().getStorage().updateRecord(rid,stream,txEntry.getRecord().getVersion(),txEntry.getRecord().getRecordType(),(byte)0,null));
    }
    break;
  }
case ORecordOperation.UPDATED:
{
  byte[] stream=txEntry.getRecord().toStream();
  if (iTx.getDatabase().callbackHooks(ORecordHook.TYPE.BEFORE_UPDATE,txEntry.getRecord()))   stream=txEntry.getRecord().toStream();
  if (iUseLog)   txEntry.getRecord().setVersion(updateRecord(iTx.getId(),cluster,rid,stream,txEntry.getRecord().getVersion(),txEntry.getRecord().getRecordType()));
 else   txEntry.getRecord().setVersion(iTx.getDatabase().getStorage().updateRecord(rid,stream,txEntry.getRecord().getVersion(),txEntry.getRecord().getRecordType(),(byte)0,null));
  iTx.getDatabase().callbackHooks(ORecordHook.TYPE.AFTER_UPDATE,txEntry.getRecord());
  break;
}
case ORecordOperation.DELETED:
{
iTx.getDatabase().callbackHooks(ORecordHook.TYPE.BEFORE_DELETE,txEntry.getRecord());
if (iUseLog) deleteRecord(iTx.getId(),cluster,rid.clusterPosition,txEntry.getRecord().getVersion());
 else iTx.getDatabase().getStorage().deleteRecord(rid,txEntry.getRecord().getVersion(),(byte)0,null);
iTx.getDatabase().callbackHooks(ORecordHook.TYPE.AFTER_DELETE,txEntry.getRecord());
}
break;
}
txEntry.getRecord().unsetDirty();
if (txEntry.getRecord() instanceof OTxListener) ((OTxListener)txEntry.getRecord()).onEvent(txEntry,OTxListener.EVENT.AFTER_COMMIT);
}
