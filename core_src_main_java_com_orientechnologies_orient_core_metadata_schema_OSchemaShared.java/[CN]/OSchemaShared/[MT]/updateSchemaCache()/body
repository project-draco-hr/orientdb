{
  acquireSchemaReadLock();
  try {
    OImmutableSchema immutableSchema;
    OImmutableSchema newSchema;
    do {
      immutableSchema=schemaCache.get();
      if (immutableSchema != null && immutableSchema.getVersion() == version)       break;
      newSchema=new OImmutableSchema(this);
    }
 while (!schemaCache.compareAndSet(immutableSchema,newSchema));
  }
  finally {
    releaseSchemaReadLock();
  }
  return schemaCache.get();
}
