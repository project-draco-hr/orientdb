{
  final StringWriter buffer=new StringWriter();
  final OJSONWriter json=new OJSONWriter(buffer,JSON_FORMAT);
  json.beginObject();
  if (iRecords != null && iRecords.size() > 0) {
    ORecord<?> first=iRecords.get(0).getRecord();
    if (first != null && first instanceof ODocument) {
      ODatabaseRecord db=((ODocument)first).getDatabase();
      final String className=((ODocument)first).getClassName();
      exportClassSchema(db,json,db.getMetadata().getSchema().getClass(className));
    }
  }
  final String format=iFetchPlan != null ? JSON_FORMAT + ",fetchPlan:" + iFetchPlan : JSON_FORMAT;
  json.beginCollection(1,true,"result");
  if (iRecords != null) {
    int counter=0;
    String objectJson;
    for (    OIdentifiable rec : iRecords) {
      if (rec != null)       try {
        objectJson=rec.getRecord().toJSON(format);
        if (counter++ > 0)         buffer.append(", ");
        buffer.append(objectJson);
      }
 catch (      Exception e) {
        OLogManager.instance().error(this,"Error transforming record " + rec.getIdentity() + " to JSON",e);
      }
    }
  }
  json.endCollection(1,true);
  json.endObject();
  sendTextContent(iRequest,OHttpUtils.STATUS_OK_CODE,"OK",null,OHttpUtils.CONTENT_JSON,buffer.toString());
}
