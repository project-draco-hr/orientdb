{
  final ORecordSerializationContext context=ORecordSerializationContext.getContext();
  if (context != null) {
    if (delegate.size() >= topThreshold && isEmbedded()) {
      ORidBagDelegate oldDelegate=delegate;
      delegate=new OSBTreeRidBag();
      for (      OIdentifiable identifiable : oldDelegate)       delegate.add(identifiable);
      delegate.setOwner(oldDelegate.getOwner());
      oldDelegate.requestDelete();
    }
 else     if (delegate.size() <= bottomThreshold && !isEmbedded()) {
      ORidBagDelegate oldDelegate=delegate;
      delegate=new OEmbeddedRidBag();
      for (      OIdentifiable identifiable : oldDelegate)       delegate.add(identifiable);
      delegate.setOwner(oldDelegate.getOwner());
      oldDelegate.requestDelete();
    }
  }
  final byte[] stream=new byte[OByteSerializer.BYTE_SIZE + delegate.getSerializedSize()];
  if (isEmbedded())   stream[0]=1;
  delegate.serialize(stream,1);
  output.append(OBase64Utils.encodeBytes(stream));
  return this;
}
