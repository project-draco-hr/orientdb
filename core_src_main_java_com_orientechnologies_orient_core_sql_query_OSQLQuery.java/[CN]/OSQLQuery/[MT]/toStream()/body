{
  final OMemoryOutputStream buffer=new OMemoryOutputStream();
  if (!OFetchHelper.isFetchPlanValid(fetchPlan)) {
    throw new OSerializationException("Fetch plan '" + fetchPlan + "' is invalid");
  }
  try {
    buffer.add(text);
    buffer.add(limit);
    buffer.addAsFixed(beginRange.toStream());
    buffer.addAsFixed(endRange.toStream());
    buffer.add(fetchPlan != null ? fetchPlan : "");
    if (parameters == null || parameters.size() == 0)     buffer.add(new byte[0]);
 else {
      final ODocument param=new ODocument();
      param.field("params",parameters);
      buffer.add(param.toStream());
    }
  }
 catch (  IOException e) {
    throw new OSerializationException("Error while marshalling OSQLQuery",e);
  }
  return buffer.toByteArray();
}
