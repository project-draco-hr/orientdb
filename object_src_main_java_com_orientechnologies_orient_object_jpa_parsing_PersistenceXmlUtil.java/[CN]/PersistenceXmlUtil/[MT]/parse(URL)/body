{
  InputStream is=null;
  try {
    is=new BufferedInputStream(persistenceXml.openStream());
    is.mark(Integer.MAX_VALUE);
    Schema schema=getSchema(is);
    if (schema == null) {
      throw new PersistenceException("Schema is unknown");
    }
    is.reset();
    parserFactory.setNamespaceAware(true);
    return getPersistenceUnits(is);
  }
 catch (  Exception e) {
    throw new PersistenceException("Something goes wrong while parsing persistence.xml",e);
  }
 finally {
    if (is != null)     try {
      is.close();
    }
 catch (    IOException e) {
    }
  }
}
