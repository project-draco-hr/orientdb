{
  if (OLogManager.instance().isDebugEnabled())   OLogManager.instance().debug(this,"Caught exception",e);
  int errorCode=500;
  String errorReason=null;
  String errorMessage=null;
  String responseHeaders=null;
  if (e instanceof ORecordNotFoundException)   errorCode=404;
 else   if (e instanceof OLockException) {
    errorCode=423;
  }
 else   if (e instanceof IllegalArgumentException)   errorCode=400;
  if (e instanceof ODatabaseException || e instanceof OSecurityAccessException || e instanceof OCommandExecutionException) {
    final Throwable cause=e instanceof OSecurityAccessException ? e : e.getCause();
    if (cause instanceof OSecurityAccessException) {
      if (account == null) {
        errorCode=OHttpUtils.STATUS_AUTH_CODE;
        errorReason=OHttpUtils.STATUS_AUTH_DESCRIPTION;
        responseHeaders="WWW-Authenticate: Basic realm=\"OrientDB db-" + ((OSecurityAccessException)cause).getDatabaseName() + "\"";
        errorMessage=null;
      }
 else {
        errorCode=530;
        errorReason="Current user has not the privileges to execute the request.";
        errorMessage="530 User access denied";
      }
    }
  }
  if (errorReason == null)   errorReason=OHttpUtils.STATUS_ERROR_DESCRIPTION;
  if (errorMessage == null) {
    final StringBuilder buffer=new StringBuilder();
    buffer.append(e);
    Throwable cause=e.getCause();
    while (cause != null && cause != cause.getCause()) {
      buffer.append("\r\n--> ");
      buffer.append(cause);
      cause=cause.getCause();
    }
    errorMessage=buffer.toString();
  }
  try {
    sendTextContent(errorCode,errorReason,responseHeaders,OHttpUtils.CONTENT_TEXT_PLAIN,errorMessage);
  }
 catch (  IOException e1) {
    sendShutdown();
  }
}
