{
  final StringBuilder value=new StringBuilder();
  final ODocument result=new ODocument();
  for (  Entry<String,OTransactionIndexChanges> indexEntry : indexEntries.entrySet()) {
    final ODocument indexDoc=new ODocument();
    result.field(indexEntry.getKey(),indexDoc);
    if (indexEntry.getValue().cleared)     indexDoc.field("clear",Boolean.TRUE);
    final ODocument entries=new ODocument();
    indexDoc.field("entries",entries);
    for (    OTransactionIndexChangesPerKey entry : indexEntry.getValue().changesPerKey.values()) {
      value.setLength(0);
      if (entry.key != null)       ORecordSerializerStringAbstract.fieldTypeToString(value,null,OType.getTypeByClass(entry.key.getClass()),entry.key);
 else       value.append('*');
      String key=value.toString();
      if (key.length() > 1 && key.charAt(0) == '"' && key.charAt(key.length() - 1) == '"')       key=key.substring(1,key.length() - 1);
      List<ODocument> operations=new ArrayList<ODocument>();
      if (entry.entries != null && !entry.entries.isEmpty()) {
        for (        OTransactionIndexEntry e : entry.entries) {
          final ODocument changeDoc=new ODocument();
          changeDoc.field("o",e.operation.ordinal());
          if (e.value.getIdentity().isNew())           ((ORecord<?>)e.value).save();
          changeDoc.field("v",e.value.getIdentity());
          operations.add(changeDoc);
        }
      }
      entries.field(OStringSerializerHelper.encode(key),operations);
    }
  }
  indexEntries.clear();
  return result;
}
