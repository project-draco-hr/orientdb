{
  key=getCollatingValue(key);
  Object snapshotValue=snapshot.get(key);
  Set<OIdentifiable> values;
  if (snapshotValue == null)   values=indexEngine.get(key);
 else   if (snapshotValue.equals(RemovedValue.INSTANCE))   values=null;
 else   values=(Set<OIdentifiable>)snapshotValue;
  if (values == null) {
    if (ODefaultIndexFactory.SBTREEBONSAI_VALUE_CONTAINER.equals(valueContainerAlgorithm)) {
      boolean durable=false;
      if (metadata != null && Boolean.TRUE.equals(metadata.field("durableInNonTxMode")))       durable=true;
      values=new OIndexRIDContainer(getName(),durable);
    }
 else {
      values=new OMVRBTreeRIDSet(OGlobalConfiguration.MVRBTREE_RID_BINARY_THRESHOLD.getValueAsInteger());
      ((OMVRBTreeRIDSet)values).setAutoConvertToRecord(false);
    }
    snapshot.put(key,values);
  }
  values.add(value.getIdentity());
  snapshot.put(key,values);
}
