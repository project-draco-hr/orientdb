{
  ODatabaseDocumentTx dbServer1=poolFactory.get(getDatabaseURL(serverInstance.get(0)),"admin","admin").acquire();
  ODatabaseRecordThreadLocal.INSTANCE.set(dbServer1);
  ODocument record1Server1=new ODocument("Person").fields("id",RECORD_ID,"firstName","Han","lastName","Solo");
  record1Server1.save();
  waitForInsertedRecordPropagation(RECORD_ID);
  ODocument record1Server2=retrieveRecord(getDatabaseURL(serverInstance.get(1)),RECORD_ID);
  assertEquals(record1Server2.getVersion(),record1Server1.getVersion());
  assertEquals(record1Server2.field("id"),record1Server1.field("id"));
  assertEquals(record1Server2.field("firstName"),record1Server1.field("firstName"));
  assertEquals(record1Server2.field("lastName"),record1Server1.field("lastName"));
  int actualVersion=record1Server1.getVersion();
  ((ODistributedStorage)dbServer1.getStorage()).setEventListener(new AfterRecordLockDelayer());
  List<Callable<Void>> clients=new LinkedList<Callable<Void>>();
  clients.add(new RecordUpdater(getDatabaseURL(serverInstance.get(0)),record1Server1,lukeFields,true));
  clients.add(new RecordUpdater(getDatabaseURL(serverInstance.get(1)),record1Server2,darthFields,true));
  List<Future<Void>> futures=Executors.newCachedThreadPool().invokeAll(clients);
  executeFutures(futures);
  waitForUpdatedRecordPropagation(RECORD_ID,"firstName","Luke");
  record1Server1=retrieveRecord(getDatabaseURL(serverInstance.get(0)),RECORD_ID);
  record1Server2=retrieveRecord(getDatabaseURL(serverInstance.get(1)),RECORD_ID);
  int finalVersionServer1=record1Server1.field("@version");
  int finalVersionServer2=record1Server2.field("@version");
  assertEquals(finalVersionServer1,actualVersion + 1);
  assertEquals(finalVersionServer2,actualVersion + 1);
}
