{
  if (!isEnabled() || fresh == null || fresh.isDirty() || fresh.getIdentity().isNew() || !fresh.getIdentity().isValid() || fresh.getIdentity().getClusterId() == excludedCluster || fresh.getRecordVersion().isTombstone())   return;
  if (fresh.isPinned() == null || fresh.isPinned()) {
    underlying.lock(fresh.getIdentity());
    try {
      final ORecordInternal<?> current=underlying.get(fresh.getIdentity());
      if (current != null && current.getRecordVersion().compareTo(fresh.getRecordVersion()) >= 0)       return;
      if (ODatabaseRecordThreadLocal.INSTANCE.isDefined() && !ODatabaseRecordThreadLocal.INSTANCE.get().isClosed())       underlying.put((ORecordInternal<?>)fresh.flatCopy());
 else {
        fresh.detach();
        underlying.put(fresh);
      }
    }
  finally {
      underlying.unlock(fresh.getIdentity());
    }
  }
 else   underlying.remove(fresh.getIdentity());
}
