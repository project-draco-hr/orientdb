{
  long totalRecords=0;
  int level=1;
  listener.onMessage("\nExporting records...");
  writer.beginCollection(level,true,"records");
  int exportedClusters=0;
  int totalClusters=database.getClusterNames().size();
  for (int i=0; exportedClusters < totalClusters; ++i) {
    String clusterName=database.getClusterNameById(i);
    if (clusterName == null)     continue;
    exportedClusters++;
    if (includeClusters != null) {
      if (!includeClusters.contains(clusterName))       continue;
    }
 else     if (excludeClusters != null) {
      if (excludeClusters.contains(clusterName))       continue;
    }
    if (excludeClusters.contains(clusterName))     continue;
    long recordTot=database.countClusterElements(clusterName);
    listener.onMessage("\n- Cluster '" + clusterName + "'...");
    long recordNum=0;
    for (    ORecordInternal<?> rec : database.browseCluster(clusterName)) {
      if (rec instanceof ODocument) {
        ODocument doc=(ODocument)rec;
        if (includeClasses != null) {
          if (!includeClasses.contains(doc.getClassName()))           continue;
        }
 else         if (excludeClasses != null) {
          if (excludeClasses.contains(doc.getClassName()))           continue;
        }
      }
      exportRecord(recordTot,recordNum++,rec);
    }
    listener.onMessage("OK (records=" + recordTot + ")");
    writer.flush();
    totalRecords+=recordTot;
  }
  writer.endCollection(level,true);
  listener.onMessage("\n\nDone. Exported " + totalRecords + " records\n");
  return totalRecords;
}
