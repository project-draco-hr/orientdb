{
  setCurrentDatabaseinThreadLocal();
  if (currentTx.isActive())   currentTx.rollback();
  for (  ODatabaseListener listener : underlying.getListeners())   try {
    listener.onBeforeTxBegin(underlying);
  }
 catch (  Throwable t) {
    OLogManager.instance().error(this,"Error before tx begin",t);
  }
switch (iType) {
case NOTX:
    setDefaultTransactionMode();
  break;
case OPTIMISTIC:
currentTx=new OTransactionOptimistic(this);
currentTx.addRecordListener(new OClassIndexManager());
break;
case PESSIMISTIC:
throw new UnsupportedOperationException("Pessimistic transaction");
}
currentTx.begin();
return this;
}
