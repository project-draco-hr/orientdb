{
  OFileUtils.deleteRecursively(new File("target/testCreatedAESEncryptedCluster"));
  final ODatabase db=new ODatabaseDocumentTx("plocal:target/testCreatedAESEncryptedCluster");
  db.setProperty(OGlobalConfiguration.STORAGE_COMPRESSION_OPTIONS.getKey(),"T1JJRU5UREJfSVNfQ09PTA==");
  db.create();
  db.command(new OCommandSQL("create class TestEncryption")).execute();
  db.command(new OCommandSQL("alter cluster TestEncryption compression aes-encrypted")).execute();
  db.command(new OCommandSQL("insert into TestEncryption set name = 'Jay'")).execute();
  List result=db.query(new OSQLSynchQuery<ODocument>("select from TestEncryption"));
  Assert.assertEquals(result.size(),1);
  db.close();
  db.open("admin","admin");
  db.close();
  Orient.instance().getStorage("testCreatedAESEncryptedCluster").close(true,false);
  db.setProperty(OGlobalConfiguration.STORAGE_COMPRESSION_OPTIONS.getKey(),"T1JJRU5UREJfSVNfQ09PTA==");
  db.open("admin","admin");
  result=db.query(new OSQLSynchQuery<ODocument>("select from TestEncryption"));
  Assert.assertEquals(result.size(),1);
  db.close();
  Orient.instance().getStorage("testCreatedAESEncryptedCluster").close(true,false);
  db.setProperty(OGlobalConfiguration.STORAGE_COMPRESSION_OPTIONS.getKey(),"invalidPassword");
  try {
    db.open("admin","admin");
    db.query(new OSQLSynchQuery<ODocument>("select from TestEncryption"));
    result=db.query(new OSQLSynchQuery<ODocument>("select from OUser"));
    Assert.assertFalse(result.isEmpty());
    Assert.fail();
  }
 catch (  ODatabaseException e) {
    Assert.assertTrue(e.getCause() instanceof OSecurityException);
  }
 finally {
    db.close();
    Orient.instance().getStorage("testCreatedAESEncryptedCluster").close(true,false);
  }
  db.setProperty(OGlobalConfiguration.STORAGE_COMPRESSION_OPTIONS.getKey(),"T1JJRU5UREJfSVNfQ09PTA=-");
  try {
    db.open("admin","admin");
    db.query(new OSQLSynchQuery<ODocument>("select from TestEncryption"));
    Assert.fail();
  }
 catch (  OStorageException e) {
    Assert.assertTrue(e.getCause() instanceof OSecurityException);
  }
 finally {
    db.close();
    Orient.instance().getStorage("testCreatedAESEncryptedCluster").close(true,false);
  }
  db.setProperty(OGlobalConfiguration.STORAGE_COMPRESSION_OPTIONS.getKey(),"T1JJRU5UREJfSVNfQ09PTA==");
  db.open("admin","admin");
  result=db.query(new OSQLSynchQuery<ODocument>("select from TestEncryption"));
  Assert.assertEquals(result.size(),1);
  db.close();
}
