{
  OLockManager.LOCK lock=writeLock ? OLockManager.LOCK.EXCLUSIVE : OLockManager.LOCK.SHARED;
synchronized (syncObject) {
    final Set<Long> pageIndexes=filesPages.get(fileId);
    Long[] sortedPageIndexes=new Long[pageIndexes.size()];
    sortedPageIndexes=pageIndexes.toArray(sortedPageIndexes);
    Arrays.sort(sortedPageIndexes);
    for (    Long pageIndex : sortedPageIndexes) {
      lockManager.acquireLock(Thread.currentThread(),new FileLockKey(fileId,pageIndex),lock);
      try {
        OCacheEntry lruEntry=get(fileId,pageIndex);
        if (lruEntry.isDirty) {
          flushData(fileId,lruEntry.pageIndex,lruEntry.dataPointer);
          lruEntry.isDirty=false;
        }
      }
  finally {
        lockManager.releaseLock(Thread.currentThread(),new FileLockKey(fileId,pageIndex),lock);
      }
    }
    files.get(fileId).synch();
  }
}
