{
  checkForRebuild();
  modificationLock.requestModificationLock();
  try {
    acquireExclusiveLock();
    try {
      checkForKeyType(iKey);
      final OIdentifiable value=map.get(iKey);
      if (value != null) {
        if (!value.equals(iSingleValue))         throw new ORecordDuplicatedException("Found duplicated key '" + iKey + "' on unique index '"+ name+ "' for record "+ iSingleValue.getIdentity()+ ". The record already present in the index is "+ value.getIdentity(),value.getIdentity());
 else         return this;
      }
      if (!iSingleValue.getIdentity().isPersistent())       ((ORecord<?>)iSingleValue.getRecord()).save();
      map.put(iKey,iSingleValue.getIdentity());
      return this;
    }
  finally {
      releaseExclusiveLock();
    }
  }
  finally {
    modificationLock.releaseModificationLock();
  }
}
