{
  messageManagementLock.readLock().lock();
  final AtomicBoolean acquiredMessageManagementLock=new AtomicBoolean(true);
  try {
    clusterLocks[iPartition % clusterLocks.length].lock();
    final AtomicBoolean acquiredClusterLock=new AtomicBoolean(true);
    try {
      final Callable<Void> unlockCallback=new Callable<Void>(){
        @Override public Void call() throws Exception {
          if (acquiredClusterLock.compareAndSet(true,false))           clusterLocks[iPartition % clusterLocks.length].unlock();
          if (acquiredMessageManagementLock.compareAndSet(true,false))           messageManagementLock.readLock().unlock();
          return null;
        }
      }
;
      return callback.call(unlockCallback);
    }
  finally {
      if (acquiredClusterLock.compareAndSet(true,false))       clusterLocks[iPartition % clusterLocks.length].unlock();
    }
  }
  finally {
    if (acquiredMessageManagementLock.compareAndSet(true,false))     messageManagementLock.readLock().unlock();
  }
}
